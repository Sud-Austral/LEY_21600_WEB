<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vista de Red - Ley 21.600 (Cytoscape)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Cytoscape.js -->
  <script src="https://cdn.jsdelivr.net/npm/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
  <!-- Layout fcose (requerido) -->
  <script src="https://cdn.jsdelivr.net/npm/cytoscape-fcose@2.4.1/cytoscape-fcose.min.js"></script>
  <!-- Librería para exportar como imagen -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body {margin: 0;padding: 0;font-family: 'Inter', sans-serif;background-color: #0f172a;color: #f1f5f9;overflow: hidden;}
    #graph-container {width: 100%;height: calc(100vh - 180px);background-color: #1e293b;position: relative;}
    #side-panel {position: absolute;top: 1rem;left: 1rem;z-index: 10;background-color: #1e293b;padding: 1rem;border-radius: 0.5rem;box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);width: 30rem;max-height: calc(100vh - 100px);overflow-y: auto;transition: all 0.2s ease;border: 1px solid #334155;color: #f1f5f9;}
    .hidden {display: none !important;}
    .legend-container {position: absolute;bottom: 1rem;right: 1rem;z-index: 10;background-color: rgba(30, 41, 59, 0.9);padding: 0.75rem;border-radius: 0.5rem;box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);border: 1px solid #334155;color: #f1f5f9;max-width: 12rem;}
    .legend-item {display: flex;align-items: center;margin-bottom: 0.5rem;}
    .legend-color {width: 16px;height: 16px;border-radius: 50%;margin-right: 0.5rem;}
    .legend-shape {width: 16px;height: 16px;margin-right: 0.5rem;}
    .circle {border-radius: 50%;}
    .square {border-radius: 2px;}
    .diamond {
      width: 12px;
      height: 12px;
      clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
      margin-right: 0.5rem;
    }
    .stats-item {display: flex;justify-content: space-between;margin-bottom: 0.5rem;}
    .slider-container {margin: 1rem 0;}
    .slider {width: 100%;height: 6px;border-radius: 3px;background: #4b5563;outline: none;-webkit-appearance: none;}
    .slider::-webkit-slider-thumb {-webkit-appearance: none;appearance: none;width: 18px;height: 18px;border-radius: 50%;background: #60a5fa;cursor: pointer;}
    .slider::-moz-range-thumb {width: 18px;height: 18px;border-radius: 50%;background: #60a5fa;cursor: pointer;}
    .search-container {margin: 1rem 0;}
    .search-input {width: 100%;padding: 0.5rem;border: 1px solid #475569;border-radius: 0.375rem;background-color: #334155;color: #f1f5f9;}
    .filter-section {margin-bottom: 1rem;padding-bottom: 1rem;border-bottom: 1px solid #334155;}
    .filter-title {font-weight: bold;margin-bottom: 0.5rem;color: #f1f5f9;}
    .filter-options {display: flex;flex-direction: column;gap: 0.25rem;}
    .filter-option {display: flex;align-items: center;}
    .filter-option input {margin-right: 0.5rem;accent-color: #60a5fa;}
    .control-buttons {display: flex;flex-wrap: wrap;gap: 0.5rem;margin-top: 1rem;}
    .control-button {padding: 0.5rem;background-color: #3b82f6;color: white;border: none;border-radius: 0.375rem;cursor: pointer;font-size: 0.875rem;transition: background-color 0.2s;display: flex;align-items: center;gap: 0.25rem;}
    .control-button:hover {background-color: #2563eb;}
    .control-button.secondary {background-color: #64748b;}
    .control-button.secondary:hover {background-color: #475569;}
    header {background: linear-gradient(135deg, #065f46 0%, #064e3b 100%);position: sticky;top: 0;z-index: 50;}
    #export-png, #export-json, #explanation-btn {background-color: rgba(255, 255, 255, 0.9);color: #065f46;}
    #export-png:hover, #export-json:hover, #explanation-btn:hover {background-color: rgba(255, 255, 255, 1);}
    a[href="newFun20.html"] {background-color: rgba(255, 255, 255, 0.9);color: #065f46;}
    a[href="newFun20.html"]:hover {background-color: rgba(255, 255, 255, 1);}
    .search-bar {background-color: #1e293b;padding: 1rem;border-bottom: 1px solid #334155;position: sticky;top: 4rem;z-index: 40;}
    .filter-chip {display: inline-flex;align-items: center;padding: 0.5rem 0.75rem;margin: 0.25rem;border-radius: 9999px;background-color: #334155;color: #f1f5f9;cursor: pointer;transition: background-color 0.2s;font-size: 0.875rem;}
    .filter-chip.active {background-color: #3b82f6;}
    .filter-chip:hover {background-color: #4b5563;}
    .filter-chip.active:hover {background-color: #2563eb;}
    .filter-chip i {margin-right: 0.5rem;}
    .tab-container {display: flex;border-bottom: 1px solid #334155;margin-bottom: 1rem;}
    .tab {padding: 0.5rem 1rem;cursor: pointer;border-bottom: 2px solid transparent;transition: color 0.2s;}
    .tab.active {border-bottom-color: #3b82f6;color: #60a5fa;}
    .tab-content {display: none;}
    .tab-content.active {display: block;}
    .clear-filters-button {position: absolute;bottom: 1rem;left: 50%;transform: translateX(-50%);z-index: 10;background-color: #ef4444;color: white;border: none;border-radius: 9999px;padding: 0.5rem 1rem;cursor: pointer;font-size: 0.875rem;transition: background-color 0.2s;display: flex;align-items: center;gap: 0.25rem;box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);}
    .clear-filters-button:hover {background-color: #dc2626;}
    .filter-feedback {position: absolute;top: 7rem;left: 50%;transform: translateX(-50%);z-index: 10;background-color: rgba(30, 41, 59, 0.9);padding: 0.5rem 1rem;border-radius: 0.375rem;box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);border: 1px solid #334155;color: #f1f5f9;font-size: 0.875rem;opacity: 0;transition: opacity 0.3s;}
    .filter-feedback.show {opacity: 1;}
    .stats-chart {width: 100%;height: 100px;margin-top: 0.5rem;}
    .dropdown-menu {position: absolute;top: 100%;right: 0;background-color: #1e293b;border: 1px solid #334155;border-radius: 0.5rem;box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);width: 16rem;z-index: 20;display: none;}
    .dropdown-menu.show {display: block;}
    .dropdown-item {padding: 0.5rem 1rem;cursor: pointer;transition: background-color 0.2s;}
    .dropdown-item:hover {background-color: #334155;}
    .dropdown-divider {height: 1px;background-color: #334155;margin: 0.5rem 0;}
    .search-result-item {padding: 0.75rem;border-radius: 0.375rem;margin-bottom: 0.5rem;background-color: #334155;cursor: pointer;transition: background-color 0.2s;}
    .search-result-item:hover {background-color: #4b5563;}
    .search-result-title {font-weight: bold;margin-bottom: 0.25rem;}
    .search-result-excerpt {font-size: 0.875rem;color: #cbd5e1;}
    .no-results {text-align: center;padding: 1rem;color: #94a3b8;}
    .filter-dropdown {position: relative;display: inline-block;margin: 0.25rem;}
    .filter-dropdown-button {display: inline-flex;align-items: center;padding: 0.5rem 0.75rem;border-radius: 0.375rem;background-color: #334155;color: #f1f5f9;cursor: pointer;transition: background-color 0.2s;font-size: 0.875rem;border: 1px solid #475569;}
    .filter-dropdown-button:hover {background-color: #4b5563;}
    .filter-dropdown-button.active {background-color: #3b82f6;}
    .filter-dropdown-button i {margin-right: 0.5rem;}
    .filter-dropdown-content {position: absolute;top: 100%;left: 0;background-color: #1e293b;border: 1px solid #334155;border-radius: 0.5rem;box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);width: 16rem;max-height: 12rem;overflow-y: auto;z-index: 20;display: none;margin-top: 0.25rem;}
    .filter-dropdown-content.show {display: block;}
    .filter-dropdown-item {padding: 0.5rem 0.75rem;cursor: pointer;transition: background-color 0.2s;display: flex;align-items: center;}
    .filter-dropdown-item:hover {background-color: #334155;}
    .filter-dropdown-item input {margin-right: 0.5rem;accent-color: #60a5fa;}
    .filter-dropdown-search {width: 100%;padding: 0.5rem;border: 1px solid #475569;border-radius: 0.375rem;background-color: #334155;color: #f1f5f9;margin-bottom: 0.5rem;}
    .filter-dropdown-footer {padding: 0.5rem;border-top: 1px solid #334155;display: flex;justify-content: space-between;}
    .filter-dropdown-button-small {padding: 0.25rem 0.5rem;font-size: 0.75rem;border-radius: 0.25rem;background-color: #3b82f6;color: white;border: none;cursor: pointer;transition: background-color 0.2s;}
    .filter-dropdown-button-small:hover {background-color: #2563eb;}
    .filter-dropdown-button-small.secondary {background-color: #64748b;}
    .filter-dropdown-button-small.secondary:hover {background-color: #475569;}
    .context-history-item {padding: 0.5rem;border-radius: 0.375rem;margin-bottom: 0.5rem;background-color: #334155;cursor: pointer;transition: background-color 0.2s;font-size: 0.875rem;}
    .context-history-item:hover {background-color: #4b5563;}
    .context-history-item.active {background-color: #3b82f6;}
    .modal-overlay {position: fixed;top: 0;left: 0;right: 0;bottom: 0;background-color: rgba(0, 0, 0, 0.7);display: flex;align-items: center;justify-content: center;z-index: 1000;opacity: 0;visibility: hidden;transition: opacity 0.3s ease, visibility 0.3s ease;}
    .modal-overlay.active {opacity: 1;visibility: visible;}
    .modal-container {background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);border-radius: 16px;width: 90%;max-width: 800px;max-height: 85vh;display: flex;flex-direction: column;box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);border: 1px solid #334155;transform: translateY(20px);transition: transform 0.3s ease;}
    .modal-overlay.active .modal-container {transform: translateY(0);}
    .modal-header {padding: 1.5rem;border-bottom: 1px solid #334155;display: flex;justify-content: space-between;align-items: center;}
    .modal-title {font-size: 1.5rem;font-weight: 700;color: #f1f5f9;display: flex;align-items: center;gap: 0.75rem;}
    .modal-close {background: none;border: none;color: #94a3b8;font-size: 1.5rem;cursor: pointer;transition: color 0.2s;width: 2.5rem;height: 2.5rem;display: flex;align-items: center;justify-content: center;border-radius: 0.5rem;}
    .modal-close:hover {color: #f1f5f9;background-color: rgba(255, 255, 255, 0.1);}
    .modal-body {padding: 1.5rem;overflow-y: auto;flex-grow: 1;color: #e2e8f0;line-height: 1.6;}
    .modal-footer {padding: 1rem 1.5rem;border-top: 1px solid #334155;display: flex;justify-content: flex-end;gap: 0.75rem;}
    .modal-button {padding: 0.5rem 1rem;border-radius: 0.5rem;font-weight: 500;cursor: pointer;transition: all 0.2s;border: none;}
    .modal-button-primary {background-color: #3b82f6;color: white;}
    .modal-button-primary:hover {background-color: #2563eb;}
    .modal-button-secondary {background-color: #334155;color: #f1f5f9;}
    .modal-button-secondary:hover {background-color: #4b5569;}
    .loading-spinner {display: inline-block;width: 20px;height: 20px;border: 3px solid rgba(255, 255, 255, 0.3);border-radius: 50%;border-top-color: #fff;animation: spin 1s ease-in-out infinite;}
    @keyframes spin {to { transform: rotate(360deg); }}
    .explanation-content {white-space: pre-line;}
    .explanation-content h3 {color: #60a5fa;margin-top: 1.5rem;margin-bottom: 0.75rem;font-size: 1.25rem;}
    .explanation-content h3:first-child {margin-top: 0;}
    .explanation-content p {margin-bottom: 1rem;}
    .explanation-content ul {margin-left: 1.5rem;margin-bottom: 1rem;}
    .explanation-content li {margin-bottom: 0.5rem;}
    #custom-tooltip {position: absolute;z-index: 1000;background-color: rgba(30, 41, 59, 0.95);color: #f1f5f9;border: 1px solid #334155;border-radius: 8px;padding: 12px;max-width: 350px;box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);font-size: 14px;line-height: 1.5;display: none;pointer-events: none;}
    #custom-tooltip .tooltip-title {font-weight: bold;margin-bottom: 8px;color: #60a5fa;}
    #custom-tooltip .tooltip-content {margin-bottom: 8px;}
    #custom-tooltip .tooltip-summary {font-size: 13px;color: #e2e8f0;}
    #custom-tooltip ul {margin-left: 1.2rem;margin-top: 0.5rem;}
    #custom-tooltip li {margin-bottom: 0.3rem;}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="text-white shadow-lg">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <h1 class="text-xl sm:text-2xl font-bold flex items-center gap-2">
        <i class="fas fa-project-diagram"></i> Vista de Red - Ley 21.600 (Cytoscape)
      </h1>
      <div class="flex items-center gap-4">
        <button id="explanation-btn" class="px-4 py-2 rounded-lg font-medium transition">
          <i class="fas fa-question-circle"></i> Explicación
        </button>
        <button id="export-png" class="px-4 py-2 rounded-lg font-medium transition">
          <i class="fas fa-image"></i> Exportar PNG
        </button>
        <button id="export-json" class="px-4 py-2 rounded-lg font-medium transition">
          <i class="fas fa-file-code"></i> Exportar JSON
        </button>
        <a href="newFun20.html" class="px-4 py-2 rounded-lg font-medium transition">
          <i class="fas fa-arrow-left"></i> Volver
        </a>
      </div>
    </div>
  </header>
  <!-- Barra de búsqueda y filtros -->
  <div class="search-bar">
    <div class="container mx-auto px-4">
      <div class="flex flex-col md:flex-row gap-4">
        <div class="flex-grow">
          <div class="relative">
            <input type="text" id="search-input" class="search-input w-full pl-10" placeholder="Buscar artículos o entidades...">
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
          </div>
        </div>
        <div class="flex flex-wrap items-center">
          <div class="filter-chip active" data-type="articles">
            <i class="fas fa-file-alt"></i> Artículos
          </div>
          <div class="filter-dropdown" id="institutions-dropdown">
            <button class="filter-dropdown-button" id="institutions-button">
              <i class="fas fa-building"></i> Instituciones
              <i class="fas fa-chevron-down ml-2"></i>
            </button>
            <div class="filter-dropdown-content" id="institutions-content">
              <input type="text" class="filter-dropdown-search" id="institutions-search" placeholder="Buscar instituciones...">
              <div id="institutions-list"></div>
            </div>
          </div>
          <div class="filter-dropdown" id="laws-dropdown">
            <button class="filter-dropdown-button" id="laws-button">
              <i class="fas fa-gavel"></i> Leyes
              <i class="fas fa-chevron-down ml-2"></i>
            </button>
            <div class="filter-dropdown-content" id="laws-content">
              <input type="text" class="filter-dropdown-search" id="laws-search" placeholder="Buscar leyes...">
              <div id="laws-list"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="filter-feedback" class="filter-feedback">
    Mostrando <span id="visible-count">0</span> de <span id="total-count">0</span> nodos
  </div>
  <button id="clear-filters" class="clear-filters-button hidden">
    <i class="fas fa-times"></i> Limpiar filtros
  </button>
  <!-- Contenedor principal -->
  <div class="relative w-full">
    <div id="side-panel">
      <div id="filters-view">
        <h2 class="text-lg font-bold mb-4">Filtros y Estadísticas</h2>
        <div class="tab-container">
          <div class="tab active" data-tab="basic">Básico</div>
          <div class="tab" data-tab="advanced">Avanzado</div>
          <div class="tab" data-tab="context">Contexto</div>
        </div>
        <div id="basic-tab" class="tab-content active">
          <div class="filter-section">
            <div class="filter-title">Estadísticas</div>
            <div class="stats-item">
              <span>Nodos visibles:</span>
              <span id="stats-nodes" class="font-medium">0</span>
            </div>
            <div class="stats-item">
              <span>Conexiones:</span>
              <span id="stats-edges" class="font-medium">0</span>
            </div>
            <div class="stats-item">
              <span>Total nodos:</span>
              <span id="stats-total-nodes" class="font-medium">0</span>
            </div>
            <canvas id="stats-chart" class="stats-chart"></canvas>
          </div>
        </div>
        <div id="advanced-tab" class="tab-content">
          <div class="filter-section">
            <div class="filter-title">Conexiones mínimas</div>
            <div class="slider-container">
              <input type="range" id="min-connections" class="slider" min="0" max="10" value="0">
              <div class="flex justify-between text-sm">
                <span>0</span>
                <span id="min-connections-value" class="font-medium">0</span>
                <span>10+</span>
              </div>
            </div>
          </div>
          <div class="filter-section">
            <div class="filter-title">Búsqueda Semántica</div>
            <div class="search-container">
              <input type="text" id="advanced-search-input" class="search-input" placeholder="Buscar conceptos relacionados...">
            </div>
          </div>
        </div>
        <div id="context-tab" class="tab-content">
          <div class="filter-section">
            <div class="filter-title">Historial de Contexto</div>
            <div id="context-history-list">
              <div class="context-history-item active">
                <i class="fas fa-home mr-2"></i> Vista inicial
              </div>
            </div>
          </div>
          <div class="filter-section">
            <div class="filter-title">Recomendaciones</div>
            <div id="filter-recommendations">
              <div class="search-result-item">
                <div class="search-result-title">Filtrar por instituciones relacionadas</div>
                <div class="search-result-excerpt">Basado en tu búsqueda actual</div>
              </div>
            </div>
          </div>
        </div>
        <div class="control-buttons">
          <button id="reset-filters" class="control-button secondary">
            <i class="fas fa-redo"></i> Resetear filtros
          </button>
        </div>
      </div>
      <div id="search-results-view" class="hidden">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-bold">Resultados de búsqueda</h2>
          <button id="back-to-filters-from-search" class="control-button secondary">
            <i class="fas fa-arrow-left"></i>
          </button>
        </div>
        <div id="search-results-list"></div>
      </div>
      <div id="node-info-view" class="hidden">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-bold">Información del Nodo</h2>
          <button id="back-to-filters" class="control-button secondary">
            <i class="fas fa-arrow-left"></i>
          </button>
        </div>
        <h3 id="node-info-title" class="font-bold text-lg mb-2"></h3>
        <div id="node-info-content" class="text-sm"></div>
      </div>
    </div>
    <div class="legend-container">
      <div class="legend-item">
        <div class="legend-color circle" style="background-color: #3b82f6;"></div>
        <span>Artículos</span>
      </div>
      <div class="legend-item">
        <div class="legend-color square" style="background-color: #eab308;"></div>
        <span>Instituciones</span>
      </div>
      <div class="legend-item">
        <div class="legend-color diamond" style="background-color: #ef4444;"></div>
        <span>Leyes relacionadas</span>
      </div>
    </div>
    <div id="graph-container"></div>
    <div id="custom-tooltip"></div>
  </div>
  <!-- Modal -->
  <div id="explanation-modal" class="modal-overlay">
    <div class="modal-container">
      <div class="modal-header">
        <h2 class="modal-title">
          <i class="fas fa-lightbulb text-yellow-400"></i>
          Explicación de la Ley 21.600
        </h2>
        <button class="modal-close" id="close-modal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div id="explanation-content" class="explanation-content">
          <div class="flex items-center justify-center py-8">
            <div class="loading-spinner"></div>
            <span class="ml-3">Generando explicación...</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-button modal-button-secondary" id="close-modal-btn">Cerrar</button>
        <button class="modal-button modal-button-primary" id="download-explanation">
          <i class="fas fa-download mr-2"></i> Descargar
        </button>
      </div>
    </div>
  </div>

  <!-- Datos externos -->
  <script src="base.js"></script>
  <script src="pass.js"></script>

  <script>
    // === Variables globales ===
    let cy = null;
    let originalGraph = { nodes: [], edges: [] };
    let filteredNodes = [];
    let filteredEdges = [];
    let selectedInstitutions = [];
    let selectedLaws = [];
    let allInstitutions = [];
    let allLaws = [];
    let currentContextInstitutions = [];
    let currentContextLaws = [];
    let contextHistory = [];
    let isSearchActive = false;
    let currentSearchTerm = '';
    let filtersActive = false;
    let searchTimeout = null;
    let currentData = null;

    const institutionKeywords = [
      "UNESCO", "Servicio de Biodiversidad", "SBAP", "Ministerio del Medio Ambiente", 
      "SAG", "Sernapesca", "CONAF", "Ministerio de Agricultura", "Ministerio de Economía",
      "Ministerio de Hacienda", "Ministerio de Bienes Nacionales", "Ministerio de Defensa Nacional",
      "Subsecretaría de Pesca", "Subsecretaría de Turismo", "Subsecretaría para las Fuerzas Armadas",
      "Servicio Nacional de Pesca y Acuicultura", "Corporación Nacional Forestal",
      "Superintendencia del Medio Ambiente", "Tribunal Ambiental", "Corte Suprema",
      "Corte de Apelaciones", "Contraloría General de la República",
      "Consejo de Ministros para la Sustentabilidad", "Comité Científico Asesor",
      "Comité Técnico", "Dirección Regional", "Director Nacional", "Director Regional",
      "Guardaparques", "Fondo Nacional de la Biodiversidad", "Oficina de Autorizaciones Sectoriales",
      "Servicio Agrícola y Ganadero", "Subsecretaría de Pesca y Acuicultura",
      "Ministerio de las Culturas, las Artes y el Patrimonio", "Ministerio de Desarrollo Social y Familia",
      "Ministerio de Ciencia, Tecnología, Conocimiento e Innovación", "Ministerio de Educación",
      "Tesorería General de la República", "Conservador de Bienes Raíces",
      "Corporación Nacional de Desarrollo Indígena", "Comisión de Desarrollo de Isla de Pascua",
      "Organización Internacional del Trabajo", "Unión Internacional para la Conservación de la Naturaleza",
      "UICN", "Convenio sobre la Diversidad Biológica", "Programa del Hombre y la Biósfera",
      "Red Mundial de Reservas de la Biósfera", "Convenio sobre la Conservación de Especies Migratorias",
      "Armada de Chile", "Carabineros de Chile", "Policía de Investigaciones",
      "Asociación de Guías y Scouts de Chile", "Comunidades indígenas", "Pueblo Rapa Nui",
      "Organizaciones Representativas de Pueblos Indígenas"
    ];

    const lawKeywords = [
      "ley N° 19.300", "Ley General de Pesca", "Ley sobre Caza", "Ley de Bosque Nativo",
      "Código del Trabajo", "ley N° 18.575", "ley N° 20.880", "ley N° 19.882",
      "ley N° 18.892", "ley N° 20.256", "ley N° 4.601", "ley N° 20.283", "ley N° 17.288",
      "ley N° 20.417", "ley N° 20.600", "ley N° 19.253", "ley N° 18.834", "decreto ley N° 249",
      "decreto ley N° 1.939", "decreto ley N° 1.263", "Código de Minería",
      "Ley Marco de Autorizaciones Sectoriales", "Ley sobre Pesca Recreativa",
      "Ley sobre Recuperación del Bosque Nativo", "Convenio N° 169", "Sistema de Alta Dirección Pública",
      "Estatuto Administrativo", "Ley de Presupuestos", "Tribunales Ambientales",
      "Superintendencia del Medio Ambiente", "Consejo de Ministros para la Sustentabilidad"
    ];

    const semanticDictionary = {
      "minería": ["extracción", "recursos minerales", "minerales", "yacimientos", "exploración"],
      "biodiversidad": ["especies", "ecosistemas", "fauna", "flora", "hábitat", "conservación"],
      "medio ambiente": ["ecología", "ambiental", "naturaleza", "contaminación", "sostenibilidad"],
      "áreas protegidas": ["reservas", "parques nacionales", "conservación", "patrimonio natural"],
      "pesca": ["recursos pesqueros", "acuicultura", "especies marinas", "captura"],
      "bosque": ["forestal", "árboles", "vegetación", "silvicultura", "deforestación"],
      "agua": ["recursos hídricos", "cuerpos de agua", "ríos", "lagos", "acuíferos"],
      "energía": ["energías renovables", "electricidad", "generación", "recursos energéticos"],
      "residuos": ["basura", "desechos", "reciclaje", "tratamiento", "contaminación"],
      "cambio climático": ["calentamiento global", "emisiones", "gases efecto invernadero", "mitigación"]
    };

    // === Funciones auxiliares ===
    function getShape(group) {
      if (group === 'institution') return 'square';
      if (group === 'law') return 'diamond';
      return 'ellipse';
    }

    function getColor(group, state = 'default') {
      const colors = {
        article: { default: '#3b82f6', hover: '#93c5fd', highlight: '#60a5fa' },
        institution: { default: '#eab308', hover: '#fde047', highlight: '#fbbf24' },
        law: { default: '#ef4444', hover: '#fca5a5', highlight: '#f87171' }
      };
      return colors[group] ? colors[group][state] : '#94a3b8';
    }

    function getNodeSize(connections) {
      return Math.max(20, Math.min(50, 20 + Math.log(connections + 1) * 10));
    }

    function processGraphData() {
      const nodeMap = new Map();
      const edgesSet = new Set();

      data.articulos.forEach(article => {
        const id = `art-${article.id}`;
        const summary = data.articleSummaries?.[article.id];
        nodeMap.set(id, {
          id: id,
          label: `Art. ${article.numero}`,
          group: 'article',
          articleId: article.id,
          title: `Artículo ${article.numero}`,
          description: article.nombre || '',
          content: article.texto_completo || '',
          summary: summary?.summary || '',
          summaryTitle: summary?.title || '',
          connections: 0
        });
      });

      data.articulos.forEach(article => {
        const from = `art-${article.id}`;
        const text = article.texto_completo.toLowerCase();

        // Conexiones entre artículos
        const articleMentionRegex = /artículo\s+(\d+[°º]?)/gi;
        let match;
        while ((match = articleMentionRegex.exec(article.texto_completo)) !== null) {
          const num = match[1].replace(/[°º]/g, '');
          const mentioned = data.articulos.find(a => a.numero === num);
          if (mentioned) {
            const to = `art-${mentioned.id}`;
            edgesSet.add(`${from}|${to}|menciona|0.9`);
            nodeMap.get(from).connections++;
            nodeMap.get(to).connections++;
          }
        }

        // Instituciones
        institutionKeywords.forEach(inst => {
          if (text.includes(inst.toLowerCase())) {
            const id = `inst-${inst.replace(/\s+/g, '-')}`;
            if (!nodeMap.has(id)) {
              nodeMap.set(id, {
                id: id,
                label: inst,
                group: 'institution',
                description: 'Institución mencionada',
                connections: 0
              });
            }
            const mentions = (text.match(new RegExp(inst.toLowerCase(), 'g')) || []).length;
            const strength = Math.min(0.3 + mentions * 0.1, 0.9);
            edgesSet.add(`${from}|${id}|menciona|${strength}`);
            nodeMap.get(from).connections++;
            nodeMap.get(id).connections++;
          }
        });

        // Leyes
        lawKeywords.forEach(law => {
          if (text.includes(law.toLowerCase())) {
            const id = `law-${law.replace(/\s+/g, '-')}`;
            if (!nodeMap.has(id)) {
              nodeMap.set(id, {
                id: id,
                label: law,
                group: 'law',
                description: 'Ley mencionada',
                connections: 0
              });
            }
            const mentions = (text.match(new RegExp(law.toLowerCase(), 'g')) || []).length;
            const strength = Math.min(0.3 + mentions * 0.1, 0.9);
            edgesSet.add(`${from}|${id}|se relaciona|${strength}`);
            nodeMap.get(from).connections++;
            nodeMap.get(id).connections++;
          }
        });
      });

      const nodes = Array.from(nodeMap.values());
      const edges = Array.from(edgesSet).map(str => {
        const [from, to, label, strStr] = str.split('|');
        return { from, to, label, strength: parseFloat(strStr) };
      });

      return { nodes, edges };
    }

    function initializeCytoscape() {
      const container = document.getElementById('graph-container');
      const graph = processGraphData();
      originalGraph = { nodes: [...graph.nodes], edges: [...graph.edges] };
      filteredNodes = [...graph.nodes];
      filteredEdges = [...graph.edges];

      const cyElements = [
        ...filteredNodes.map(n => ({
          data: {
            id: n.id,
            label: n.label,
            group: n.group,
            articleId: n.articleId,
            title: n.title,
            description: n.description,
            content: n.content,
            summary: n.summary,
            summaryTitle: n.summaryTitle,
            connections: n.connections
          }
        })),
        ...filteredEdges.map(e => ({
          data: {
            id: `${e.from}-${e.to}`,
            source: e.from,
            target: e.to,
            label: e.label,
            strength: e.strength
          }
        }))
      ];

      cy = cytoscape({
        container,
        elements: cyElements,
        style: [
          {
            selector: 'node',
            style: {
              'background-color': (n) => getColor(n.data('group')),
              'shape': (n) => getShape(n.data('group')),
              'label': 'data(label)',
              'color': '#ffffff',
              'font-size': (n) => Math.max(12, Math.min(20, 10 + n.data('connections') * 0.8)),
              'text-valign': 'center',
              'text-halign': 'center',
              'width': (n) => getNodeSize(n.data('connections')),
              'height': (n) => getNodeSize(n.data('connections')),
              'border-width': 2,
              'border-color': '#1e293b',
              'text-outline-width': 2,
              'text-outline-color': '#000',
              'overlay-opacity': 0
            }
          },
          {
            selector: 'edge',
            style: {
              'width': (e) => 2 + e.data('strength') * 4,
              'line-color': '#f8fafc',
              'target-arrow-color': '#f8fafc',
              'target-arrow-shape': 'triangle',
              'curve-style': 'bezier',
              'opacity': (e) => 0.4 + e.data('strength') * 0.6,
              'label': 'data(label)',
              'text-background-color': '#000',
              'text-background-opacity': 0.7,
              'text-background-shape': 'roundrectangle',
              'font-size': 10,
              'color': '#fff'
            }
          },
          {
            selector: 'node.highlight',
            style: { 'border-width': 4, 'border-color': '#fff' }
          },
          {
            selector: 'node.dimmed, edge.dimmed',
            style: { 'opacity': 0.2 }
          }
        ],
        layout: {
          name: 'fcose',
          quality: 'proof',
          nodeDimensionsIncludeLabels: true,
          animate: true,
          animationDuration: 1000,
          fit: true,
          padding: 80
        },
        userZoomingEnabled: true,
        userPanningEnabled: true,
        boxSelectionEnabled: false
      });

      cy.on('tap', 'node', function(evt) {
        const node = evt.target;
        showNodeInfo(node.data());
        cy.elements().removeClass('highlight dimmed');
        const neighbors = node.closedNeighborhood();
        cy.elements().difference(neighbors).addClass('dimmed');
        node.addClass('highlight');
      });

      cy.on('mouseover', 'node', function(evt) {
        const node = evt.target;
        if (node.data('group') === 'article' && node.data('summary')) {
          const pos = node.renderedPosition();
          const tooltip = document.getElementById('custom-tooltip');
          tooltip.innerHTML = `
            <div class="tooltip-title">${node.data('summaryTitle') || node.data('label')}</div>
            <div class="tooltip-content">Artículo ${node.data('label').replace('Art. ', '')}</div>
            <div class="tooltip-summary">${node.data('summary')}</div>
          `;
          tooltip.style.left = (pos.x + 20) + 'px';
          tooltip.style.top = (pos.y - 10) + 'px';
          tooltip.style.display = 'block';
        }
      });

      cy.on('mouseout', 'node', function() {
        document.getElementById('custom-tooltip').style.display = 'none';
      });

      cy.on('tap', () => {
        cy.elements().removeClass('highlight dimmed');
      });

      updateStats();

      allInstitutions = [...new Set(filteredNodes.filter(n => n.group === 'institution').map(n => n.label))].sort();
      allLaws = [...new Set(filteredNodes.filter(n => n.group === 'law').map(n => n.label))].sort();
      currentContextInstitutions = [...allInstitutions];
      currentContextLaws = [...allLaws];
      populateFilterDropdowns();
      updateFilterContext();
    }

    function updateGraph() {
      const cyElements = [
        ...filteredNodes.map(n => ({
          data: {
            id: n.id,
            label: n.label,
            group: n.group,
            articleId: n.articleId,
            title: n.title,
            description: n.description,
            content: n.content,
            summary: n.summary,
            summaryTitle: n.summaryTitle,
            connections: n.connections
          }
        })),
        ...filteredEdges.map(e => ({
          data: {
            id: `${e.from}-${e.to}`,
            source: e.from,
            target: e.to,
            label: e.label,
            strength: e.strength
          }
        }))
      ];
      cy.json({ elements: cyElements });
      cy.layout({ name: 'fcose', animate: true, fit: true }).run();
      updateStats();
    }

    function showNodeInfo(nodeData) {
      document.getElementById('filters-view').classList.add('hidden');
      document.getElementById('search-results-view').classList.add('hidden');
      document.getElementById('node-info-view').classList.remove('hidden');
      document.getElementById('node-info-title').textContent = nodeData.label;
      if (nodeData.group === 'article') {
        const article = data.articulos.find(a => a.id == nodeData.articleId);
        const summary = data.articleSummaries?.[article.id];
        document.getElementById('node-info-content').innerHTML = `
          <div class="mb-4">
            <div class="text-2xl font-bold mb-2">Artículo ${article.numero}</div>
            <div class="text-lg text-blue-300 mb-3">${article.nombre || ''}</div>
            ${summary ? `<div class="bg-slate-700/50 p-3 rounded-lg mb-3">
              <div class="font-semibold mb-2">${summary.title}</div>
              <div class="text-sm">${summary.summary}</div>
            </div>` : ''}
            <div class="text-sm whitespace-pre-wrap">${article.texto_completo || ''}</div>
          </div>
        `;
      } else {
        document.getElementById('node-info-content').innerHTML = `
          <div class="mb-4">
            <div class="text-lg font-semibold mb-2">${nodeData.label}</div>
            <p class="text-sm">${nodeData.description || 'Entidad mencionada en la ley.'}</p>
          </div>
        `;
      }
    }

    function backToFilters() {
      document.getElementById('filters-view').classList.remove('hidden');
      document.getElementById('search-results-view').classList.add('hidden');
      document.getElementById('node-info-view').classList.add('hidden');
    }

    function searchInArticles(searchTerm) {
      if (!searchTerm) return [];
      const results = [];
      const term = searchTerm.toLowerCase();
      const expanded = [term];
      for (const [k, v] of Object.entries(semanticDictionary)) {
        if (term.includes(k) || k.includes(term)) expanded.push(...v);
      }
      data.articulos.forEach(a => {
        const t = a.texto_completo.toLowerCase();
        let found = false;
        for (const w of expanded) if (t.includes(w)) { found = true; break; }
        if (found) {
          const idx = t.indexOf(expanded.find(w => t.includes(w)));
          const start = Math.max(0, idx - 50);
          const excerpt = '...' + t.substring(start, Math.min(t.length, start + 120)) + '...';
          results.push({
            id: a.id,
            title: `Artículo ${a.numero}: ${a.nombre || ''}`,
            excerpt
          });
        }
      });
      return results;
    }

    function applyFilters() {
      const showArticles = document.querySelector('.filter-chip[data-type="articles"]').classList.contains('active');
      const minConn = parseInt(document.getElementById('min-connections').value);
      const searchTerm = document.getElementById('search-input').value.trim() ||
                         document.getElementById('advanced-search-input').value.trim();
      isSearchActive = searchTerm.length > 0;

      if (isSearchActive) {
        const results = searchInArticles(searchTerm);
        const articleIds = results.map(r => `art-${r.id}`);
        filteredNodes = originalGraph.nodes.filter(n => {
          if (n.group === 'article' && articleIds.includes(n.id)) return true;
          if (n.group === 'institution' || n.group === 'law') {
            return originalGraph.edges.some(e =>
              (articleIds.includes(e.from) && e.to === n.id) ||
              (articleIds.includes(e.to) && e.from === n.id)
            );
          }
          return false;
        });
        const ids = new Set(filteredNodes.map(n => n.id));
        filteredEdges = originalGraph.edges.filter(e => ids.has(e.from) && ids.has(e.to));
        showSearchResults(searchTerm, results);
      } else {
        backToFilters();
        if (selectedInstitutions.length === 0 && selectedLaws.length === 0) {
          filteredNodes = originalGraph.nodes.filter(n =>
            (n.group !== 'article' || showArticles) && n.connections >= minConn
          );
        } else {
          let articleIdsToShow = [];
          if (selectedInstitutions.length > 0) {
            const ids = [];
            selectedInstitutions.forEach(inst => {
              const instId = `inst-${inst.replace(/\s+/g, '-')}`;
              originalGraph.edges.forEach(e => {
                if (e.to === instId && e.from.startsWith('art-')) ids.push(e.from);
              });
            });
            articleIdsToShow = [...new Set(ids)];
          }
          if (selectedLaws.length > 0) {
            const ids = [];
            selectedLaws.forEach(law => {
              const lawId = `law-${law.replace(/\s+/g, '-')}`;
              originalGraph.edges.forEach(e => {
                if (e.to === lawId && e.from.startsWith('art-')) ids.push(e.from);
              });
            });
            const lawIds = [...new Set(ids)];
            if (articleIdsToShow.length > 0) {
              articleIdsToShow = articleIdsToShow.filter(id => lawIds.includes(id));
            } else {
              articleIdsToShow = lawIds;
            }
          } else if (selectedInstitutions.length === 0 && articleIdsToShow.length === 0) {
            articleIdsToShow = originalGraph.nodes.filter(n => n.group === 'article').map(n => n.id);
          }

          let instToShow = selectedInstitutions.length > 0 ? selectedInstitutions : [...new Set(
            articleIdsToShow.flatMap(id =>
              originalGraph.edges
                .filter(e => e.from === id && e.to.startsWith('inst-'))
                .map(e => {
                  const n = originalGraph.nodes.find(nn => nn.id === e.to);
                  return n ? n.label : null;
                })
                .filter(Boolean)
            )
          )];

          let lawsToShow = selectedLaws.length > 0 ? selectedLaws : [...new Set(
            articleIdsToShow.flatMap(id =>
              originalGraph.edges
                .filter(e => e.from === id && e.to.startsWith('law-'))
                .map(e => {
                  const n = originalGraph.nodes.find(nn => nn.id === e.to);
                  return n ? n.label : null;
                })
                .filter(Boolean)
            )
          )];

          filteredNodes = originalGraph.nodes.filter(n => {
            if (n.group === 'article') {
              return showArticles && n.connections >= minConn && articleIdsToShow.includes(n.id);
            } else if (n.group === 'institution') {
              return instToShow.includes(n.label);
            } else if (n.group === 'law') {
              return lawsToShow.includes(n.label);
            }
            return false;
          });
        }
        const ids = new Set(filteredNodes.map(n => n.id));
        filteredEdges = originalGraph.edges.filter(e => ids.has(e.from) && ids.has(e.to));
      }

      filtersActive = !showArticles || selectedInstitutions.length > 0 || selectedLaws.length > 0 || minConn > 0;
      document.getElementById('clear-filters').classList.toggle('hidden', !(filtersActive || isSearchActive));
      updateFilterFeedback(filteredNodes.length, originalGraph.nodes.length);
      updateGraph();
      saveContextToHistory(isSearchActive ? `Búsqueda: ${searchTerm}` : "Filtros aplicados");
      updateFilterContext();
    }

    function showSearchResults(term, results) {
      document.getElementById('filters-view').classList.add('hidden');
      document.getElementById('search-results-view').classList.remove('hidden');
      const list = document.getElementById('search-results-list');
      if (results.length === 0) {
        list.innerHTML = `<div class="no-results"><i class="fas fa-search text-3xl mb-2"></i><p>No se encontraron resultados para "${term}"</p></div>`;
        return;
      }
      list.innerHTML = '';
      results.forEach(r => {
        const el = document.createElement('div');
        el.className = 'search-result-item';
        el.innerHTML = `<div class="search-result-title">${r.title}</div><div class="search-result-excerpt">${r.excerpt}</div>`;
        el.onclick = () => {
          const nodeId = `art-${r.id}`;
          const nodeData = filteredNodes.find(n => n.id === nodeId);
          if (nodeData) {
            showNodeInfo(nodeData);
            cy.elements().removeClass('highlight dimmed');
            cy.getElementById(nodeId).addClass('highlight');
            cy.center(cy.getElementById(nodeId));
          }
        };
        list.appendChild(el);
      });
    }

    function updateFilterFeedback(visible, total) {
      document.getElementById('visible-count').textContent = visible;
      document.getElementById('total-count').textContent = total;
      const el = document.getElementById('filter-feedback');
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 3000);
    }

    function updateStats() {
      const counts = filteredNodes.reduce((acc, n) => {
        acc[n.group] = (acc[n.group] || 0) + 1;
        return acc;
      }, {});
      document.getElementById('stats-nodes').textContent = filteredNodes.length;
      document.getElementById('stats-edges').textContent = filteredEdges.length;
      document.getElementById('stats-total-nodes').textContent = originalGraph.nodes.length;
      updateStatsChart(counts);
    }

    function updateStatsChart(counts) {
      const canvas = document.getElementById('stats-chart');
      const ctx = canvas.getContext('2d');
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
      const total = (counts.article || 0) + (counts.institution || 0) + (counts.law || 0);
      if (total === 0) return;
      const cx = canvas.width / 2, cy = canvas.height / 2, r = Math.min(cx, cy) - 10;
      let start = 0;
      if (counts.article) {
        const angle = (counts.article / total) * 2 * Math.PI;
        ctx.beginPath(); ctx.moveTo(cx, cy); ctx.arc(cx, cy, r, start, start + angle); ctx.closePath(); ctx.fillStyle = '#3b82f6'; ctx.fill();
        start += angle;
      }
      if (counts.institution) {
        const angle = (counts.institution / total) * 2 * Math.PI;
        ctx.beginPath(); ctx.moveTo(cx, cy); ctx.arc(cx, cy, r, start, start + angle); ctx.closePath(); ctx.fillStyle = '#eab308'; ctx.fill();
        start += angle;
      }
      if (counts.law) {
        const angle = (counts.law / total) * 2 * Math.PI;
        ctx.beginPath(); ctx.moveTo(cx, cy); ctx.arc(cx, cy, r, start, start + angle); ctx.closePath(); ctx.fillStyle = '#ef4444'; ctx.fill();
      }
    }

    function populateFilterDropdowns() {
      const instList = document.getElementById('institutions-list');
      instList.innerHTML = '';
      currentContextInstitutions.forEach(inst => {
        const id = `inst-${inst.replace(/\s+/g, '-')}`;
        const el = document.createElement('div');
        el.className = 'filter-dropdown-item';
        el.innerHTML = `<input type="checkbox" id="${id}" value="${inst}" ${selectedInstitutions.includes(inst) ? 'checked' : ''}><label for="${id}">${inst}</label>`;
        instList.appendChild(el);
        el.querySelector('input').onchange = (e) => {
          if (e.target.checked) {
            if (!selectedInstitutions.includes(e.target.value)) selectedInstitutions.push(e.target.value);
          } else {
            selectedInstitutions = selectedInstitutions.filter(v => v !== e.target.value);
          }
          updateDropdownButtonState('institutions');
          applyFilters();
        };
      });

      const lawList = document.getElementById('laws-list');
      lawList.innerHTML = '';
      currentContextLaws.forEach(law => {
        const id = `law-${law.replace(/\s+/g, '-')}`;
        const el = document.createElement('div');
        el.className = 'filter-dropdown-item';
        el.innerHTML = `<input type="checkbox" id="${id}" value="${law}" ${selectedLaws.includes(law) ? 'checked' : ''}><label for="${id}">${law}</label>`;
        lawList.appendChild(el);
        el.querySelector('input').onchange = (e) => {
          if (e.target.checked) {
            if (!selectedLaws.includes(e.target.value)) selectedLaws.push(e.target.value);
          } else {
            selectedLaws = selectedLaws.filter(v => v !== e.target.value);
          }
          updateDropdownButtonState('laws');
          applyFilters();
        };
      });
    }

    function updateDropdownButtonState(type) {
      const btn = document.getElementById(`${type}-button`);
      const sel = type === 'institutions' ? selectedInstitutions : selectedLaws;
      btn.classList.toggle('active', sel.length > 0);
    }

    function filterDropdownItems(type, term) {
      const items = document.querySelectorAll(`#${type}-list .filter-dropdown-item`);
      items.forEach(i => {
        i.style.display = i.textContent.toLowerCase().includes(term.toLowerCase()) ? 'flex' : 'none';
      });
    }

    function updateFilterContext() {
      if (isSearchActive || (filtersActive && selectedInstitutions.length === 0 && selectedLaws.length === 0)) {
        const visibleArticles = filteredNodes.filter(n => n.group === 'article').map(n => n.id);
        const relInst = [...new Set(
          originalGraph.edges
            .filter(e => visibleArticles.includes(e.from) && e.to.startsWith('inst-'))
            .map(e => {
              const n = originalGraph.nodes.find(nn => nn.id === e.to);
              return n ? n.label : null;
            })
            .filter(Boolean)
        )].sort();
        const relLaw = [...new Set(
          originalGraph.edges
            .filter(e => visibleArticles.includes(e.from) && e.to.startsWith('law-'))
            .map(e => {
              const n = originalGraph.nodes.find(nn => nn.id === e.to);
              return n ? n.label : null;
            })
            .filter(Boolean)
        )].sort();
        currentContextInstitutions = relInst;
        currentContextLaws = relLaw;
      } else if (selectedInstitutions.length === 0 && selectedLaws.length === 0) {
        currentContextInstitutions = [...allInstitutions];
        currentContextLaws = [...allLaws];
      }
      selectedInstitutions = selectedInstitutions.filter(v => currentContextInstitutions.includes(v));
      selectedLaws = selectedLaws.filter(v => currentContextLaws.includes(v));
      populateFilterDropdowns();
      updateDropdownButtonState('institutions');
      updateDropdownButtonState('laws');
      updateFilterRecommendations();
    }

    function updateFilterRecommendations() {
      const rec = document.getElementById('filter-recommendations');
      rec.innerHTML = '';
      if (isSearchActive) {
        const visibleArticles = filteredNodes.filter(n => n.group === 'article').map(n => n.id);
        const relInst = [...new Set(
          originalGraph.edges
            .filter(e => visibleArticles.includes(e.from) && e.to.startsWith('inst-'))
            .map(e => {
              const n = originalGraph.nodes.find(nn => nn.id === e.to);
              return n ? n.label : null;
            })
            .filter(Boolean)
        )];
        const relLaw = [...new Set(
          originalGraph.edges
            .filter(e => visibleArticles.includes(e.from) && e.to.startsWith('law-'))
            .map(e => {
              const n = originalGraph.nodes.find(nn => nn.id === e.to);
              return n ? n.label : null;
            })
            .filter(Boolean)
        )];
        if (relInst.length > 0) {
          const el = document.createElement('div');
          el.className = 'search-result-item';
          el.innerHTML = `<div class="search-result-title">Filtrar por instituciones relacionadas</div><div class="search-result-excerpt">Se encontraron ${relInst.length} instituciones</div>`;
          el.onclick = () => {
            selectedInstitutions = [...relInst];
            document.querySelectorAll('#institutions-list input').forEach(cb => {
              cb.checked = selectedInstitutions.includes(cb.value);
            });
            updateDropdownButtonState('institutions');
            applyFilters();
          };
          rec.appendChild(el);
        }
        if (relLaw.length > 0) {
          const el = document.createElement('div');
          el.className = 'search-result-item';
          el.innerHTML = `<div class="search-result-title">Filtrar por leyes relacionadas</div><div class="search-result-excerpt">Se encontraron ${relLaw.length} leyes</div>`;
          el.onclick = () => {
            selectedLaws = [...relLaw];
            document.querySelectorAll('#laws-list input').forEach(cb => {
              cb.checked = selectedLaws.includes(cb.value);
            });
            updateDropdownButtonState('laws');
            applyFilters();
          };
          rec.appendChild(el);
        }
      }
      if (rec.children.length === 0) {
        rec.innerHTML = `<div class="no-results"><i class="fas fa-lightbulb text-2xl mb-2"></i><p>Realiza una búsqueda o aplica filtros</p></div>`;
      }
    }

    function saveContextToHistory(name) {
      if (contextHistory.length >= 10) contextHistory.shift();
      contextHistory.push({
        nodes: [...filteredNodes],
        edges: [...filteredEdges],
        name,
        timestamp: new Date()
      });
      updateContextHistoryUI();
    }

    function updateContextHistoryUI() {
      const list = document.getElementById('context-history-list');
      list.innerHTML = '';
      contextHistory.forEach((ctx, i) => {
        const el = document.createElement('div');
        el.className = 'context-history-item' + (i === contextHistory.length - 1 ? ' active' : '');
        const time = ctx.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        el.innerHTML = `<i class="fas fa-history mr-2"></i> ${ctx.name} (${time})`;
        el.onclick = () => {
          filteredNodes = [...ctx.nodes];
          filteredEdges = [...ctx.edges];
          updateGraph();
          document.querySelectorAll('.context-history-item').forEach(e => e.classList.remove('active'));
          el.classList.add('active');
        };
        list.appendChild(el);
      });
    }

    function resetFilters() {
      document.querySelectorAll('.filter-chip').forEach(c => c.classList.add('active'));
      document.getElementById('min-connections').value = '0';
      document.getElementById('min-connections-value').textContent = '0';
      document.getElementById('search-input').value = '';
      document.getElementById('advanced-search-input').value = '';
      selectedInstitutions = [];
      selectedLaws = [];
      document.querySelectorAll('#institutions-list input, #laws-list input').forEach(cb => cb.checked = false);
      updateDropdownButtonState('institutions');
      updateDropdownButtonState('laws');
      applyFilters();
    }

    function clearAllFilters() {
      resetFilters();
      document.getElementById('clear-filters').classList.add('hidden');
      backToFilters();
    }

    function exportAsPNG() {
      html2canvas(document.getElementById('graph-container')).then(canvas => {
        const link = document.createElement('a');
        link.download = 'red-ley-21600-cytoscape.png';
        link.href = canvas.toDataURL();
        link.click();
      });
    }

    function exportAsJSON() {
      const json = cy.json();
      const blob = new Blob([JSON.stringify(json, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'red-ley-21600-cytoscape.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function generateExplanationJSON() {
      const visibleArticleNodes = filteredNodes.filter(n => n.group === 'article');
      const articles = visibleArticleNodes.map(n => {
        const article = data.articulos.find(a => a.id == n.articleId);
        if (!article) return null;
        const connections = [];
        filteredEdges.forEach(e => {
          if (e.from === n.id) {
            const target = filteredNodes.find(nn => nn.id === e.to);
            if (target) {
              connections.push({
                type: target.group,
                target: target.label,
                relation: e.label,
                strength: e.strength
              });
            }
          }
        });
        return {
          id: article.id,
          numero: article.numero,
          nombre: article.nombre || '',
          texto_completo: article.texto_completo || '',
          conexiones: connections
        };
      }).filter(Boolean);

      let termino = document.getElementById('search-input').value.trim();
      if (!termino) {
        const sel = [...selectedInstitutions, ...selectedLaws];
        termino = sel.length > 0 ? sel.join(', ') : "Ley 21.600";
      }

      return {
        TERMINO_DE_FILTRO: termino,
        ley: "Ley 21.600",
        descripcion: "Ley que crea el Servicio de Biodiversidad y Áreas Protegidas",
        articulos: articles
      };
    }

    function showExplanationModal() {
      const modal = document.getElementById('explanation-modal');
      modal.classList.add('active');
      const content = document.getElementById('explanation-content');
      content.innerHTML = `<div class="flex items-center justify-center py-8"><div class="loading-spinner"></div><span class="ml-3">Generando explicación...</span></div>`;
      obtenerExplicacionJSON(generateExplanationJSON())
        .then(expl => {
          content.innerHTML = `<div class="explanation-content">${expl}</div>`;
        })
        .catch(err => {
          content.innerHTML = `<div class="bg-red-900/30 border border-red-700 rounded p-4"><h3 class="text-red-300">Error</h3><p>${err.message || 'Error inesperado'}</p></div>`;
        });
    }

    function hideExplanationModal() {
      document.getElementById('explanation-modal').classList.remove('active');
    }

    function downloadExplanation() {
      const text = document.getElementById('explanation-content').innerText;
      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'explicacion-ley-21600.txt';
      a.click();
      URL.revokeObjectURL(url);
    }

    async function initializeApp() {
      try {
        currentData = mockDataResponse;
        data = currentData;
      } catch (e) {
        console.error("Error", e);
        return;
      }
      initializeCytoscape();
      backToFilters();
      applyFilters();

      document.getElementById('explanation-btn').onclick = showExplanationModal;
      document.getElementById('export-png').onclick = exportAsPNG;
      document.getElementById('export-json').onclick = exportAsJSON;
      document.getElementById('reset-filters').onclick = resetFilters;
      document.getElementById('clear-filters').onclick = clearAllFilters;
      document.getElementById('back-to-filters').onclick = backToFilters;
      document.getElementById('back-to-filters-from-search').onclick = () => {
        document.getElementById('search-input').value = '';
        document.getElementById('advanced-search-input').value = '';
        backToFilters();
        applyFilters();
      };

      document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.onclick = () => {
          chip.classList.toggle('active');
          applyFilters();
        };
      });

      document.getElementById('search-input').oninput = (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => applyFilters(), 300);
      };
      document.getElementById('advanced-search-input').oninput = (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => applyFilters(), 300);
      };

      document.getElementById('min-connections').oninput = (e) => {
        document.getElementById('min-connections-value').textContent = e.target.value;
        applyFilters();
      };

      document.querySelectorAll('.tab').forEach(tab => {
        tab.onclick = () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
        };
      });

      document.getElementById('institutions-button').onclick = (e) => {
        e.stopPropagation();
        document.getElementById('institutions-content').classList.toggle('show');
        document.getElementById('laws-content').classList.remove('show');
      };
      document.getElementById('laws-button').onclick = (e) => {
        e.stopPropagation();
        document.getElementById('laws-content').classList.toggle('show');
        document.getElementById('institutions-content').classList.remove('show');
      };

      document.getElementById('institutions-search').oninput = (e) => {
        e.stopPropagation();
        filterDropdownItems('institutions', e.target.value);
      };
      document.getElementById('laws-search').oninput = (e) => {
        e.stopPropagation();
        filterDropdownItems('laws', e.target.value);
      };

      document.onclick = (e) => {
        if (!document.getElementById('institutions-dropdown').contains(e.target))
          document.getElementById('institutions-content').classList.remove('show');
        if (!document.getElementById('laws-dropdown').contains(e.target))
          document.getElementById('laws-content').classList.remove('show');
      };

      document.getElementById('close-modal').onclick = hideExplanationModal;
      document.getElementById('close-modal-btn').onclick = hideExplanationModal;
      document.getElementById('download-explanation').onclick = downloadExplanation;
      document.getElementById('explanation-modal').onclick = (e) => {
        if (e.target === e.currentTarget) hideExplanationModal();
      };
    }

    // Registrar el layout fcose después de que todos los scripts se hayan cargado
    document.addEventListener('DOMContentLoaded', function() {
      // Verificar que fcose esté disponible antes de registrarlo
      if (typeof cytoscape !== 'undefined' && typeof fcose !== 'undefined') {
        cytoscape.use(fcose);
      }
      
      // Inicializar la aplicación
      initializeApp();
    });
  </script>
</body>
</html>