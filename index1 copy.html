<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ley 21.600 - Biodiversidad y Áreas Protegidas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <!-- Librerías para la visualización de red -->
  <link href="https://unpkg.com/vis-network@latest/styles/dist/vis-network.min.css" rel="stylesheet" type="text/css" />
  <script src="https://unpkg.com/vis-network@latest/standalone/umd/vis-network.min.js"></script>

  <style>
    .highlight { background-color: #fef3c7; padding: 0.1rem 0.2rem; border-radius: 0.25rem; }
    .dark .highlight { background-color: #451a03; }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .has-note { border-left: 4px solid #f59e0b; }
    .filter-group { margin-bottom: 1rem; }
    .filter-group-title { font-weight: 600; font-size: 0.85rem; color: #4b5563; dark:color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
    #graph-container { width: 100%; height: 100%; background-color: #f9fafb; dark:bg-color: #111827; }
    /* NUEVO: Estilo para las etiquetas clicables */
    .filter-by-tag { cursor: pointer; transition: all 0.2s ease-in-out; border: 1px solid transparent; }
    .filter-by-tag:hover { transform: scale(1.05); opacity: 0.8; }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 transition-colors duration-300">

  <!-- Header -->
  <header class="bg-emerald-700 dark:bg-emerald-800 text-white shadow-lg sticky top-0 z-40">
    <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
      <h1 class="text-xl sm:text-2xl font-bold flex items-center gap-2">
        <i class="fas fa-leaf"></i> Ley 21.600
      </h1>
      <div class="flex items-center gap-4 mt-2 sm:mt-0">
        <button id="theme-toggle" class="p-2 rounded-lg hover:bg-emerald-600 transition" aria-label="Cambiar tema">
          <i class="fas fa-moon"></i>
        </button>
        <button id="graph-view-btn" class="p-2 rounded-lg hover:bg-emerald-600 transition" aria-label="Vista de Red">
          <i class="fas fa-project-diagram"></i>
        </button>
        <button id="export-pdf" class="px-4 py-2 bg-white text-emerald-700 rounded-lg font-medium hover:bg-gray-100 transition hidden">
          <i class="fas fa-file-pdf"></i> PDF
        </button>
      </div>
    </div>
  </header>

  <!-- Main Container -->
  <div class="container mx-auto px-4 py-6 flex flex-col lg:flex-row gap-6">
    <!-- Sidebar: Filtros y Navegación -->
    <aside class="lg:w-80 bg-white dark:bg-gray-800 rounded-xl shadow-md p-5 space-y-6 h-fit sticky top-24">
      <!-- Búsqueda -->
      <div>
        <label class="block text-sm font-semibold mb-2">Buscar en la ley</label>
        <div class="relative">
          <input type="text" id="search-input" placeholder="Ej: humedal, biodiversidad..." 
                 class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-emerald-500 dark:bg-gray-700">
          <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
        </div>
      </div>
      <!-- Tabla de Contenidos -->
      <div>
        <h3 class="font-semibold mb-3">Tabla de Contenidos</h3>
        <nav id="table-of-contents" class="space-y-1 text-sm max-h-64 overflow-y-auto pr-2"></nav>
      </div>
      <!-- Filtros por Categoría Agrupados -->
      <div>
        <h3 class="font-semibold mb-3">Filtrar por categoría</h3>
        <div id="filters" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
      </div>
      <!-- Definiciones Rápidas -->
      <div>
        <h3 class="font-semibold mb-3">Definiciones clave (Art. 3)</h3>
        <select id="quick-definitions" class="w-full p-2 border rounded-lg dark:bg-gray-700">
          <option value="">Seleccionar término...</option>
        </select>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 space-y-6">
      <div id="results-count" class="text-sm text-gray-600 dark:text-gray-400" aria-live="polite"></div>
      <div id="articles-container" class="space-y-6"></div>
      <div id="no-results" class="hidden text-center py-12 text-gray-500">
        <i class="fas fa-search text-4xl mb-4"></i>
        <p>No se encontraron resultados.</p>
      </div>
    </main>
  </div>

  <!-- Modal para Modo Focus y Anotaciones -->
  <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div id="modal-content" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto"></div>
  </div>

  <!-- Modal para la Vista de Red -->
  <div id="graph-modal-overlay" class="fixed inset-0 bg-black z-50 hidden">
    <div class="relative w-full h-full">
      <button id="close-graph-btn" class="absolute top-4 right-4 z-10 text-white bg-black bg-opacity-50 rounded-full p-3 hover:bg-opacity-75 transition">
        <i class="fas fa-times text-xl"></i>
      </button>
      <div id="graph-info-panel" class="absolute top-4 left-4 z-10 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-lg max-w-xs hidden">
        <h3 id="graph-info-title" class="font-bold text-lg mb-2"></h3>
        <p id="graph-info-content" class="text-sm text-gray-600 dark:text-gray-300"></p>
      </div>
      <div id="graph-container"></div>
    </div>
  </div>
  <script src="base.js"></script>

  <!-- Scripts -->
  <script>
    // =================================================================
    // 1. DATOS (Simulados)
    // =================================================================
    const mockDataResponse = { /* ... (Mismo objeto de datos de la versión anterior) ... */
      titulos: [
        { id: 1, numero: "I", nombre: "DISPOSICIONES GENERALES", orden: 1 },
        { id: 2, numero: "II", nombre: "DEL SERVICIO DE BIODIVERSIDAD Y ÁREAS PROTEGIDAS", orden: 2 },
        { id: 3, numero: "III", nombre: "INSTRUMENTOS DE CONSERVACIÓN DE LA BIODIVERSIDAD", orden: 3 },
        { id: 99, numero: "TRANSITORIAS", nombre: "DISPOSICIONES TRANSITORIAS", orden: 99 }
      ],
      parrafos: [
        { id: 1, titulo_id: 1, numero: "", nombre: "Disposiciones Generales", orden: 1 },
        { id: 2, titulo_id: 2, numero: "1°", nombre: "Normas generales", orden: 1 },
        { id: 3, titulo_id: 2, numero: "2°", nombre: "De la organización del Servicio", orden: 2 },
        { id: 4, titulo_id: 3, numero: "1°", nombre: "Disposiciones generales", orden: 1 }
      ],
      articulos: [
        { id: 1, parrafo_id: 1, numero: "1°", nombre: "Objeto", tipo_articulo: "permanente", orden: 1, texto_completo: "La presente ley tiene por objeto la conservación de la diversidad biológica y la protección del patrimonio natural del país, a través de la preservación, restauración y uso sustentable de genes, especies y ecosistemas. No se incluyen dentro del objeto la sanidad vegetal y animal ni la prevención y combate de incendios forestales, materias que se rigen por las respectivas normas legales." },
        { id: 2, parrafo_id: 1, numero: "2°", nombre: "Principios", tipo_articulo: "permanente", orden: 2, texto_completo: "Las políticas, planes, programas, normas, acciones y actos administrativos que se dicten o ejecuten, en el marco de la presente ley, para la protección y conservación de la biodiversidad, se regirán por los siguientes principios: a) Principio de coordinación... b) Principio de jerarquía... c) Principio de no regresión... d) Principio participatorio... e) Principio de precaución... f) Principio de prevención... g) Principio de responsabilidad... h) Principio de sustentabilidad... i) Principio de información... j) Principio de valoración de los servicios ecosistémicos..." },
        { id: 3, parrafo_id: 1, numero: "3°", nombre: "Definiciones", tipo_articulo: "permanente", orden: 3, texto_completo: "Para los efectos de esta ley, se entenderá por: 1) Área degradada... 5) Biodiversidad... 18) Humedal... 33) Zona de amortiguación..." },
        { id: 4, parrafo_id: 2, numero: "4°", nombre: "Servicio de Biodiversidad y Áreas Protegidas", tipo_articulo: "permanente", orden: 1, texto_completo: "Créase el Servicio de Biodiversidad y Áreas Protegidas, cuyo objeto será la conservación de la biodiversidad del país, a través de la gestión para la preservación, restauración y uso sustentable de genes, especies y ecosistemas. El Servicio será funcionalmente descentralizado, contará con personalidad jurídica y patrimonio propio, y estará sujeto a la supervigilancia del Presidente de la República a través del Ministerio del Medio Ambiente." },
        { id: 5, parrafo_id: 2, numero: "5°", nombre: "Funciones y Atribuciones", tipo_articulo: "permanente", orden: 2, texto_completo: "Serán funciones y atribuciones del Servicio: a) Ejecutar las políticas, planes y programas dictados en conformidad a la letra i) del artículo 70 de la ley N° 19.300. b) Gestionar el Sistema Nacional de Áreas Protegidas... c) Promover... programas de investigación... d) Promover... redes de monitoreo... e) Elaborar... planes de recuperación... fiscalizar el cumplimiento... Proteger y promover la conservación de los polinizadores nativos. f) Apoyar técnicamente... g) Proponer al SAG criterios... h) Promover... acciones de educación... i) Pronunciarse sobre los impactos... j) Administrar el Fondo Nacional de la Biodiversidad. k) Otorgar certificados... l) Aplicar y fiscalizar normas sobre protección de fauna... m) Fiscalizar la aplicación de la Ley General de Pesca... ñ) Autorizar la caza... o) Fiscalizar el cumplimiento de la Ley de Bosque Nativo... p) Realizar publicaciones... q) Celebrar convenios... r) Integrar personas jurídicas... s) Proponer mejoras a la regulación... t) Registrar profesionales... u) Las demás que establezcan las leyes." },
        { id: 6, parrafo_id: 4, numero: "23°", nombre: "Instrumentos de conservación", tipo_articulo: "permanente", orden: 1, texto_completo: "A fin de cumplir con su objeto, tanto dentro como fuera de las áreas protegidas, el Servicio estará facultado para diseñar, implementar y dar seguimiento a la aplicación de los instrumentos de conservación de la biodiversidad que señala este Título. El Servicio acogerá todos los instrumentos de conservación de la biodiversidad, incluido el Sistema Nacional de Áreas Protegidas, bajo un enfoque ecosistémico en el territorio nacional." },
        { id: 7, parrafo_id: 2, numero: "9°", nombre: "Comité Científico Asesor", tipo_articulo: "permanente", orden: 3, texto_completo: "Créase un Comité Científico como un organismo asesor y de consulta en las materias científicas y técnicas necesarias para el adecuado ejercicio de las funciones y atribuciones del Servicio. El Comité tendrá carácter paritario y estará integrado por nueve miembros..." },
        { id: 8, parrafo_id: 2, numero: "10°", nombre: "Patrimonio del Servicio", tipo_articulo: "permanente", orden: 4, texto_completo: "El patrimonio del Servicio estará formado por: a) Los recursos que se le asignan anualmente en la Ley de Presupuestos... b) Los bienes... c) Las donaciones... d) Los aportes de cooperación internacional... e) Los ingresos propios... f) El producto de la venta de bienes..." },
        { id: 9, parrafo_id: 1, numero: "4°", nombre: "Principio de Responsabilidad", tipo_articulo: "permanente", orden: 4, texto_completo: "Principio de responsabilidad: quien cause daño a la biodiversidad o a uno o más de sus componentes será responsable del mismo en conformidad a la ley." },
        { id: 10, parrafo_id: 99, numero: "Primero", nombre: "Traspaso de funcionarios", tipo_articulo: "transitorio", orden: 1, texto_completo: "El personal que a la fecha de entrada en vigencia de la presente ley se desempeñe en la Corporación Nacional Forestal... será traspasado al Servicio..." }
      ],
      categorias: [
        { id: 1, nombre: "Procedimientos Administrativos", tipo: "procedimiento", color: "#3b82f6", grupo: "Acción y Procedimiento" },
        { id: 2, nombre: "Permisos y Autorizaciones", tipo: "procedimiento", color: "#06b6d4", grupo: "Acción y Procedimiento" },
        { id: 3, nombre: "Fiscalización y Sanciones", tipo: "procedimiento", color: "#ef4444", grupo: "Acción y Procedimiento" },
        { id: 4, nombre: "Participación Ciudadana", tipo: "procedimiento", color: "#8b5cf6", grupo: "Acción y Procedimiento" },
        { id: 5, nombre: "Servicio de Biodiversidad (SBAP)", tipo: "actor", color: "#10b981", grupo: "Actores e Instituciones" },
        { id: 6, nombre: "Ministerio del Medio Ambiente", tipo: "actor", color: "#f59e0b", grupo: "Actores e Instituciones" },
        { id: 7, nombre: "SAG", tipo: "actor", color: "#84cc16", grupo: "Actores e Instituciones" },
        { id: 8, nombre: "Comités y Consejos Asesores", tipo: "actor", color: "#f97316", grupo: "Actores e Instituciones" },
        { id: 9, nombre: "Instrumentos de Ordenamiento Territorial", tipo: "conceptual", color: "#6366f1", grupo: "Conceptual y Espacial" },
        { id: 10, nombre: "Relación con Otras Normas", tipo: "conceptual", color: "#ec4899", grupo: "Conceptual y Espacial" },
        { id: 11, nombre: "Financiamiento y Fondos", tipo: "economico", color: "#14b8a6", grupo: "Económico y Social" },
        { id: 12, nombre: "Valoración de Servicios Ecosistémicos", tipo: "economico", color: "#a855f7", grupo: "Económico y Social" },
        { id: 13, nombre: "Responsabilidad y Reparación", tipo: "economico", color: "#f43f5e", grupo: "Económico y Social" },
        { id: 14, nombre: "Disposiciones Transitorias", tipo: "estructural", color: "#64748b", grupo: "Estructural" },
        { id: 15, nombre: "Exenciones y Exclusiones", tipo: "estructural", color: "#78716c", grupo: "Estructural" },
        { id: 16, nombre: "Definiciones", tipo: "funcional", color: "#0ea5e9", grupo: "Funcional" }
      ],
      articulos_categorias: [
        { articulo_id: 1, categoria_id: 15 }, { articulo_id: 2, categoria_id: 4 }, { articulo_id: 2, categoria_id: 12 }, { articulo_id: 2, categoria_id: 13 },
        { articulo_id: 3, categoria_id: 16 }, { articulo_id: 4, categoria_id: 5 }, { articulo_id: 4, categoria_id: 6 }, { articulo_id: 5, categoria_id: 2 },
        { articulo_id: 5, categoria_id: 3 }, { articulo_id: 5, categoria_id: 4 }, { articulo_id: 5, categoria_id: 7 }, { articulo_id: 5, categoria_id: 10 },
        { articulo_id: 5, categoria_id: 11 }, { articulo_id: 6, categoria_id: 9 }, { articulo_id: 7, categoria_id: 8 }, { articulo_id: 8, categoria_id: 11 },
        { articulo_id: 9, categoria_id: 13 }, { articulo_id: 10, categoria_id: 14 }
      ],
      definiciones: [
        { id: 1, articulo_id: 3, numero: "1)", termino: "Área degradada", definicion: "ecosistema o parte de él cuyos elementos..." },
        { id: 2, articulo_id: 3, numero: "5)", termino: "Biodiversidad", definicion: "la variedad de los organismos vivos..." },
        { id: 3, articulo_id: 3, numero: "18)", termino: "Humedal", definicion: "extensiones de marismas, pantanos y turberas..." }
      ]
    };

    // =================================================================
    // 2. ESTADO GLOBAL Y MANEJO DE DATOS
    // =================================================================
    let data;
    let filteredArticles = [];
    let selectedCategories = new Set();
    let currentSearch = "";
    let network = null;

    async function loadData() {
      try { data = mockDataResponse; filteredArticles = [...data.articulos]; return true; }
      catch (error) { console.error("Error al cargar los datos:", error); return false; }
    }

    // =================================================================
    // 3. FUNCIONES DE RENDERIZADO DE UI
    // =================================================================
    function renderFilters() {
      const filtersContainer = document.getElementById("filters"); filtersContainer.innerHTML = '';
      const groupedCategories = data.categorias.reduce((acc, cat) => { if (!acc[cat.grupo]) { acc[cat.grupo] = []; } acc[cat.grupo].push(cat); return acc; }, {});
      for (const groupName in groupedCategories) {
        const groupDiv = document.createElement('div'); groupDiv.className = 'filter-group';
        const titleDiv = document.createElement('div'); titleDiv.className = 'filter-group-title'; titleDiv.textContent = groupName; groupDiv.appendChild(titleDiv);
        groupedCategories[groupName].forEach(cat => {
          const label = document.createElement("label"); label.className = "flex items-center gap-2 cursor-pointer text-sm ml-2";
          label.innerHTML = `<input type="checkbox" value="${cat.id}" class="rounded text-emerald-600 focus:ring-emerald-500"><span class="px-2 py-1 rounded-full text-xs font-medium" style="background-color: ${cat.color}20; color: ${cat.color}">${cat.nombre}</span>`;
          label.querySelector("input").addEventListener("change", (e) => { if (e.target.checked) selectedCategories.add(cat.id); else selectedCategories.delete(cat.id); filterArticles(); });
          groupDiv.appendChild(label);
        });
        filtersContainer.appendChild(groupDiv);
      }
    }
    function renderQuickDefinitions() {
      const quickDefs = document.getElementById("quick-definitions"); data.definiciones.forEach(def => { const opt = document.createElement("option"); opt.value = def.id; opt.textContent = `${def.termino} (${def.numero})`; quickDefs.appendChild(opt); });
      quickDefs.addEventListener("change", (e) => { const def = data.definiciones.find(d => d.id == e.target.value); if (def) { searchInput.value = def.termino; handleSearch(); quickDefs.value = ""; } });
    }
    function renderTableOfContents() {
      const tocContainer = document.getElementById('table-of-contents'); tocContainer.innerHTML = '';
      const titulosMap = new Map(data.titulos.map(t => [t.id, { ...t, parrafos: [] }])); data.parrafos.forEach(p => { if (titulosMap.has(p.titulo_id)) { titulosMap.get(p.titulo_id).parrafos.push({ ...p, articulos: data.articulos.filter(a => a.parrafo_id === p.id) }); } });
      titulosMap.forEach(titulo => {
        const titleEl = document.createElement('div');
        titleEl.innerHTML = `<button class="w-full text-left font-semibold p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition" data-target="titulo-${titulo.id}"><i class="fas fa-chevron-right mr-2 toc-icon text-xs"></i> Título ${titulo.numero}: ${titulo.nombre}</button><div id="titulo-${titulo.id}" class="hidden pl-4 space-y-1">${titulo.parrafos.map(parrafo => `<div><button class="w-full text-left p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-xs" data-target="parrafo-${parrafo.id}">${parrafo.numero} ${parrafo.nombre}</button><div id="parrafo-${parrafo.id}" class="hidden pl-4 space-y-1">${parrafo.articulos.map(art => `<a href="#articulo-${art.id}" class="block p-1 hover:bg-emerald-100 dark:hover:bg-emerald-900 rounded text-xs text-gray-600 dark:text-gray-400">Artículo ${art.numero}</a>`).join('')}</div></div>`).join('')}</div>`;
        tocContainer.appendChild(titleEl);
      });
      tocContainer.addEventListener('click', (e) => { const button = e.target.closest('button[data-target]'); if (button) { const targetId = button.dataset.target; const target = document.getElementById(targetId); const icon = button.querySelector('.toc-icon'); target.classList.toggle('hidden'); icon.classList.toggle('fa-chevron-right'); icon.classList.toggle('fa-chevron-down'); } });
    }
    function linkifyCrossReferences(text) {
      const internalLinkRegex = /artículo\s+(\d+[°º]?)/gi; return text.replace(internalLinkRegex, (match, p1) => { const artNum = p1.replace('°', '').replace('º', ''); const article = data.articulos.find(a => a.numero === artNum); if (article) { return `<a href="#articulo-${article.id}" class="text-emerald-600 hover:underline font-semibold">${match}</a>`; } return match; });
    }
    function renderArticles() {
      const articlesContainer = document.getElementById("articles-container"); const resultsCount = document.getElementById("results-count"); const noResults = document.getElementById("no-results"); const exportBtn = document.getElementById("export-pdf");
      articlesContainer.innerHTML = ""; resultsCount.textContent = `${filteredArticles.length} artículo${filteredArticles.length !== 1 ? 's' : ''} encontrado${filteredArticles.length !== 1 ? 's' : ''}`;
      if (filteredArticles.length === 0) { noResults.classList.remove("hidden"); exportBtn.classList.add("hidden"); return; }
      noResults.classList.add("hidden"); exportBtn.classList.remove("hidden");
      filteredArticles.forEach(art => {
        const articleEl = document.createElement("article"); articleEl.className = "bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 fade-in relative"; articleEl.id = `articulo-${art.id}`;
        const note = getNote(art.id); if (note) articleEl.classList.add('has-note');
        
        // NUEVO: Las etiquetas ahora son botones clicables
        const cats = data.articulos_categorias.filter(ac => ac.articulo_id === art.id).map(ac => data.categorias.find(c => c.id === ac.categoria_id)).map(c => `<button class="filter-by-tag inline-block px-2 py-1 text-xs rounded-full mr-2 mb-1 font-medium" data-category-id="${c.id}" style="background-color: ${c.color}20; color: ${c.color}" title="Filtrar por esta categoría">${c.nombre}</button>`).join("");

        let processedText = linkifyCrossReferences(art.texto_completo); if (currentSearch) { const regex = new RegExp(`(${currentSearch})`, "gi"); processedText = processedText.replace(regex, '<span class="highlight">$1</span>'); }
        articleEl.innerHTML = `<div class="flex justify-between items-start mb-3"><h2 class="text-xl font-bold text-emerald-700 dark:text-emerald-400">Artículo ${art.numero}</h2><div class="flex gap-2"><button class="text-gray-500 hover:text-emerald-600 focus-mode" data-id="${art.id}" aria-label="Modo de lectura"><i class="fas fa-expand"></i></button><button class="text-gray-500 hover:text-emerald-600 add-note" data-id="${art.id}" aria-label="Añadir nota"><i class="fas fa-sticky-note ${note ? 'text-amber-500' : ''}"></i></button><button class="text-gray-500 hover:text-emerald-600 export-article" data-id="${art.id}" aria-label="Exportar artículo"><i class="fas fa-download"></i></button></div></div>${art.nombre ? `<h3 class="text-lg font-semibold mb-2">${art.nombre}</h3>` : ""}<div class="flex flex-wrap gap-1 mb-3">${cats}</div><p class="leading-relaxed text-gray-700 dark:text-gray-300 whitespace-pre-wrap">${processedText}</p>`;
        articlesContainer.appendChild(articleEl);
      });
    }

    // =================================================================
    // 4. MANEJO DE EVENTOS Y LÓGICA DE FILTRADO
    // =================================================================
    function setupEvents() {
      const searchInput = document.getElementById("search-input"); const themeBtn = document.getElementById("theme-toggle"); const exportBtn = document.getElementById("export-pdf"); const articlesContainer = document.getElementById("articles-container");
      const graphViewBtn = document.getElementById("graph-view-btn");
      searchInput.addEventListener("input", debounce(handleSearch, 300)); themeBtn.addEventListener("click", toggleTheme); exportBtn.addEventListener("click", exportCurrentToPDF);
      graphViewBtn.addEventListener("click", openGraphView);

      articlesContainer.addEventListener("click", (e) => {
        const target = e.target.closest('button'); if (!target) return; const artId = target.dataset.id; const article = data.articulos.find(a => a.id == artId);
        if (target.classList.contains('export-article')) { exportArticleToPDF(article, document.getElementById(`articulo-${artId}`)); }
        else if (target.classList.contains('focus-mode')) { openFocusMode(article); }
        else if (target.classList.contains('add-note')) { openNoteMode(article); }
        // NUEVO: Listener para clics en etiquetas
        else if (target.classList.contains('filter-by-tag')) {
          const categoryId = target.dataset.categoryId;
          applySingleFilter(categoryId);
        }
      });
      const modalOverlay = document.getElementById('modal-overlay'); modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeModal(); });
      const graphModalOverlay = document.getElementById('graph-modal-overlay');
      document.getElementById('close-graph-btn').addEventListener('click', closeGraphView);
      graphModalOverlay.addEventListener('click', (e) => { if (e.target === graphModalOverlay) closeGraphView(); });
    }
    function handleSearch() { currentSearch = searchInput.value.toLowerCase(); filterArticles(); }
    function filterArticles() {
      let results = data.articulos;
      if (selectedCategories.size > 0) { results = results.filter(art => data.articulos_categorias.some(ac => ac.articulo_id === art.id && selectedCategories.has(ac.categoria_id))); }
      if (currentSearch) { results = results.filter(art => art.texto_completo.toLowerCase().includes(currentSearch) || art.numero.toLowerCase().includes(currentSearch) || (art.nombre && art.nombre.toLowerCase().includes(currentSearch))); }
      filteredArticles = results; renderArticles();
    }

    // =================================================================
    // 5. NUEVO: Lógica para aplicar un filtro único desde una etiqueta
    // =================================================================
    function applySingleFilter(categoryId) {
      // Limpiar otros filtros y búsqueda
      selectedCategories.clear();
      currentSearch = "";
      searchInput.value = "";

      // Aplicar el nuevo filtro
      selectedCategories.add(parseInt(categoryId, 10));

      // Sincronizar UI y filtrar
      updateFilterCheckboxes();
      filterArticles();

      // Scroll hacia arriba para ver los resultados
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function updateFilterCheckboxes() {
      const checkboxes = document.querySelectorAll('#filters input[type="checkbox"]');
      checkboxes.forEach(cb => {
        cb.checked = selectedCategories.has(parseInt(cb.value, 10));
      });
    }

    // =================================================================
    // 6. FUNCIONALIDADES NUEVAS (Modo Focus, Anotaciones, Permalinks)
    // =================================================================
    function openFocusMode(article) {
      const modalContent = document.getElementById('modal-content'); modalContent.innerHTML = `<div class="p-6"><div class="flex justify-between items-center mb-4"><h1 class="text-3xl font-bold">Artículo ${article.numero}</h1><button onclick="closeModal()" class="text-gray-500 hover:text-black dark:hover:text-white text-2xl" aria-label="Cerrar modal">&times;</button></div>${article.nombre ? `<h2 class="text-xl font-semibold mb-4">${article.nombre}</h2>` : ""}<p class="leading-relaxed text-gray-700 dark:text-gray-300 whitespace-pre-wrap">${linkifyCrossReferences(article.texto_completo)}</p></div>`; document.getElementById('modal-overlay').classList.remove('hidden');
    }
    function openNoteMode(article) {
      const modalContent = document.getElementById('modal-content'); const currentNote = getNote(article.id); modalContent.innerHTML = `<div class="p-6"><div class="flex justify-between items-center mb-4"><h1 class="text-2xl font-bold">Anotación: Artículo ${article.numero}</h1><button onclick="closeModal()" class="text-gray-500 hover:text-black dark:hover:text-white text-2xl" aria-label="Cerrar modal">&times;</button></div><textarea id="note-textarea" class="w-full h-64 p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600" placeholder="Escribe tu nota aquí...">${currentNote}</textarea><div class="flex justify-end gap-2 mt-4"><button onclick="closeModal()" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded-lg">Cancelar</button><button onclick="saveNoteFromModal(${article.id})" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">Guardar Nota</button></div></div>`; document.getElementById('modal-overlay').classList.remove('hidden');
    }
    function saveNoteFromModal(articleId) { const noteText = document.getElementById('note-textarea').value; saveNote(articleId, noteText); closeModal(); renderArticles(); }
    function saveNote(articleId, noteText) { const notes = JSON.parse(localStorage.getItem('ley21600-notas') || '{}'); if (noteText.trim()) { notes[articleId] = noteText; } else { delete notes[articleId]; } localStorage.setItem('ley21600-notas', JSON.stringify(notes)); }
    function getNote(articleId) { const notes = JSON.parse(localStorage.getItem('ley21600-notas') || '{}'); return notes[articleId] || ''; }
    function closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); document.getElementById('modal-content').innerHTML = ''; }
    function handleHashNavigation() {
      const articleId = window.location.hash.substring(1); if (articleId.startsWith('articulo-')) { const targetElement = document.getElementById(articleId); if (targetElement) { setTimeout(() => { targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); targetElement.classList.add('ring-2', 'ring-emerald-500'); setTimeout(() => targetElement.classList.remove('ring-2', 'ring-emerald-500'), 2000); }, 100); } }
    }
    window.addEventListener('hashchange', handleHashNavigation);

    // =================================================================
    // 7. LÓGICA DE LA VISTA DE RED
    // =================================================================
    function openGraphView() {
      document.getElementById('graph-modal-overlay').classList.remove('hidden');
      const container = document.getElementById('graph-container');
      const { nodes, edges } = processGraphData();
      const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
      
      const options = {
        nodes: { shape: 'dot', size: 15, font: { size: 14, color: '#333' }, borderWidth: 2, shadow: true },
        edges: { width: 2, color: { inherit: 'from' }, smooth: { type: 'continuous' }, arrows: { to: { enabled: true, scaleFactor: 0.5 } } },
        physics: { forceAtlas2Based: { gravitationalConstant: -26, centralGravity: 0.005, springLength: 230, springConstant: 0.18 }, maxVelocity: 146, solver: 'forceAtlas2Based', timestep: 0.35, stabilization: { iterations: 150 } },
        interaction: { hover: true, tooltipDelay: 200 }
      };

      network = new vis.Network(container, data, options);
      network.on("click", function (params) { if (params.nodes.length > 0) { const nodeId = params.nodes[0]; const nodeData = nodes.find(n => n.id === nodeId); showNodeInfo(nodeData); } });
    }
    function closeGraphView() {
      document.getElementById('graph-modal-overlay').classList.add('hidden');
      document.getElementById('graph-info-panel').classList.add('hidden');
      if (network) { network.destroy(); network = null; }
    }
    function showNodeInfo(nodeData) {
      const panel = document.getElementById('graph-info-panel'); const titleEl = document.getElementById('graph-info-title'); const contentEl = document.getElementById('graph-info-content');
      titleEl.textContent = nodeData.label;
      if (nodeData.group === 'article') { const article = data.articulos.find(a => a.id === nodeData.articleId); contentEl.innerHTML = `<strong>Artículo ${article.numero}</strong><p class="mt-2">${article.nombre || ''}</p><p class="mt-2 text-xs">${article.texto_completo.substring(0, 200)}...</p>`; }
      else { contentEl.textContent = nodeData.description || 'Entidad mencionada en la ley.'; }
      panel.classList.remove('hidden');
    }
    function processGraphData() {
      const nodes = []; const edges = []; const nodeMap = new Map();
      const institutionKeywords = ["Servicio de Biodiversidad", "SBAP", "Ministerio del Medio Ambiente", "SAG", "Sernapesca", "CONAF"];
      const lawKeywords = ["ley N° 19.300", "Ley General de Pesca", "Ley sobre Caza", "Ley de Bosque Nativo"];
      data.articulos.forEach(article => { const nodeId = `art-${article.id}`; nodeMap.set(nodeId, { id: nodeId, label: `Art. ${article.numero}`, group: 'article', articleId: article.id }); });
      data.articulos.forEach(article => {
        const fromNodeId = `art-${article.id}`; const text = article.texto_completo.toLowerCase();
        const articleMentionRegex = /artículo\s+(\d+[°º]?)/gi; let match;
        while ((match = articleMentionRegex.exec(article.texto_completo)) !== null) {
          const mentionedArtNum = match[1].replace('°', '').replace('º', ''); const mentionedArticle = data.articulos.find(a => a.numero === mentionedArtNum);
          if (mentionedArticle) { const toNodeId = `art-${mentionedArticle.id}`; edges.push({ from: fromNodeId, to: toNodeId, label: 'menciona' }); }
        }
        institutionKeywords.forEach(inst => { if (text.includes(inst.toLowerCase())) { const instNodeId = `inst-${inst.replace(/\s+/g, '-')}`; if (!nodeMap.has(instNodeId)) { nodeMap.set(instNodeId, { id: instNodeId, label: inst, group: 'institution', description: `Institución mencionada en la ley.` }); } edges.push({ from: fromNodeId, to: instNodeId, label: 'menciona' }); } });
        lawKeywords.forEach(law => { if (text.includes(law.toLowerCase())) { const lawNodeId = `law-${law.replace(/\s+/g, '-')}`; if (!nodeMap.has(lawNodeId)) { nodeMap.set(lawNodeId, { id: lawNodeId, label: law, group: 'law', description: `Otra norma legal mencionada.` }); } edges.push({ from: fromNodeId, to: lawNodeId, label: 'se relaciona' }); } });
      });
      nodes.push(...Array.from(nodeMap.values())); return { nodes, edges };
    }

    // =================================================================
    // 8. EXPORTACIÓN Y UTILIDADES
    // =================================================================
    function exportCurrentToPDF() { const element = document.querySelector("main"); html2pdf().set({ margin: 1, filename: 'Ley_21600_Resultados.pdf', html2canvas: { scale: 2 } }).from(element).save(); }
    function exportArticleToPDF(art, el) { const clone = el.cloneNode(true); clone.querySelector(".export-article")?.remove(); clone.querySelector(".focus-mode")?.remove(); clone.querySelector(".add-note")?.remove(); html2pdf().set({ margin: 1, filename: `Articulo_${art.numero.replace(/[^\w]/g, '')}.pdf` }).from(clone).save(); }
    function toggleTheme() { const isDark = document.documentElement.classList.toggle("dark"); localStorage.setItem("dark", isDark); const themeBtn = document.getElementById("theme-toggle"); themeBtn.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>'; }
    function setupTheme() { const isDark = localStorage.getItem("dark") === "true"; document.documentElement.classList.toggle("dark", isDark); const themeBtn = document.getElementById("theme-toggle"); themeBtn.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>'; }
    function debounce(func, wait) { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; }

    // =================================================================
    // 9. INICIALIZACIÓN DE LA APLICACIÓN
    // =================================================================
    async function initializeApp() {
      setupTheme(); const dataLoaded = await loadData(); if (!dataLoaded) { document.getElementById('articles-container').innerHTML = `<p class="text-red-500 text-center">No se pudo cargar el contenido de la ley.</p>`; return; }
      renderFilters(); renderQuickDefinitions(); renderTableOfContents(); renderArticles(); setupEvents(); handleHashNavigation();
    }

    document.addEventListener("DOMContentLoaded", initializeApp);

  </script>
</body>
</html>