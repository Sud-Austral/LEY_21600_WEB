<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ley 21.600 - Biodiversidad y Áreas Protegidas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <!-- Librerías para la visualización de red -->
  <link href="https://unpkg.com/vis-network@latest/styles/dist/vis-network.min.css" rel="stylesheet" type="text/css" />
  <script src="https://unpkg.com/vis-network@latest/standalone/umd/vis-network.min.js"></script>

  <style>
    .highlight { background-color: #fef3c7; padding: 0.1rem 0.2rem; border-radius: 0.25rem; }
    .dark .highlight { background-color: #451a03; }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .has-note { border-left: 4px solid #f59e0b; }
    .filter-group { margin-bottom: 1rem; }
    .filter-group-title { font-weight: 600; font-size: 0.85rem; color: #4b5563; dark:color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
    #graph-container { width: 100%; height: 100%; background-color: #f9fafb; dark:bg-color: #111827; }
    .filter-by-tag { cursor: pointer; transition: all 0.2s ease-in-out; border: 1px solid transparent; }
    .filter-by-tag:hover { transform: scale(1.05); opacity: 0.8; }
    .glossary-term { color: #0ea5e9; border-bottom: 1px dotted #0ea5e9; cursor: help; transition: background-color 0.2s; }
    .glossary-term:hover { background-color: rgba(14, 165, 233, 0.1); }
    #glossary-tooltip { position: absolute; z-index: 100; background-color: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); max-width: 300px; display: none; }
    .dark #glossary-tooltip { background-color: #1f2937; border-color: #374151; }
    #explainer-button { position: absolute; z-index: 50; background-color: #fbbf24; color: #78350f; border: none; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: transform 0.2s, background-color 0.2s; }
    #explainer-button:hover { transform: scale(1.1); background-color: #f59e0b; }

    /* --- Estilos para el Chatbot (Mejorados) --- */
    #chatbot-toggle {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      z-index: 45;
      background-color: #10b981;
      color: white;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    #chatbot-toggle:hover { transform: scale(1.1); background-color: #059669; }
    #chatbot-modal {
      position: fixed;
      bottom: 6rem;
      right: 2rem;
      width: 90%;
      max-width: 400px;
      height: 500px;
      background-color: white;
      dark:bg-color: #1f2937;
      border-radius: 0.75rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      display: none;
      flex-direction: column;
      z-index: 50;
    }
    #chatbot-header {
      padding: 1rem;
      background-color: #10b981;
      color: white;
      border-top-left-radius: 0.75rem;
      border-top-right-radius: 0.75rem;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #chat-history {
      flex-grow: 1;
      padding: 1rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .chat-message {
      max-width: 80%;
      padding: 0.75rem 1rem;
      border-radius: 1.25rem;
      line-height: 1.5;
      word-wrap: break-word;
    }
    .chat-message.user {
      background-color: #e5e7eb;
      dark:bg-color: #4b5563;
      align-self: flex-end;
      border-bottom-right-radius: 0.25rem;
    }
    .chat-message.bot {
      background-color: #f3f4f6;
      dark:bg-color: #374151;
      align-self: flex-start;
      border-bottom-left-radius: 0.25rem;
    }
    
    /* Estilo específico para los enlaces de las fuentes */
    .chat-citation-link {
      color: #047857; /* emerald-700 - más oscuro para mejor contraste en modo claro */
      font-weight: 600;
      text-decoration: underline;
      transition: color 0.2s ease-in-out;
    }
    .chat-citation-link:hover {
      color: #065f46; /* emerald-800 - aún más oscuro al pasar el mouse */
    }
    .dark .chat-citation-link {
      color: #6ee7b7; /* emerald-300 - más claro para resaltar en modo oscuro */
    }
    .dark .chat-citation-link:hover {
      color: #a7f3d0; /* emerald-200 - aún más claro al pasar el mouse */
    }

    #chat-input-area {
      display: flex;
      padding: 1rem;
      border-top: 1px solid #e5e7eb;
      dark:border-color: #4b5563;
    }
    #chat-input {
      flex-grow: 1;
      border: 1px solid #d1d5db;
      dark:border-color: #4b5563;
      border-radius: 9999px;
      padding: 0.5rem 1rem;
      margin-right: 0.5rem;
    }
    #typing-indicator {
      display: none;
      align-self: flex-start;
      padding: 0.75rem 1rem;
    }
    .typing-indicator-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #9ca3af;
      animation: typing 1.4s infinite;
    }
    .typing-indicator-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 transition-colors duration-300">

  <!-- Header -->
  <header class="bg-emerald-700 dark:bg-emerald-800 text-white shadow-lg sticky top-0 z-40">
    <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
      <h1 class="text-xl sm:text-2xl font-bold flex items-center gap-2">
        <i class="fas fa-leaf"></i> Ley 21.600
      </h1>
      <div class="flex items-center gap-4 mt-2 sm:mt-0">
        <button id="theme-toggle" class="p-2 rounded-lg hover:bg-emerald-600 transition" aria-label="Cambiar tema">
          <i class="fas fa-moon"></i>
        </button>
        <button id="graph-view-btn" class="p-2 rounded-lg hover:bg-emerald-600 transition" aria-label="Vista de Red">
          <i class="fas fa-project-diagram"></i>
        </button>
        <button id="export-pdf" class="px-4 py-2 bg-white text-emerald-700 rounded-lg font-medium hover:bg-gray-100 transition hidden">
          <i class="fas fa-file-pdf"></i> PDF
        </button>
      </div>
    </div>
  </header>

  <!-- Main Container -->
  <div class="container mx-auto px-4 py-6 flex flex-col lg:flex-row gap-6">
    <!-- Sidebar: Filtros y Navegación -->
    <aside class="lg:w-80 bg-white dark:bg-gray-800 rounded-xl shadow-md p-5 space-y-6 h-fit sticky top-24">
      <!-- Búsqueda -->
      <div>
        <label class="block text-sm font-semibold mb-2">Buscar en la ley</label>
        <div class="relative">
          <input type="text" id="search-input" placeholder="Ej: zonas dañadas por el hombre, qué pasa si traigo una planta extranjera..." 
                 class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-emerald-500 dark:bg-gray-700">
          <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
        </div>
      </div>
      <!-- Tabla de Contenidos -->
      <div>
        <h3 class="font-semibold mb-3">Tabla de Contenidos</h3>
        <nav id="table-of-contents" class="space-y-1 text-sm max-h-64 overflow-y-auto pr-2"></nav>
      </div>
      <!-- Filtros por Categoría Agrupados -->
      <div>
        <h3 class="font-semibold mb-3">Filtrar por categoría</h3>
        <div id="filters" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
      </div>
      <!-- Definiciones Rápidas -->
      <div>
        <h3 class="font-semibold mb-3">Definiciones clave (Art. 3)</h3>
        <select id="quick-definitions" class="w-full p-2 border rounded-lg dark:bg-gray-700">
          <option value="">Seleccionar término...</option>
        </select>
      </div>
      <!-- Generador de Casos Prácticos -->
      <div>
        <h3 class="font-semibold mb-3">Generador de Casos Prácticos</h3>
        <p class="text-xs text-gray-600 dark:text-gray-400 mb-2">Explora cómo la ley se aplica en situaciones reales.</p>
        <select id="scenario-topic" class="w-full p-2 border rounded-lg dark:bg-gray-700 mb-2">
          <option value="">Selecciona un tema...</option>
        </select>
        <button id="generate-scenario-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition font-medium disabled:bg-gray-400" disabled>
          <i class="fas fa-magic mr-2"></i>Generar Escenario
        </button>
      </div>
      <!-- NUEVO: Detección Proactiva de Obligaciones -->
      <div>
        <h3 class="font-semibold mb-3">Detección Proactiva de Obligaciones</h3>
        <p class="text-xs text-gray-600 dark:text-gray-400 mb-2">Describe tu proyecto y descubre tus obligaciones y derechos.</p>
        <textarea id="proactive-input" rows="3" class="w-full p-2 border rounded-lg dark:bg-gray-700 mb-2" placeholder="Ej: Soy un científico que quiere monitorear una especie de anfibio en un humedal."></textarea>
        <button id="analyze-proactive-btn" class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition font-medium">
          <i class="fas fa-search mr-2"></i>Analizar
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 space-y-6">
      <div id="results-count" class="text-sm text-gray-600 dark:text-gray-400" aria-live="polite"></div>
      <div id="articles-container" class="space-y-6"></div>
      <div id="no-results" class="hidden text-center py-12 text-gray-500">
        <i class="fas fa-search text-4xl mb-4"></i>
        <p>No se encontraron resultados.</p>
      </div>
    </main>
  </div>

  <!-- Modal para Modo Focus y Anotaciones -->
  <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div id="modal-content" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto"></div>
  </div>

  <!-- Modal para la Vista de Red -->
  <div id="graph-modal-overlay" class="fixed inset-0 bg-black z-50 hidden">
    <div class="relative w-full h-full">
      <button id="close-graph-btn" class="absolute top-4 right-4 z-10 text-white bg-black bg-opacity-50 rounded-full p-3 hover:bg-opacity-75 transition">
        <i class="fas fa-times text-xl"></i>
      </button>
      <div id="graph-info-panel" class="absolute top-4 left-4 z-10 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-lg max-w-xs hidden">
        <h3 id="graph-info-title" class="font-bold text-lg mb-2"></h3>
        <p id="graph-info-content" class="text-sm text-gray-600 dark:text-gray-300"></p>
      </div>
      <div id="graph-container"></div>
    </div>
  </div>

  <!-- Tooltip para el glosario -->
  <div id="glossary-tooltip"></div>
  
  <!-- Botón para el explicador de lenguaje plano -->
  <button id="explainer-button" class="hidden" aria-label="Explicar en lenguaje sencillo">
    <i class="fas fa-lightbulb"></i>
  </button>

  <!-- --- Interfaz del Chatbot --- -->
  <button id="chatbot-toggle" aria-label="Abrir Asistente Legal IA">
    <i class="fas fa-comments text-2xl"></i>
  </button>
  <div id="chatbot-modal">
    <div id="chatbot-header">
      <span><i class="fas fa-robot mr-2"></i>Asistente Legal IA</span>
      <button id="close-chatbot" aria-label="Cerrar chat"><i class="fas fa-times"></i></button>
    </div>
    <div id="chat-history">
      <div class="chat-message bot">
        ¡Hola! Soy tu asistente para la Ley 21.600. Pregúntame lo que necesites en lenguaje sencillo. Ej: "¿Qué pasa si introduzco una especie invasora?"
      </div>
      <div id="typing-indicator">
        <span class="typing-indicator-dot"></span>
        <span class="typing-indicator-dot"></span>
        <span class="typing-indicator-dot"></span>
      </div>
    </div>
    <div id="chat-input-area">
      <input type="text" id="chat-input" placeholder="Escribe tu pregunta aquí..." autocomplete="off">
      <button id="send-message" class="bg-emerald-600 text-white px-4 py-2 rounded-full hover:bg-emerald-700 transition">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    // =================================================================
    // 2. ESTADO GLOBAL Y MANEJO DE DATOS
    // =================================================================
    let data;
    let filteredArticles = [];
    let selectedCategories = new Set();
    let currentSearch = "";
    let network = null;
    let glossaryData = {};
    let hideTooltipTimeout;
    let plainLanguageExplanations = {};
    let articleSummaries = {};
    let semanticMap = {};

    async function loadData() {
      try { 
        data = mockDataResponse; 
        filteredArticles = [...data.articulos];
        data.definiciones.forEach(def => {
          glossaryData[def.termino.toLowerCase()] = { definition: def.definicion, contextualLinks: [] };
        });
        if (glossaryData['restauración']) glossaryData['restauración'].contextualLinks.push({ text: 'Ver Planes de restauración ecológica (Art. 33)', articleId: 33 });
        if (glossaryData['uso sustentable']) glossaryData['uso sustentable'].contextualLinks.push({ text: 'Ver Objeto de la ley (Art. 1)', articleId: 1 });

        plainLanguageExplanations = {
          "no se incluyen dentro del objeto la sanidad vegetal y animal ni la prevención y combate de incendios forestales, materias que se rigen por las respectivas normas legales.": "En pocas palabras, esta ley se enfoca en proteger la naturaleza en su conjunto (biodiversidad y patrimonio natural), pero temas muy específicos como las enfermedades de las plantas o los incendios forestales tienen sus propias reglas en otras leyes. Aunque, claro, cualquier acción sobre esos temas debe siempre considerar y proteger la biodiversidad.",
          "el servicio será funcionalmente descentralizado": "Esto significa que el Servicio no tomará todas las decisiones desde un único lugar central (como Santiago). En cambio, tendrá oficinas y equipos en diferentes regiones del país, con autonomía para adaptar las acciones a las realidades locales de cada zona. Es como tener varias 'sedes' inteligentes en todo el territorio.",
          "principio de jerarquía: los impactos significativos sobre la biodiversidad deberán ser evitados, mitigados, reparados y, en último término, compensados.": "Imagina una escalera de acciones. La mejor opción, en la cima, es **evitar** el daño por completo. Si no se puede evitar, el siguiente paso es **mitigarlo**, es decir, reducir su gravedad. Si el daño ya ocurrió, hay que **repararlo** (restaurar el área). Y como último recurso, si nada de lo anterior es posible, se debe **compensar**, es decir, crear un beneficio ambiental en otro lugar para equilibrar el daño causado."
        };
        
        articleSummaries = {
          1: { title: "Objeto y Alcance de la Ley", summary: `<ul class="list-disc list-inside space-y-2 text-gray-700 dark:text-gray-300"><li>El objetivo principal de la ley es <strong>conservar la biodiversidad</strong> y el patrimonio natural de Chile.</li><li>Para lograrlo, se enfoca en tres estrategias clave: <strong>preservación</strong>, <strong>restauración</strong> y <strong>uso sustentable</strong>.</li><li>La ley <strong>no cubre</strong> temas como la sanidad vegetal/animal o los incendios forestales.</li></ul>` },
          2: { title: "Principios Rectores de la Ley", summary: `<ul class="list-disc list-inside space-y-2 text-gray-700 dark:text-gray-300"><li>Establece 10 principios fundamentales que guiarán todas las acciones bajo esta ley.</li><li>Destacan el <strong>Principio de Jerarquía</strong> y el <strong>Principio de Precaución</strong>.</li><li>Promueve la <strong>participación ciudadana</strong>, la <strong>responsabilidad</strong> y la <strong>coordinación</strong>.</li></ul>` },
          5: { title: "Funciones Principales del Servicio de Biodiversidad", summary: `<ul class="list-disc list-inside space-y-2 text-gray-700 dark:text-gray-300"><li><strong>Gestión de Áreas Protegidas:</strong> Administrar el SNAP.</li><li><strong>Planificación y Ejecución:</strong> Elaborar planes de recuperación, restauración y control.</li><li><strong>Fiscalización:</strong> Supervisar y sancionar el cumplimiento de normativas.</li><li><strong>Asesoramiento y Coordinación:</strong> Proponer criterios y coordinar con otros organismos.</li><li><strong>Educación y Difusión:</strong> Promover la educación sobre la biodiversidad.</li></ul>` }
        };
        
        semanticMap = {
          "zonas dañadas por el hombre que necesitan recuperación": { explanation: "Entendí que buscas información sobre áreas dañadas. Te mostré resultados sobre 'áreas degradadas' y 'restauración ecológica'.", keywords: ["área degradada", "restauración ecológica"], articleIds: [3, 32, 33] },
          "qué pasa si introduzco una planta que no es de aquí": { explanation: "Entendí tu consulta sobre especies foráneas. Te mostré resultados sobre 'especies exóticas', 'especies exóticas invasoras' y los planes de control.", keywords: ["especie exótica", "especie exótica invasora", "planes de prevención, control y erradicación"], articleIds: [3, 5] },
          "quién se encarga de los parques nacionales": { explanation: "Entendí que buscas información sobre la administración de áreas protegidas. Te mostré resultados sobre el 'Servicio de Biodiversidad' y sus funciones.", keywords: ["Servicio de Biodiversidad", "Sistema Nacional de Áreas Protegidas"], articleIds: [4, 5] },
          "cómo proteger un animal en peligro": { explanation: "Entendí que buscas cómo ayudar a la fauna amenazada. Te mostré resultados sobre los 'planes de recuperación' y la fiscalización de la fauna.", keywords: ["planes de recuperación, conservación y gestión de especies", "protección de fauna"], articleIds: [5] },
          "qué es un humedal y por qué es importante": { explanation: "Buscaste la definición y relevancia de los humedales. Te mostré la definición oficial y artículos relacionados.", keywords: ["humedal", "servicios ecosistémicos"], articleIds: [3, 2] }
        };

        return true; 
      }
      catch (error) { console.error("Error al cargar los datos:", error); return false; }
    }

    // =================================================================
    // 3. FUNCIONES DE RENDERIZADO DE UI
    // =================================================================
    function renderFilters() {
      const filtersContainer = document.getElementById("filters"); filtersContainer.innerHTML = '';
      const groupedCategories = data.categorias.reduce((acc, cat) => { if (!acc[cat.grupo]) { acc[cat.grupo] = []; } acc[cat.grupo].push(cat); return acc; }, {});
      for (const groupName in groupedCategories) {
        const groupDiv = document.createElement('div'); groupDiv.className = 'filter-group';
        const titleDiv = document.createElement('div'); titleDiv.className = 'filter-group-title'; titleDiv.textContent = groupName; groupDiv.appendChild(titleDiv);
        groupedCategories[groupName].forEach(cat => {
          const label = document.createElement("label"); label.className = "flex items-center gap-2 cursor-pointer text-sm ml-2";
          label.innerHTML = `<input type="checkbox" value="${cat.id}" class="rounded text-emerald-600 focus:ring-emerald-500"><span class="px-2 py-1 rounded-full text-xs font-medium" style="background-color: ${cat.color}20; color: ${cat.color}">${cat.nombre}</span>`;
          label.querySelector("input").addEventListener("change", (e) => { if (e.target.checked) selectedCategories.add(cat.id); else selectedCategories.delete(cat.id); filterArticles(); });
          groupDiv.appendChild(label);
        });
        filtersContainer.appendChild(groupDiv);
      }
    }
    function renderQuickDefinitions() {
      const quickDefs = document.getElementById("quick-definitions"); data.definiciones.forEach(def => { const opt = document.createElement("option"); opt.value = def.id; opt.textContent = `${def.termino} (${def.numero})`; quickDefs.appendChild(opt); });
      quickDefs.addEventListener("change", (e) => { const def = data.definiciones.find(d => d.id == e.target.value); if (def) { searchInput.value = def.termino; handleSearch(); quickDefs.value = ""; } });
    }
    function renderTableOfContents() {
      const tocContainer = document.getElementById('table-of-contents'); tocContainer.innerHTML = '';
      const titulosMap = new Map(data.titulos.map(t => [t.id, { ...t, parrafos: [] }])); data.parrafos.forEach(p => { if (titulosMap.has(p.titulo_id)) { titulosMap.get(p.titulo_id).parrafos.push({ ...p, articulos: data.articulos.filter(a => a.parrafo_id === p.id) }); } });
      titulosMap.forEach(titulo => {
        const titleEl = document.createElement('div');
        titleEl.innerHTML = `<button class="w-full text-left font-semibold p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition" data-target="titulo-${titulo.id}"><i class="fas fa-chevron-right mr-2 toc-icon text-xs"></i> Título ${titulo.numero}: ${titulo.nombre}</button><div id="titulo-${titulo.id}" class="hidden pl-4 space-y-1">${titulo.parrafos.map(parrafo => `<div><button class="w-full text-left p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-xs" data-target="parrafo-${parrafo.id}">${parrafo.numero} ${parrafo.nombre}</button><div id="parrafo-${parrafo.id}" class="hidden pl-4 space-y-1">${parrafo.articulos.map(art => `<a href="#articulo-${art.id}" class="block p-1 hover:bg-emerald-100 dark:hover:bg-emerald-900 rounded text-xs text-gray-600 dark:text-gray-400">Artículo ${art.numero}</a>`).join('')}</div></div>`).join('')}</div>`;
        tocContainer.appendChild(titleEl);
      });
      tocContainer.addEventListener('click', (e) => { const button = e.target.closest('button[data-target]'); if (button) { const targetId = button.dataset.target; const target = document.getElementById(targetId); const icon = button.querySelector('.toc-icon'); target.classList.toggle('hidden'); icon.classList.toggle('fa-chevron-right'); icon.classList.toggle('fa-chevron-down'); } });
    }
    function linkifyCrossReferences(text) {
      const internalLinkRegex = /artículo\s+(\d+[°º]?)/gi; return text.replace(internalLinkRegex, (match, p1) => { const artNum = p1.replace('°', '').replace('º', ''); const article = data.articulos.find(a => a.numero === artNum); if (article) { return `<a href="#articulo-${article.id}" class="text-emerald-600 hover:underline font-semibold">${match}</a>`; } return match; });
    }
    function linkifyGlossaryTerms(text) {
      let processedText = text; const terms = Object.keys(glossaryData).sort((a, b) => b.length - a.length);
      terms.forEach(term => { const escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); const regex = new RegExp(`\\b(${escapedTerm})\\b`, 'gi'); processedText = processedText.replace(regex, (match) => { return `<span class="glossary-term" data-term="${term.toLowerCase()}">${match}</span>`; }); });
      return processedText;
    }
    function renderArticles(explanation = "") {
      const articlesContainer = document.getElementById("articles-container"); const resultsCount = document.getElementById("results-count"); const noResults = document.getElementById("no-results"); const exportBtn = document.getElementById("export-pdf");
      articlesContainer.innerHTML = ""; 
      
      let countText = `${filteredArticles.length} artículo${filteredArticles.length !== 1 ? 's' : ''} encontrado${filteredArticles.length !== 1 ? 's' : ''}.`;
      if (explanation) {
        resultsCount.innerHTML = `<p class="mb-2 text-emerald-600 dark:text-emerald-400 font-medium">${explanation}</p><p>${countText}</p>`;
      } else {
        resultsCount.textContent = countText;
      }

      if (filteredArticles.length === 0) { noResults.classList.remove("hidden"); exportBtn.classList.add("hidden"); return; }
      noResults.classList.add("hidden"); exportBtn.classList.remove("hidden");
      filteredArticles.forEach(art => {
        const articleEl = document.createElement("article"); articleEl.className = "bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 fade-in relative"; articleEl.id = `articulo-${art.id}`;
        const note = getNote(art.id); if (note) articleEl.classList.add('has-note');
        const cats = data.articulos_categorias.filter(ac => ac.articulo_id === art.id).map(ac => data.categorias.find(c => c.id === ac.categoria_id)).map(c => `<button class="filter-by-tag inline-block px-2 py-1 text-xs rounded-full mr-2 mb-1 font-medium" data-category-id="${c.id}" style="background-color: ${c.color}20; color: ${c.color}" title="Filtrar por esta categoría">${c.nombre}</button>`).join("");
        let processedText = linkifyCrossReferences(art.texto_completo); processedText = linkifyGlossaryTerms(processedText);
        if (currentSearch) { const regex = new RegExp(`(${currentSearch})`, "gi"); processedText = processedText.replace(regex, '<span class="highlight">$1</span>'); }
        articleEl.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <h2 class="text-xl font-bold text-emerald-700 dark:text-emerald-400">Artículo ${art.numero}</h2>
            <div class="flex gap-2">
              <button class="text-gray-500 hover:text-emerald-600 focus-mode" data-id="${art.id}" aria-label="Modo de lectura"><i class="fas fa-expand"></i></button>
              <button class="text-gray-500 hover:text-emerald-600 add-note" data-id="${art.id}" aria-label="Añadir nota"><i class="fas fa-sticky-note ${note ? 'text-amber-500' : ''}"></i></button>
              <button class="text-gray-500 hover:text-emerald-600 summarize-article" data-id="${art.id}" aria-label="Resumir artículo"><i class="fas fa-list-ul"></i></button>
              <button class="text-gray-500 hover:text-emerald-600 export-article" data-id="${art.id}" aria-label="Exportar artículo"><i class="fas fa-download"></i></button>
            </div>
          </div>
          ${art.nombre ? `<h3 class="text-lg font-semibold mb-2">${art.nombre}</h3>` : ""}
          <div class="flex flex-wrap gap-1 mb-3">${cats}</div>
          <p class="leading-relaxed text-gray-700 dark:text-gray-300 whitespace-pre-wrap select-text">${processedText}</p>
        `;
        articlesContainer.appendChild(articleEl);
      });
    }

    // =================================================================
    // 4. MANEJO DE EVENTOS Y LÓGICA DE FILTRADO
    // =================================================================
    function setupEvents() {
      const searchInput = document.getElementById("search-input"); const themeBtn = document.getElementById("theme-toggle"); const exportBtn = document.getElementById("export-pdf"); const articlesContainer = document.getElementById("articles-container");
      const graphViewBtn = document.getElementById("graph-view-btn");
      searchInput.addEventListener("input", debounce(handleSearch, 300)); themeBtn.addEventListener("click", toggleTheme); exportBtn.addEventListener("click", exportCurrentToPDF);
      graphViewBtn.addEventListener("click", openGraphView);

      articlesContainer.addEventListener("click", (e) => {
        const target = e.target.closest('button'); if (!target) return; const artId = target.dataset.id; const article = data.articulos.find(a => a.id == artId);
        if (target.classList.contains('export-article')) { exportArticleToPDF(article, document.getElementById(`articulo-${artId}`)); }
        else if (target.classList.contains('focus-mode')) { openFocusMode(article); }
        else if (target.classList.contains('add-note')) { openNoteMode(article); }
        else if (target.classList.contains('filter-by-tag')) { const categoryId = target.dataset.categoryId; applySingleFilter(categoryId); }
        else if (target.classList.contains('summarize-article')) { showArticleSummary(artId); }
      });
      const tooltip = document.getElementById('glossary-tooltip');
      articlesContainer.addEventListener('mouseover', handleGlossaryHover);
      articlesContainer.addEventListener('mouseout', handleGlossaryLeave);
      tooltip.addEventListener('mouseover', () => clearTimeout(hideTooltipTimeout));
      tooltip.addEventListener('mouseout', () => hideTooltip());

      const explainerButton = document.getElementById('explainer-button');
      articlesContainer.addEventListener('mouseup', handleTextSelection);
      document.addEventListener('mouseup', hideExplainerButtonIfOutside);
      explainerButton.addEventListener('click', handleExplainRequest);

      const modalOverlay = document.getElementById('modal-overlay'); modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeModal(); });
      const graphModalOverlay = document.getElementById('graph-modal-overlay');
      document.getElementById('close-graph-btn').addEventListener('click', closeGraphView);
      graphModalOverlay.addEventListener('click', (e) => { if (e.target === graphModalOverlay) closeGraphView(); });
    }
    
    function handleSearch() {
      currentSearch = searchInput.value.toLowerCase().trim();
      filterArticles();
    }

    function filterArticles() {
      let results = [...data.articulos];
      let explanation = "";

      let semanticMatch = null;
      for (const query in semanticMap) {
        if (currentSearch.includes(query)) {
          semanticMatch = semanticMap[query];
          break;
        }
      }
      
      if (semanticMatch) {
        explanation = semanticMatch.explanation;
        if (semanticMatch.articleIds && semanticMatch.articleIds.length > 0) {
          results = results.filter(art => semanticMatch.articleIds.includes(art.id));
        } else if (semanticMatch.keywords && semanticMap.keywords.length > 0) {
          results = results.filter(art => semanticMap.keywords.some(kw => art.texto_completo.toLowerCase().includes(kw)));
        }
      } else if (currentSearch) {
        results = results.filter(art => 
          art.texto_completo.toLowerCase().includes(currentSearch) ||
          art.numero.toLowerCase().includes(currentSearch) ||
          (art.nombre && art.nombre.toLowerCase().includes(currentSearch))
        );
      }
      
      if (selectedCategories.size > 0) {
        results = results.filter(art => 
          data.articulos_categorias.some(ac => 
            ac.articulo_id === art.id && selectedCategories.has(ac.categoria_id)
          )
        );
      }
      
      filteredArticles = results;
      renderArticles(explanation);
    }

    function applySingleFilter(categoryId) {
      selectedCategories.clear(); 
      currentSearch = ""; 
      searchInput.value = ""; 
      selectedCategories.add(parseInt(categoryId, 10));
      updateFilterCheckboxes(); 
      filterArticles();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    function updateFilterCheckboxes() {
      const checkboxes = document.querySelectorAll('#filters input[type="checkbox"]');
      checkboxes.forEach(cb => { cb.checked = selectedCategories.has(parseInt(cb.value, 10)); });
    }

    // =================================================================
    // 5. Lógica del Resumidor de Artículos
    // =================================================================
    function showArticleSummary(articleId) {
      const article = data.articulos.find(a => a.id == articleId); const summaryData = articleSummaries[articleId]; const modalContent = document.getElementById('modal-content');
      let summaryHTML = '';
      if (summaryData) {
        summaryHTML = `<div class="p-6"><div class="flex justify-between items-center mb-4"><h1 class="text-2xl font-bold text-indigo-600"><i class="fas fa-list-ul mr-2"></i>Resumen del Artículo ${article.numero}</h1><button onclick="closeModal()" class="text-gray-500 hover:text-black dark:hover:text-white text-2xl" aria-label="Cerrar modal">&times;</button></div><h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">${summaryData.title}</h2><div class="prose dark:prose-invert max-w-none">${summaryData.summary}</div></div>`;
      } else {
        summaryHTML = `<div class="p-6"><div class="flex justify-between items-center mb-4"><h1 class="text-2xl font-bold text-gray-500"><i class="fas fa-list-ul mr-2"></i>Resumen no disponible</h1><button onclick="closeModal()" class="text-gray-500 hover:text-black dark:hover:text-white text-2xl" aria-label="Cerrar modal">&times;</button></div><p class="text-gray-600 dark:text-gray-400">Lo siento, aún no tengo un resumen preparado para el Artículo ${article.numero}.</p></div>`;
      }
      modalContent.innerHTML = summaryHTML; document.getElementById('modal-overlay').classList.remove('hidden');
    }
    
    // =================================================================
    // 6. Lógica del Explicador de Lenguaje Plano
    // =================================================================
    function handleTextSelection() { const selection = window.getSelection(); const selectedText = selection.toString().trim(); if (selectedText.length > 10) { const range = selection.getRangeAt(0); const rect = range.getBoundingClientRect(); showExplainerButton(rect); } else { hideExplainerButton(); } }
    function hideExplainerButtonIfOutside(e) { const articlesContainer = document.getElementById('articles-container'); if (!articlesContainer.contains(e.target)) { hideExplainerButton(); } }
    function showExplainerButton(rect) { const button = document.getElementById('explainer-button'); button.style.left = `${rect.left + window.scrollX - 45}px`; button.style.top = `${rect.top + window.scrollY - 45}px`; button.classList.remove('hidden'); button.dataset.selectedText = window.getSelection().toString().trim(); }
    function hideExplainerButton() { document.getElementById('explainer-button').classList.add('hidden'); }
    function handleExplainRequest() { const button = document.getElementById('explainer-button'); const selectedText = button.dataset.selectedText; hideExplainerButton(); window.getSelection().removeAllRanges(); showPlainLanguageExplanation(selectedText); }
    
    function showPlainLanguageExplanation(originalText) {
      const modalContent = document.getElementById('modal-content'); const explanation = plainLanguageExplanations[originalText.toLowerCase()];
      let explanationHTML = '';
      if (explanation) { explanationHTML = `<div class="p-6"><div class="flex justify-between items-center mb-4"><h1 class="text-2xl font-bold text-amber-600"><i class="fas fa-lightbulb mr-2"></i>Explicación en Lenguaje Sencillo</h1><button onclick="closeModal()" class="text-gray-500 hover:text-black dark:hover:text-white text-2xl" aria-label="Cerrar modal">&times;</button></div><div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg mb-4"><p class="text-sm font-semibold text-gray-600 dark:text-gray-300 mb-1">Texto original seleccionado:</p><p class="italic">"${originalText}"</p></div><div class="prose dark:prose-invert max-w-none"><p>${explanation}</p></div></div>`; }
      else { explanationHTML = `<div class="p-6"><div class="flex justify-between items-center mb-4"><h1 class="text-2xl font-bold text-gray-500"><i class="fas fa-lightbulb mr-2"></i>Explicación no disponible</h1><button onclick="closeModal()" class="text-gray-500 hover:text-black dark:hover:text-white text-2xl" aria-label="Cerrar modal">&times;</button></div><div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg mb-4"><p class="text-sm font-semibold text-gray-600 dark:text-gray-300 mb-1">Texto original seleccionado:</p><p class="italic">"${originalText}"</p></div><p class="text-gray-600 dark:text-gray-400">Lo siento, aún no tengo una explicación preparada para este fragmento específico.</p></div>`; }
      modalContent.innerHTML = explanationHTML; document.getElementById('modal-overlay').classList.remove('hidden');
    }

    // =================================================================
    // 7. Lógica del Glosario Contextual
    // =================================================================
    function handleGlossaryHover(e) { if (!e.target.classList.contains('glossary-term')) return; const term = e.target.dataset.term; const data = glossaryData[term]; if (!data) return; const tooltip = document.getElementById('glossary-tooltip'); let linksHtml = ''; if (data.contextualLinks && data.contextualLinks.length > 0) { linksHtml = '<hr class="my-2 dark:border-gray-600"><ul class="list-disc list-inside text-sm">'; data.contextualLinks.forEach(link => { linksHtml += `<li><a href="#articulo-${link.articleId}" class="text-emerald-600 hover:underline">${link.text}</a></li>`; }); linksHtml += '</ul>'; } tooltip.innerHTML = `<strong class="text-gray-800 dark:text-gray-100">${term.charAt(0).toUpperCase() + term.slice(1)}</strong><p class="text-sm text-gray-600 dark:text-gray-300 mt-1">${data.definition}</p>${linksHtml}`; const rect = e.target.getBoundingClientRect(); tooltip.style.left = `${rect.left + window.scrollX}px`; tooltip.style.top = `${rect.bottom + window.scrollY + 5}px`; tooltip.style.display = 'block'; clearTimeout(hideTooltipTimeout); }
    function handleGlossaryLeave(e) { if (!e.target.classList.contains('glossary-term')) return; hideTooltipTimeout = setTimeout(hideTooltip, 300); }
    function hideTooltip() { document.getElementById('glossary-tooltip').style.display = 'none'; }

    // =================================================================
    // 8. FUNCIONALIDADES NUEVAS (Modo Focus, Anotaciones, Permalinks)
    // =================================================================
    function openFocusMode(article) { const modalContent = document.getElementById('modal-content'); modalContent.innerHTML = `<div class="p-6"><div class="flex justify-between items-center mb-4"><h1 class="text-3xl font-bold">Artículo ${article.numero}</h1><button onclick="closeModal()" class="text-gray-500 hover:text-black dark:hover:text-white text-2xl" aria-label="Cerrar modal">&times;</button></div>${article.nombre ? `<h2 class="text-xl font-semibold mb-4">${article.nombre}</h2>` : ""}<p class="leading-relaxed text-gray-700 dark:text-gray-300 whitespace-pre-wrap">${linkifyCrossReferences(article.texto_completo)}</p></div>`; document.getElementById('modal-overlay').classList.remove('hidden'); }
    function openNoteMode(article) { const modalContent = document.getElementById('modal-content'); const currentNote = getNote(article.id); modalContent.innerHTML = `<div class="p-6"><div class="flex justify-between items-center mb-4"><h1 class="text-2xl font-bold">Anotación: Artículo ${article.numero}</h1><button onclick="closeModal()" class="text-gray-500 hover:text-black dark:hover:text-white text-2xl" aria-label="Cerrar modal">&times;</button></div><textarea id="note-textarea" class="w-full h-64 p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600" placeholder="Escribe tu nota aquí...">${currentNote}</textarea><div class="flex justify-end gap-2 mt-4"><button onclick="closeModal()" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded-lg">Cancelar</button><button onclick="saveNoteFromModal(${article.id})" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">Guardar Nota</button></div></div>`; document.getElementById('modal-overlay').classList.remove('hidden'); }
    function saveNoteFromModal(articleId) { const noteText = document.getElementById('note-textarea').value; saveNote(articleId, noteText); closeModal(); renderArticles(); }
    function saveNote(articleId, noteText) { const notes = JSON.parse(localStorage.getItem('ley21600-notas') || '{}'); if (noteText.trim()) { notes[articleId] = noteText; } else { delete notes[articleId]; } localStorage.setItem('ley21600-notas', JSON.stringify(notes)); }
    function getNote(articleId) { const notes = JSON.parse(localStorage.getItem('ley21600-notas') || '{}'); return notes[articleId] || ''; }
    function closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); document.getElementById('modal-content').innerHTML = ''; }
    function handleHashNavigation() { const articleId = window.location.hash.substring(1); if (articleId.startsWith('articulo-')) { const targetElement = document.getElementById(articleId); if (targetElement) { setTimeout(() => { targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); targetElement.classList.add('ring-2', 'ring-emerald-500'); setTimeout(() => targetElement.classList.remove('ring-2', 'ring-emerald-500'), 2000); }, 100); } } }
    window.addEventListener('hashchange', handleHashNavigation);

    // =================================================================
    // 9. LÓGICA DE LA VISTA DE RED
    // =================================================================
    function openGraphView() { document.getElementById('graph-modal-overlay').classList.remove('hidden'); const container = document.getElementById('graph-container'); const { nodes, edges } = processGraphData(); const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) }; const options = { nodes: { shape: 'dot', size: 15, font: { size: 14, color: '#333' }, borderWidth: 2, shadow: true }, edges: { width: 2, color: { inherit: 'from' }, smooth: { type: 'continuous' }, arrows: { to: { enabled: true, scaleFactor: 0.5 } } }, physics: { forceAtlas2Based: { gravitationalConstant: -26, centralGravity: 0.005, springLength: 230, springConstant: 0.18 }, maxVelocity: 146, solver: 'forceAtlas2Based', timestep: 0.35, stabilization: { iterations: 150 } }, interaction: { hover: true, tooltipDelay: 200 } }; network = new vis.Network(container, data, options); network.on("click", function (params) { if (params.nodes.length > 0) { const nodeId = params.nodes[0]; const nodeData = nodes.find(n => n.id === nodeId); showNodeInfo(nodeData); } }); }
    function closeGraphView() { document.getElementById('graph-modal-overlay').classList.add('hidden'); document.getElementById('graph-info-panel').classList.add('hidden'); if (network) { network.destroy(); network = null; } }
    function showNodeInfo(nodeData) { const panel = document.getElementById('graph-info-panel'); const titleEl = document.getElementById('graph-info-title'); const contentEl = document.getElementById('graph-info-content'); titleEl.textContent = nodeData.label; if (nodeData.group === 'article') { const article = data.articulos.find(a => a.id === nodeData.articleId); contentEl.innerHTML = `<strong>Artículo ${article.numero}</strong><p class="mt-2">${article.nombre || ''}</p><p class="mt-2 text-xs">${article.texto_completo.substring(0, 200)}...</p>`; } else { contentEl.textContent = nodeData.description || 'Entidad mencionada en la ley.'; } panel.classList.remove('hidden'); }
    function processGraphData() { const nodes = []; const edges = []; const nodeMap = new Map(); const institutionKeywords = ["Servicio de Biodiversidad", "SBAP", "Ministerio del Medio Ambiente", "SAG", "Sernapesca", "CONAF"]; const lawKeywords = ["ley N° 19.300", "Ley General de Pesca", "Ley sobre Caza", "Ley de Bosque Nativo"]; data.articulos.forEach(article => { const nodeId = `art-${article.id}`; nodeMap.set(nodeId, { id: nodeId, label: `Art. ${article.numero}`, group: 'article', articleId: article.id }); }); data.articulos.forEach(article => { const fromNodeId = `art-${article.id}`; const text = article.texto_completo.toLowerCase(); const articleMentionRegex = /artículo\s+(\d+[°º]?)/gi; let match; while ((match = articleMentionRegex.exec(article.texto_completo)) !== null) { const mentionedArtNum = match[1].replace('°', '').replace('º', ''); const mentionedArticle = data.articulos.find(a => a.numero === mentionedArtNum); if (mentionedArticle) { const toNodeId = `art-${mentionedArticle.id}`; edges.push({ from: fromNodeId, to: toNodeId, label: 'menciona' }); } } institutionKeywords.forEach(inst => { if (text.includes(inst.toLowerCase())) { const instNodeId = `inst-${inst.replace(/\s+/g, '-')}`; if (!nodeMap.has(instNodeId)) { nodeMap.set(instNodeId, { id: instNodeId, label: inst, group: 'institution', description: `Institución mencionada en la ley.` }); } edges.push({ from: fromNodeId, to: instNodeId, label: 'menciona' }); } }); lawKeywords.forEach(law => { if (text.includes(law.toLowerCase())) { const lawNodeId = `law-${law.replace(/\s+/g, '-')}`; if (!nodeMap.has(lawNodeId)) { nodeMap.set(lawNodeId, { id: lawNodeId, label: law, group: 'law', description: `Otra norma legal mencionada.` }); } edges.push({ from: fromNodeId, to: lawNodeId, label: 'se relaciona' }); } }); }); nodes.push(...Array.from(nodeMap.values())); return { nodes, edges }; }

    // =================================================================
    // 10. EXPORTACIÓN Y UTILIDADES
    // =================================================================
    function exportCurrentToPDF() { const element = document.querySelector("main"); html2pdf().set({ margin: 1, filename: 'Ley_21600_Resultados.pdf', html2canvas: { scale: 2 } }).from(element).save(); }
    function exportArticleToPDF(art, el) { const clone = el.cloneNode(true); clone.querySelector(".export-article")?.remove(); clone.querySelector(".focus-mode")?.remove(); clone.querySelector(".add-note")?.remove(); html2pdf().set({ margin: 1, filename: `Articulo_${art.numero.replace(/[^\w]/g, '')}.pdf` }).from(clone).save(); }
    function toggleTheme() { const isDark = document.documentElement.classList.toggle("dark"); localStorage.setItem("dark", isDark); const themeBtn = document.getElementById("theme-toggle"); themeBtn.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>'; }
    function setupTheme() { const isDark = localStorage.getItem("dark") === "true"; document.documentElement.classList.toggle("dark", isDark); const themeBtn = document.getElementById("theme-toggle"); themeBtn.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>'; }
    function debounce(func, wait) { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; }

    // =================================================================
    // 11. INICIALIZACIÓN DE LA APLICACIÓN
    // =================================================================
    async function initializeApp() {
      setupTheme(); const dataLoaded = await loadData(); if (!dataLoaded) { document.getElementById('messages-container').innerHTML = `<p class="text-red-500 text-center">No se pudo cargar el contenido de la ley.</p>`; return; }
      renderFilters(); renderQuickDefinitions(); renderTableOfContents(); renderArticles(); setupEvents(); handleHashNavigation(); setupChatbot(); setupScenarioGenerator(); setupProactiveDetection(); // <-- NUEVO: Inicializar la detección proactiva
    }

    // =================================================================
    // 12. LÓGICA DEL CHATBOT
    // =================================================================
    const knowledgeBase = [
      { keywords: ["área protegida privada", "requisitos", "declarar", "cómo"], answer: "Para declarar un área como protegida privada, primero debes entender que se trata de un predio de tu propiedad que el Estado reconoce por su valor en conservación de ecosistemas. La ley establece el marco, pero el proceso detallado se regula en el Título III sobre instrumentos de conservación. El Servicio de Biodiversidad (SBAP) es la entidad encargada de gestionar y reconocer estas áreas.", citations: [{ text: "Artículo 3°, definición 4", articleId: 3 }, { text: "Artículo 23° (Instrumentos)", articleId: 6 }, { text: "Artículo 4° (Creación del SBAP)", articleId: 4 }] },
      { keywords: ["especie invasora", "introduzco", "planta", "animal", "qué pasa"], answer: "Introducir una especie exótica invasora es un tema muy serio. Si una especie se considera 'invasora', significa que amenaza los ecosistemas, hábitats o especies nativas. El Servicio de Biodiversidad (SBAP) tiene la facultad de elaborar y ejecutar planes de prevención, control y erradicación. Además, el Principio de Responsabilidad establece que quien cause daño a la biodiversidad será responsable de ello.", citations: [{ text: "Artículo 3°, definición 15", articleId: 3 }, { text: "Artículo 5° (Funciones SBAP)", articleId: 5 }, { text: "Artículo 2° (Principio de Responsabilidad)", articleId: 9 }] },
      { keywords: ["caza", "permiso", "quién fiscaliza", "autorización"], answer: "La autorización para la caza es una de las atribuciones del Servicio de Biodiversidad (SBAP). Esto significa que ellos son quienes autorizan, regulan y fiscalizan la actividad cinegética en el país, siempre en línea con los objetivos de conservación de la ley.", citations: [{ text: "Artículo 5°, letra ñ)", articleId: 5 }] },
      { keywords: ["objeto de la ley", "para qué sirve", "de qué trata"], answer: "El objeto principal de la Ley 21.600 es conservar la biodiversidad y el patrimonio natural de Chile. Lo hace a través de tres grandes estrategias: la preservación (dejar los ecosistemas intactos), la restauración (recuperar áreas dañadas) y el uso sustentable (aprovechar los recursos naturales sin agotarlos). Es importante notar que temas específicos como sanidad vegetal o incendios forestales tienen sus propias leyes.", citations: [{ text: "Artículo 1°", articleId: 1 }] }
    ];

    let conversationHistory = [];

    function setupChatbot() {
      const chatbotToggle = document.getElementById('chatbot-toggle');
      const chatbotModal = document.getElementById('chatbot-modal');
      const closeChatbot = document.getElementById('close-chatbot');
      const chatInput = document.getElementById('chat-input');
      const sendButton = document.getElementById('send-message');

      chatbotToggle.addEventListener('click', () => {
        chatbotModal.style.display = 'flex';
        chatbotToggle.style.display = 'none';
        chatInput.focus();
      });

      closeChatbot.addEventListener('click', () => {
        chatbotModal.style.display = 'none';
        chatbotToggle.style.display = 'flex';
      });

      sendButton.addEventListener('click', sendMessage);
      chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }

    function sendMessage() {
      const chatInput = document.getElementById('chat-input');
      const userMessage = chatInput.value.trim();
      if (!userMessage) return;

      renderMessage('user', userMessage);
      chatInput.value = '';
      
      showTypingIndicator();

      setTimeout(() => {
        hideTypingIndicator();
        const botResponse = generateBotResponse(userMessage);
        renderMessage('bot', botResponse.text, botResponse.citations);
      }, 1000 + Math.random() * 1000);
    }

    function generateBotResponse(query) {
      const lowerQuery = query.toLowerCase();
      for (const entry of knowledgeBase) {
        if (entry.keywords.some(keyword => lowerQuery.includes(keyword))) {
          return { text: entry.answer, citations: entry.citations };
        }
      }
      return {
        text: "Lo siento, no tengo información específica sobre esa consulta en mi base de datos. Puedes intentar usar la barra de búsqueda o los filtros para explorar la ley, o preguntarme de otra forma.",
        citations: []
      };
    }

    function renderMessage(sender, text, citations = []) {
      const chatHistory = document.getElementById('chat-history');
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${sender}`;
      
      let citationsHtml = '';
      if (citations.length > 0) {
        citationsHtml = `
          <div class="mt-3 pt-3 border-t border-gray-300 dark:border-gray-600">
            <p class="text-xs font-semibold text-gray-500 dark:text-gray-400 mb-2">
              <i class="fas fa-link mr-1"></i>Fuentes:
            </p>
            <ul class="list-disc list-inside space-y-1">
              ${citations.map(cit => 
                `<li><a href="#articulo-${cit.articleId}" onclick="closeChatbotAndNavigate(${cit.articleId})" class="chat-citation-link">${cit.text}</a></li>`
              ).join('')}
            </ul>
          </div>
        `;
      }
      
      messageDiv.innerHTML = text + citationsHtml;
      chatHistory.appendChild(messageDiv);
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function showTypingIndicator() {
      document.getElementById('typing-indicator').style.display = 'block';
      const chatHistory = document.getElementById('chat-history');
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function hideTypingIndicator() {
      document.getElementById('typing-indicator').style.display = 'none';
    }
    
    function closeChatbotAndNavigate(articleId) {
      document.getElementById('chatbot-modal').style.display = 'none';
      document.getElementById('chatbot-toggle').style.display = 'flex';
      window.location.hash = `articulo-${articleId}`;
    }

    // =================================================================
    // 13. LÓGICA DEL GENERADOR DE ESCENARIOS
    // =================================================================
    const scenariosData = {
      "turismo": {
        title: "Turismo en un Sitio Prioritario",
        actor: "Operador de turismo",
        scenario: "Imagina que eres un operador turístico que quiere ofrecer excursiones de observación de aves en un 'Sitio Prioritario' para la conservación, designado por el SBAP. Tu plan incluye llevar grupos de 10 personas dos veces por semana. Para operar legalmente bajo la Ley 21.600, debes considerar lo siguiente: Primero, necesitas evaluar si tu actividad se enmarca en el 'Uso Sustentable' y no causará un impacto significativo. Debes coordinarte con el SBAP para obtener los permisos correspondientes, ya que operas en un área sensible. Es fundamental aplicar el 'Principio de Precaución', asegurándote de no perturbar las especies nidificantes. Además, tu operación debe alinearse con la definición de 'Turismo ambientalmente responsable', promoviendo la conservación y educando a tus clientes. Si, a pesar de tus precauciones, se causa un daño, el 'Principio de Responsabilidad' te haría pasible de repararlo.",
        keyPrinciples: [
          { name: "Uso Sustentable", articleId: 3, definitionId: 32 },
          { name: "Principio de Precaución", articleId: 2 },
          { name: "Principio de Responsabilidad", articleId: 9 },
          { name: "Turismo ambientalmente responsable", articleId: 3, definitionId: 34 }
        ],
        citations: [
          { text: "Artículo 1° (Objeto de la ley)", articleId: 1 },
          { text: "Artículo 3°, Definiciones", articleId: 3 },
          { text: "Artículo 5° (Funciones del SBAP)", articleId: 5 }
        ]
      },
      "investigacion": {
        title: "Investigación Científica en un Área Protegida",
        actor: "Investigador",
        scenario: "Eres un biólogo que busca realizar un estudio sobre la diversidad de anfibios en un Parque Nacional. Para ello, necesitas instalar equipos de monitoreo y recolectar muestras de agua y suelo. Según la Ley 21.600, la investigación científica es una actividad fomentada, pero está regulada. Debes presentar tu proyecto al Servicio de Biodiversidad (SBAP) para su evaluación y aprobación, asegurando que tu metodología no comprometa la 'Preservación' del área. El SBAP, en su función de promover redes de monitoreo, podría apoyar tu iniciativa. Sin embargo, debes seguir estrictamente los principios de 'Uso Sustentable' y 'Precaución' para minimizar tu impacto. Cualquier descubrimiento relevante, especialmente sobre especies en peligro, debe ser comunicado para alimentar los 'Planes de Recuperación' que el SBAP elabora.",
        keyPrinciples: [
          { name: "Preservación", articleId: 3, definitionId: 26 },
          { name: "Uso Sustentable", articleId: 3, definitionId: 32 },
          { name: "Principio de Precaución", articleId: 2 }
        ],
        citations: [
          { text: "Artículo 5°, letra c) y d)", articleId: 5 },
          { text: "Artículo 5°, letra e)", articleId: 5 },
          { text: "Artículo 3°, Definiciones", articleId: 3 }
        ]
      },
      "proyecto-inmobiliario": {
        title: "Proyecto Inmobiliario cerca de un Humedal",
        actor: "Desarrollador inmobiliario",
        scenario: "Una empresa inmobiliaria planea construir un complejo de departamentos en un terreno que colinda con un 'Humedal' urbano, reconocido por su importancia ecológica. Antes de iniciar cualquier obra, la Ley 21.600 obliga al desarrollador a realizar una evaluación de impacto. Se debe aplicar rigurosamente el 'Principio de Jerarquía': primero, se deben <strong>evitar</strong> los impactos (ej. rediseñar el proyecto para aumentar la distancia de construcción). Si no es posible, se deben <strong>mitigar</strong> (ej. crear barreras acústicas y visuales). Si el impacto ocurre, se debe <strong>reparar</strong> (ej. restaurar una zona degradada del humedal). Y como último recurso, <strong>compensar</strong> (ej. financiar la protección de otro humedal en la región). El SBAP tiene la facultad de pronunciarse sobre los impactos y fiscalizar el cumplimiento de estas medidas.",
        keyPrinciples: [
          { name: "Principio de Jerarquía", articleId: 2 },
          { name: "Humedal", articleId: 3, definitionId: 18 },
          { name: "Principio de Responsabilidad", articleId: 9 }
        ],
        citations: [
          { text: "Artículo 2°, Principio de Jerarquía", articleId: 2 },
          { text: "Artículo 3°, definición 18", articleId: 3 },
          { text: "Artículo 5°, letra i)", articleId: 5 }
        ]
      }
    };

    function setupScenarioGenerator() {
      const topicSelect = document.getElementById('scenario-topic');
      const generateBtn = document.getElementById('generate-scenario-btn');

      Object.keys(scenariosData).forEach(key => {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = scenariosData[key].title;
        topicSelect.appendChild(option);
      });

      topicSelect.addEventListener('change', () => {
        generateBtn.disabled = !topicSelect.value;
      });

      generateBtn.addEventListener('click', generateScenario);
    }

    function generateScenario() {
      const topicSelect = document.getElementById('scenario-topic');
      const selectedTopic = topicSelect.value;
      if (!selectedTopic) return;

      const scenarioData = scenariosData[selectedTopic];
      const modalContent = document.getElementById('modal-content');
      
      modalContent.innerHTML = `
        <div class="p-6 flex items-center justify-center h-64">
          <div class="text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-indigo-600 mb-4"></i>
            <p class="text-lg">Generando escenario práctico...</p>
          </div>
        </div>
      `;
      document.getElementById('modal-overlay').classList.remove('hidden');

      setTimeout(() => {
        displayScenarioModal(scenarioData);
      }, 1500);
    }

    function displayScenarioModal(scenario) {
      const modalContent = document.getElementById('modal-content');
      const principlesHtml = scenario.keyPrinciples.map(p => {
        const article = data.articulos.find(a => a.id === p.articleId);
        const definition = data.definiciones.find(d => d.articulo_id === p.articleId && d.numero === p.definitionId);
        let linkText = `Artículo ${article.numero}`;
        if (definition) {
            linkText += `, ${definition.numero}`;
        }
        return `<li><strong>${p.name}:</strong> Ver <a href="#articulo-${p.articleId}" class="text-indigo-600 hover:underline font-semibold">${linkText}</a>.</li>`;
      }).join('');

      const citationsHtml = scenario.citations.map(cit => 
        `<li><a href="#articulo-${cit.articleId}" class="text-indigo-600 hover:underline font-semibold">${cit.text}</a></li>`
      ).join('');

      modalContent.innerHTML = `
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold text-indigo-600"><i class="fas fa-magic mr-2"></i>${scenario.title}</h1>
            <button onclick="closeModal()" class="text-gray-500 hover:text-black dark:hover:text-white text-2xl" aria-label="Cerrar modal">&times;</button>
          </div>
          <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg mb-4">
            <p class="text-sm font-semibold text-gray-600 dark:text-gray-300 mb-1">Actor involucrado:</p>
            <p class="text-lg font-medium">${scenario.actor}</p>
          </div>
          <div class="prose dark:prose-invert max-w-none">
            <p>${scenario.scenario}</p>
          </div>
          <div class="mt-6 p-4 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg">
            <h3 class="text-lg font-semibold text-indigo-800 dark:text-indigo-300 mb-3">
              <i class="fas fa-lightbulb mr-2"></i>Principios y Definiciones Clave de la Ley
            </h3>
            <ul class="list-disc list-inside space-y-2 text-gray-700 dark:text-gray-300">
              ${principlesHtml}
            </ul>
          </div>
          <div class="mt-4">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">
              <i class="fas fa-book mr-2"></i>Artículos Relevantes para Consultar
            </h3>
            <ul class="list-disc list-inside space-y-1">
              ${citationsHtml}
            </ul>
          </div>
        </div>
      `;
    }

    // =================================================================
    // 14. LÓGICA DE DETECCIÓN PROACTIVA (NUEVO)
    // =================================================================
    const proactiveDetectionRules = [
      {
        keywords: ["científico", "investigador", "monitorear", "investigación", "estudio", "especie", "humedal", "parque"],
        title: "Análisis para Investigación Científica",
        checklist: [
          "Evalúa si tu actividad se enmarca en el <strong>Uso Sustentable</strong> (Art. 3°, def. 32).",
          "Considera la definición de <strong>Hábitat</strong> para tu estudio (Art. 3°, def. 17).",
          "El Servicio de Biodiversidad (SBAP) promueve programas de investigación y redes de monitoreo (Art. 5°, c, d).",
          "Si tu investigación es en un área protegida, podrías necesitar autorizaciones del SBAP (Título III).",
          "Aplica el <strong>Principio de Precaución</strong> para evitar impactos no deseados (Art. 2°)."
        ],
        relevantArticles: [
          { text: "Artículo 3°, Definiciones", articleId: 3 },
          { text: "Artículo 5°, Funciones del SBAP", articleId: 5 },
          { text: "Artículo 2°, Principios", articleId: 2 }
        ]
      },
      {
        keywords: ["turismo", "operador", "excursión", "guía", "área protegida", "parque", "sitio prioritario"],
        title: "Análisis para Proyecto de Turismo",
        checklist: [
          "Tu actividad debe alinearse con la definición de <strong>Turismo ambientalmente responsable</strong> (Art. 3°, def. 34).",
          "Gestionar el <strong>Sistema Nacional de Áreas Protegidas</strong> es una función del SBAP (Art. 5°, b).",
          "Debes aplicar el <strong>Principio de Precaución</strong> para minimizar impactos en la fauna y flora (Art. 2°).",
          "Asegúrate de que tu operación no vulnere el <strong>Uso Sustentable</strong> del área (Art. 3°, def. 32).",
          "Recuerda el <strong>Principio de Responsabilidad</strong>: cualquier daño causado debe ser reparado (Art. 2°, g)."
        ],
        relevantArticles: [
          { text: "Artículo 3°, Definiciones", articleId: 3 },
          { text: "Artículo 5°, Funciones del SBAP", articleId: 5 },
          { text: "Artículo 2°, Principios", articleId: 2 }
        ]
      },
      {
        keywords: ["construir", "inmobiliaria", "proyecto", "edificio", "urbanismo", "humedal", "río", "cerro"],
        title: "Análisis para Proyecto Inmobiliario o de Construcción",
        checklist: [
          "Debes aplicar rigurosamente el <strong>Principio de Jerarquía</strong> (Art. 2°, b): Evitar, Mitigar, Reparar, Compensar.",
          "El SBAP debe pronunciarse sobre los impactos de tu proyecto (Art. 5°, i).",
          "Si tu proyecto afecta un <strong>Hábitat</strong> o <strong>Humedal</strong>, las restricciones son mayores (Art. 3°, defs. 17, 18).",
          "El <strong>Principio de Responsabilidad</strong> te hace pasible de reparar cualquier daño (Art. 2°, g).",
          "Evalúa si tu proyecto podría requerir un <strong>Plan de Restauración</strong> como medida de compensación."
        ],
        relevantArticles: [
          { text: "Artículo 2°, Principio de Jerarquía", articleId: 2 },
          { text: "Artículo 5°, Funciones del SBAP", articleId: 5 },
          { text: "Artículo 3°, Definiciones", articleId: 3 }
        ]
      },
      {
        keywords: ["municipio", "municipalidad", "paisaje de conservación", "conservar", "área verde", "corredor biológico"],
        title: "Análisis para Iniciativa de Conservación Local",
        checklist: [
          "Considera crear un <strong>Área Silvestre Protegida Privada</strong> si tienes terrenos propios (Art. 3°, def. 4).",
          "El SBAP puede <strong>apoyar técnicamente</strong> tu iniciativa (Art. 5°, f).",
          "Explora los <strong>Instrumentos de Conservación</strong> del Título III de la ley (Art. 23°).",
          "Podrías postular al <strong>Fondo Nacional de la Biodiversidad</strong> para financiar tu proyecto (Art. 5°, j).",
          "Fomenta la <strong>participación ciudadana</strong> en tu iniciativa, como lo establece el Principio Participatorio (Art. 2°, d)."
        ],
        relevantArticles: [
          { text: "Artículo 3°, Definiciones", articleId: 3 },
          { text: "Artículo 5°, Funciones del SBAP", articleId: 5 },
          { text: "Artículo 23°, Instrumentos de Conservación", articleId: 6 },
          { text: "Artículo 2°, Principios", articleId: 2 }
        ]
      }
    ];

    function setupProactiveDetection() {
      const analyzeBtn = document.getElementById('analyze-proactive-btn');
      analyzeBtn.addEventListener('click', analyzeUserInput);
    }

    function analyzeUserInput() {
      const input = document.getElementById('proactive-input').value.trim();
      if (!input) return;

      const modalContent = document.getElementById('modal-content');
      modalContent.innerHTML = `
        <div class="p-6 flex items-center justify-center h-64">
          <div class="text-center">
            <i class="fas fa-brain fa-pulse text-4xl text-purple-600 mb-4"></i>
            <p class="text-lg">Analizando tu situación...</p>
          </div>
        </div>
      `;
      document.getElementById('modal-overlay').classList.remove('hidden');

      setTimeout(() => {
        const matchedRule = findMatchingRule(input);
        displayProactiveAnalysisModal(matchedRule);
      }, 1500);
    }

    function findMatchingRule(userText) {
      const lowerText = userText.toLowerCase();
      for (const rule of proactiveDetectionRules) {
        if (rule.keywords.some(keyword => lowerText.includes(keyword))) {
          return rule;
        }
      }
      return null;
    }

    function displayProactiveAnalysisModal(rule) {
      const modalContent = document.getElementById('modal-content');
      if (!rule) {
        modalContent.innerHTML = `
          <div class="p-6 text-center">
            <h1 class="text-2xl font-bold text-gray-500 mb-4"><i class="fas fa-exclamation-triangle mr-2"></i>No se encontró una coincidencia</h1>
            <p class="text-gray-600 dark:text-gray-400">No pude identificar una situación específica en tu descripción. Intenta usar palabras clave como 'investigación', 'turismo', 'construir' o 'municipio'.</p>
            <button onclick="closeModal()" class="mt-4 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">Cerrar</button>
          </div>
        `;
        return;
      }

      const checklistHtml = rule.checklist.map(item => `<li class="mb-2">${item}</li>`).join('');
      const articlesHtml = rule.relevantArticles.map(cit => 
        `<li><a href="#articulo-${cit.articleId}" class="text-purple-600 hover:underline font-semibold">${cit.text}</a></li>`
      ).join('');

      modalContent.innerHTML = `
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold text-purple-600"><i class="fas fa-clipboard-check mr-2"></i>${rule.title}</h1>
            <button onclick="closeModal()" class="text-gray-500 hover:text-black dark:hover:text-white text-2xl" aria-label="Cerrar modal">&times;</button>
          </div>
          <div class="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg mb-4">
            <h3 class="text-lg font-semibold text-purple-800 dark:text-purple-300 mb-3">
              <i class="fas fa-list-check mr-2"></i>Lista de Verificación de Obligaciones y Derechos
            </h3>
            <ul class="list-disc list-inside space-y-2 text-gray-700 dark:text-gray-300">
              ${checklistHtml}
            </ul>
          </div>
          <div class="mt-4">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">
              <i class="fas fa-book mr-2"></i>Artículos Relevantes para Consultar
            </h3>
            <ul class="list-disc list-inside space-y-1">
              ${articlesHtml}
            </ul>
          </div>
        </div>
      `;
    }

    document.addEventListener("DOMContentLoaded", initializeApp);

  </script>
</body>
</html>