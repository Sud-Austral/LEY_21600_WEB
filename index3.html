<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ley 21.600 - Biodiversidad y Áreas Protegidas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <!-- Librerías para la visualización de red -->
  <link href="https://unpkg.com/vis-network@latest/styles/dist/vis-network.min.css" rel="stylesheet" type="text/css" />
  <script src="https://unpkg.com/vis-network@latest/standalone/umd/vis-network.min.js"></script>

  <style>
    /* Mejoras de estilo y micro-interacciones */
    .highlight { background-color: #fef3c7; padding: 0.1rem 0.2rem; border-radius: 0.25rem; }
    .dark .highlight { background-color: #451a03; }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .has-note { border-left: 4px solid #f59e0b; }
    
    /* Estilos para las etiquetas clicables */
    .filter-by-tag { cursor: pointer; transition: all 0.2s ease-in-out; border: 1px solid transparent; }
    .filter-by-tag:hover { transform: scale(1.05); opacity: 0.8; }
    
    /* NUEVO: Transiciones suaves para todos los elementos interactivos */
    .btn-transition { transition: all 0.3s ease; }
    .card-hover { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .card-hover:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    
    /* NUEVO: Estilos para pestañas del sidebar */
    .sidebar-tab { padding: 0.75rem 1rem; border-bottom: 2px solid transparent; font-weight: 500; cursor: pointer; transition: all 0.2s ease; }
    .sidebar-tab.active { border-bottom-color: #10b981; color: #10b981; }
    .sidebar-tab:hover { background-color: rgba(16, 185, 129, 0.1); }
    
    /* NUEVO: Estilos para botón de volver arriba */
    #back-to-top { position: fixed; bottom: 20px; right: 20px; z-index: 40; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
    #back-to-top.show { opacity: 1; visibility: visible; }
    
    /* NUEVO: Estilos para breadcrumbs */
    .breadcrumb-item { display: inline-flex; align-items: center; color: #6b7280; }
    .breadcrumb-item:not(:last-child)::after { content: '/'; margin: 0 0.5rem; color: #9ca3af; }
    .breadcrumb-item.active { color: #10b981; font-weight: 500; }
    
    /* NUEVO: Estilos para indicador de filtros activos */
    .active-filters { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; }
    .active-filter { display: inline-flex; align-items: center; padding: 0.25rem 0.5rem; background-color: #10b981; color: white; border-radius: 9999px; font-size: 0.75rem; }
    .active-filter button { margin-left: 0.25rem; background: none; border: none; color: white; cursor: pointer; }
    
    /* NUEVO: Mejoras en accesibilidad - foco visible */
    *:focus { outline: 2px solid #10b981; outline-offset: 2px; }
    button:focus, a:focus { outline-offset: 1px; }
    
    /* NUEVO: Mejoras en el modal de red */
    #graph-container { width: 100%; height: 100%; background-color: #f9fafb; dark:bg-color: #111827; }
    #graph-loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; }
    
    /* NUEVO: Mejoras en el sidebar móvil */
    @media (max-width: 1024px) {
      .sidebar-mobile { position: fixed; top: 0; left: 0; z-index: 50; height: 100vh; width: 80%; max-width: 320px; transform: translateX(-100%); transition: transform 0.3s ease; }
      .sidebar-mobile.open { transform: translateX(0); }
      .sidebar-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 40; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
      .sidebar-overlay.show { opacity: 1; visibility: visible; }
    }
    
    /* NUEVO: Estilos para listas en artículos - versión mejorada */
    .article-content {
      line-height: 1.7;
    }
    .article-content p {
      margin-bottom: 1rem;
    }
    .article-content p:last-child {
      margin-bottom: 0;
    }
    .article-content ol, .article-content ul {
      margin: 1rem 0;
      padding-left: 1.5rem;
    }
    .article-content ol li, .article-content ul li {
      margin-bottom: 0.5rem;
      position: relative;
    }
    .article-content ol li:last-child, .article-content ul li:last-child {
      margin-bottom: 0;
    }
    .article-content ol {
      list-style-type: decimal;
    }
    .article-content ul {
      list-style-type: lower-alpha;
    }
    
    /* NUEVO: Estilos para depuración - quitar después de probar */
    .debug-info {
      background-color: #f0f9ff;
      border: 1px dashed #0ea5e9;
      padding: 0.5rem;
      margin: 0.5rem 0;
      font-size: 0.75rem;
      color: #0c4a6e;
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 transition-colors duration-300">

  <!-- Header -->
  <header class="bg-emerald-700 dark:bg-emerald-800 text-white shadow-lg sticky top-0 z-40">
    <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
      <div class="flex items-center w-full sm:w-auto">
        <!-- NUEVO: Botón para abrir sidebar en móvil -->
        <button id="sidebar-toggle" class="mr-3 p-2 rounded-lg hover:bg-emerald-600 transition lg:hidden" aria-label="Abrir menú">
          <i class="fas fa-bars"></i>
        </button>
        <h1 class="text-xl sm:text-2xl font-bold flex items-center gap-2">
          <i class="fas fa-leaf"></i> Ley 21.600
        </h1>
      </div>
      <div class="flex items-center gap-4 mt-2 sm:mt-0">
        <button id="theme-toggle" class="p-2 rounded-lg hover:bg-emerald-600 transition btn-transition" aria-label="Cambiar tema">
          <i class="fas fa-moon"></i>
        </button>
        <a href="graph3.html" class="p-2 rounded-lg hover:bg-emerald-600 transition btn-transition" aria-label="Vista de Red">
            <i class="fas fa-project-diagram"></i>
            </a>

        <button id="export-pdf" class="px-4 py-2 bg-white text-emerald-700 rounded-lg font-medium hover:bg-gray-100 transition btn-transition hidden">
          <i class="fas fa-file-pdf"></i> PDF
        </button>
      </div>
    </div>
    
    <!-- NUEVO: Breadcrumbs -->
    <div class="bg-emerald-600 dark:bg-emerald-700 px-4 py-2 text-sm">
      <div class="container mx-auto">
        <nav id="breadcrumbs" aria-label="Navegación">
          <span class="breadcrumb-item active">Ley 21.600</span>
        </nav>
      </div>
    </div>
  </header>

  <!-- NUEVO: Overlay para sidebar móvil -->
  <div id="sidebar-overlay" class="sidebar-overlay lg:hidden"></div>

  <!-- Main Container -->
  <div class="container mx-auto px-4 py-6 flex flex-col lg:flex-row gap-6">
    <!-- Sidebar: Filtros y Navegación -->
    <aside id="sidebar" class="sidebar-mobile lg:static lg:w-80 bg-white dark:bg-gray-800 rounded-xl shadow-md p-5 space-y-6 h-fit lg:sticky lg:top-24 z-50">
      <!-- NUEVO: Botón para cerrar sidebar en móvil -->
      <div class="flex justify-between items-center lg:hidden mb-4">
        <h2 class="text-lg font-semibold">Navegación</h2>
        <button id="sidebar-close" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition" aria-label="Cerrar menú">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <!-- NUEVO: Pestañas para Contenido y Filtros -->
      <div class="flex border-b border-gray-200 dark:border-gray-700 mb-4">
        <button id="content-tab" class="sidebar-tab active flex-1 text-center" data-tab="content">
          <i class="fas fa-list mr-2"></i> Contenido
        </button>
        <button id="filters-tab" class="sidebar-tab flex-1 text-center" data-tab="filters">
          <i class="fas fa-filter mr-2"></i> Filtros
        </button>
      </div>
      
      <!-- Contenido de la pestaña: Tabla de Contenidos -->
      <div id="content-panel" class="tab-panel">
        <h3 class="font-semibold mb-3">Tabla de Contenidos</h3>
        <nav id="table-of-contents" class="space-y-1 text-sm max-h-96 overflow-y-auto pr-2"></nav>
      </div>
      
      <!-- Contenido de la pestaña: Filtros -->
      <div id="filters-panel" class="tab-panel hidden">
        <!-- Búsqueda -->
        <div>
          <label class="block text-sm font-semibold mb-2">Buscar en la ley</label>
          <div class="relative">
            <input type="text" id="search-input" placeholder="Ej: humedal, biodiversidad..." 
                   class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-emerald-500 dark:bg-gray-700">
            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
          </div>
        </div>
        
        <!-- Filtros por Categoría Agrupados -->
        <div class="mt-4">
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-semibold">Filtrar por categoría</h3>
            <button id="clear-filters" class="text-xs text-emerald-600 hover:text-emerald-800 dark:hover:text-emerald-400">
              Limpiar filtros
            </button>
          </div>
          <div id="filters" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
          
          <!-- NUEVO: Indicador de filtros activos -->
          <div id="active-filters-container" class="active-filters"></div>
        </div>
        
        <!-- Definiciones Rápidas -->
        <div class="mt-4">
          <h3 class="font-semibold mb-3">Definiciones clave (Art. 3)</h3>
          <select id="quick-definitions" class="w-full p-2 border rounded-lg dark:bg-gray-700">
            <option value="">Seleccionar término...</option>
          </select>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 space-y-6">
      <div id="results-count" class="text-sm text-gray-600 dark:text-gray-400" aria-live="polite"></div>
      <div id="articles-container" class="space-y-6"></div>
      <div id="no-results" class="hidden text-center py-12 text-gray-500">
        <i class="fas fa-search text-4xl mb-4"></i>
        <p>No se encontraron resultados.</p>
      </div>
    </main>
  </div>

  <!-- NUEVO: Botón Volver Arriba -->
  <button id="back-to-top" class="bg-emerald-600 text-white p-3 rounded-full shadow-lg btn-transition" aria-label="Volver arriba">
    <i class="fas fa-arrow-up"></i>
  </button>

  <!-- Modal para Modo Focus y Anotaciones -->
  <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div id="modal-content" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto"></div>
  </div>

  <!-- Modal para la Vista de Red -->
  <div id="graph-modal-overlay" class="fixed inset-0 bg-black z-50 hidden">
    <div class="relative w-full h-full">
      <button id="close-graph-btn" class="absolute top-4 right-4 z-10 text-white bg-black bg-opacity-50 rounded-full p-3 hover:bg-opacity-75 transition">
        <i class="fas fa-times text-xl"></i>
      </button>
      <div id="graph-info-panel" class="absolute top-4 left-4 z-10 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-lg max-w-xs hidden">
        <h3 id="graph-info-title" class="font-bold text-lg mb-2"></h3>
        <p id="graph-info-content" class="text-sm text-gray-600 dark:text-gray-300"></p>
      </div>
      <!-- NUEVO: Indicador de carga para la red -->
      <div id="graph-loading" class="hidden">
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-lg flex items-center">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600 mr-3"></div>
          <span>Cargando visualización...</span>
        </div>
      </div>
      <div id="graph-container"></div>
    </div>
  </div>
  <script src="base.js"></script>

  <!-- Scripts -->
  <script>
    // =================================================================
    // 1. DATOS (Simulados)
    // =================================================================
    
    // =================================================================
    // 2. ESTADO GLOBAL Y MANEJO DE DATOS
    // =================================================================
    let data;
    let filteredArticles = [];
    let selectedCategories = new Set();
    let currentSearch = "";
    let network = null;

    async function loadData() {
      try { data = mockDataResponse; filteredArticles = [...data.articulos]; return true; }
      catch (error) { console.error("Error al cargar los datos:", error); return false; }
    }

    // 3. NUEVO: Función mejorada para formatear listas en el texto
    // =================================================================
    // =================================================================
// 3. NUEVO: Función mejorada para formatear listas en el texto
// =================================================================
  function formatListsInText(text) {
  // Si ya hay listas HTML, no procesamos
  if (text.includes("<ol>") || text.includes("<ul>") || text.includes("<li>")) {
    return text;
  }

  let formattedText = text;

  // --- Detectar listas numeradas: cualquier número seguido de ) ---
  const orderedListPattern = /\b(\d+)\)\s+([^a-z]\w*[^:]*?:.*?)(?=\s+\d+\)|$)/g;

  // --- Detectar listas alfabéticas: cualquier letra seguida de ) ---
  const unorderedListPattern = /\b([a-z])\)\s+(.*?)(?=\s+[a-z]\)|$)/gi;

  // Verificar si hay listas numeradas
  const hasOrderedList = /\b\d+\)\s+/.test(formattedText);
  
  // Verificar si hay listas alfabéticas
  const hasUnorderedList = /\b[a-z]\)\s+/i.test(formattedText);

  if (hasOrderedList) {
    formattedText = formattedText.replace(orderedListPattern, (match, num, content) => {
      return `<li>${content.trim()}</li>`;
    });
    formattedText = `<ol>${formattedText}</ol>`;
  }
  else if (hasUnorderedList) {
    formattedText = formattedText.replace(unorderedListPattern, (match, letter, content) => {
      return `<li>${content.trim()}</li>`;
    });
    formattedText = `<ul>${formattedText}</ul>`;
  }

  return formattedText;
}


    // =================================================================
    // 4. FUNCIONES DE RENDERIZADO DE UI
    // =================================================================
    function renderFilters() {
      const filtersContainer = document.getElementById("filters"); filtersContainer.innerHTML = '';
      const groupedCategories = data.categorias.reduce((acc, cat) => { if (!acc[cat.grupo]) { acc[cat.grupo] = []; } acc[cat.grupo].push(cat); return acc; }, {});
      for (const groupName in groupedCategories) {
        const groupDiv = document.createElement('div'); groupDiv.className = 'filter-group';
        const titleDiv = document.createElement('div'); titleDiv.className = 'filter-group-title'; titleDiv.textContent = groupName; groupDiv.appendChild(titleDiv);
        groupedCategories[groupName].forEach(cat => {
          const label = document.createElement("label"); label.className = "flex items-center gap-2 cursor-pointer text-sm ml-2";
          label.innerHTML = `<input type="checkbox" value="${cat.id}" class="rounded text-emerald-600 focus:ring-emerald-500"><span class="px-2 py-1 rounded-full text-xs font-medium" style="background-color: ${cat.color}20; color: ${cat.color}">${cat.nombre}</span>`;
          label.querySelector("input").addEventListener("change", (e) => { if (e.target.checked) selectedCategories.add(cat.id); else selectedCategories.delete(cat.id); filterArticles(); });
          groupDiv.appendChild(label);
        });
        filtersContainer.appendChild(groupDiv);
      }
    }
    function renderQuickDefinitions() {
      const quickDefs = document.getElementById("quick-definitions"); data.definiciones.forEach(def => { const opt = document.createElement("option"); opt.value = def.id; opt.textContent = `${def.termino} (${def.numero})`; quickDefs.appendChild(opt); });
      quickDefs.addEventListener("change", (e) => { const def = data.definiciones.find(d => d.id == e.target.value); if (def) { searchInput.value = def.termino; handleSearch(); quickDefs.value = ""; } });
    }
    function renderTableOfContents() {
      const tocContainer = document.getElementById('table-of-contents'); tocContainer.innerHTML = '';
      const titulosMap = new Map(data.titulos.map(t => [t.id, { ...t, parrafos: [] }])); data.parrafos.forEach(p => { if (titulosMap.has(p.titulo_id)) { titulosMap.get(p.titulo_id).parrafos.push({ ...p, articulos: data.articulos.filter(a => a.parrafo_id === p.id) }); } });
      titulosMap.forEach(titulo => {
        const titleEl = document.createElement('div');
        titleEl.innerHTML = `<button class="w-full text-left font-semibold p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition" data-target="titulo-${titulo.id}"><i class="fas fa-chevron-right mr-2 toc-icon text-xs"></i> Título ${titulo.numero}: ${titulo.nombre}</button><div id="titulo-${titulo.id}" class="hidden pl-4 space-y-1">${titulo.parrafos.map(parrafo => `<div><button class="w-full text-left p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-xs" data-target="parrafo-${parrafo.id}">${parrafo.numero} ${parrafo.nombre}</button><div id="parrafo-${parrafo.id}" class="hidden pl-4 space-y-1">${parrafo.articulos.map(art => `<a href="#articulo-${art.id}" class="block p-1 hover:bg-emerald-100 dark:hover:bg-emerald-900 rounded text-xs text-gray-600 dark:text-gray-400">Artículo ${art.numero}</a>`).join('')}</div></div>`).join('')}</div>`;
        tocContainer.appendChild(titleEl);
      });
      tocContainer.addEventListener('click', (e) => { 
        const button = e.target.closest('button[data-target]'); 
        if (button) { 
          const targetId = button.dataset.target; 
          const target = document.getElementById(targetId); 
          const icon = button.querySelector('.toc-icon'); 
          target.classList.toggle('hidden'); 
          icon.classList.toggle('fa-chevron-right'); 
          icon.classList.toggle('fa-chevron-down'); 
          
          // NUEVO: Actualizar breadcrumbs cuando se navega por la tabla de contenidos
          if (targetId.startsWith('titulo-')) {
            const tituloId = targetId.replace('titulo-', '');
            const titulo = data.titulos.find(t => t.id == tituloId);
            if (titulo) {
              updateBreadcrumbs([{ name: `Título ${titulo.numero}: ${titulo.nombre}`, active: true }]);
            }
          } else if (targetId.startsWith('parrafo-')) {
            const parrafoId = targetId.replace('parrafo-', '');
            const parrafo = data.parrafos.find(p => p.id == parrafoId);
            if (parrafo) {
              const titulo = data.titulos.find(t => t.id == parrafo.titulo_id);
              if (titulo) {
                updateBreadcrumbs([
                  { name: `Título ${titulo.numero}`, active: false },
                  { name: `${parrafo.numero} ${parrafo.nombre}`, active: true }
                ]);
              }
            }
          }
        } 
      });
    }
    function linkifyCrossReferences(text) {
      const internalLinkRegex = /artículo\s+(\d+[°º]?)/gi; return text.replace(internalLinkRegex, (match, p1) => { const artNum = p1.replace('°', '').replace('º', ''); const article = data.articulos.find(a => a.numero === artNum); if (article) { return `<a href="#articulo-${article.id}" class="text-emerald-600 hover:underline font-semibold">${match}</a>`; } return match; });
    }
    function renderArticles() {
      const articlesContainer = document.getElementById("articles-container"); const resultsCount = document.getElementById("results-count"); const noResults = document.getElementById("no-results"); const exportBtn = document.getElementById("export-pdf");
      articlesContainer.innerHTML = ""; resultsCount.textContent = `${filteredArticles.length} artículo${filteredArticles.length !== 1 ? 's' : ''} encontrado${filteredArticles.length !== 1 ? 's' : ''}`;
      if (filteredArticles.length === 0) { noResults.classList.remove("hidden"); exportBtn.classList.add("hidden"); return; }
      noResults.classList.add("hidden"); exportBtn.classList.remove("hidden");
      filteredArticles.forEach(art => {
        const articleEl = document.createElement("article"); 
        articleEl.className = "bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 fade-in relative card-hover"; 
        articleEl.id = `articulo-${art.id}`;
        const note = getNote(art.id); if (note) articleEl.classList.add('has-note');
        
        // Las etiquetas ahora son botones clicables
        const cats = data.articulos_categorias.filter(ac => ac.articulo_id === art.id).map(ac => data.categorias.find(c => c.id === ac.categoria_id)).map(c => `<button class="filter-by-tag inline-block px-2 py-1 text-xs rounded-full mr-2 mb-1 font-medium" data-category-id="${c.id}" style="background-color: ${c.color}20; color: ${c.color}" title="Filtrar por esta categoría">${c.nombre}</button>`).join("");

        // NUEVO: Procesar el texto para formatear listas
        let processedText = linkifyCrossReferences(art.texto_completo);
        if (currentSearch) { 
          const regex = new RegExp(`(${currentSearch})`, "gi"); 
          processedText = processedText.replace(regex, '<span class="highlight">$1</span>'); 
        }
        
        // NUEVO: Aplicar formato de listas
        processedText = formatListsInText(processedText);
        
        // NUEVO: Si no se detectaron listas, intentar con otro método
        if (!processedText.includes('<ol>') && !processedText.includes('<ul>')) {
          // Intentar con un enfoque alternativo: dividir por puntos y guiones
          processedText = formatListsAlternative(processedText);
        }
        
        articleEl.innerHTML = `<div class="flex justify-between items-start mb-3"><h2 class="text-xl font-bold text-emerald-700 dark:text-emerald-400">Artículo ${art.numero}</h2><div class="flex gap-2"><button class="text-gray-500 hover:text-emerald-600 focus-mode btn-transition" data-id="${art.id}" aria-label="Modo de lectura"><i class="fas fa-expand"></i></button><button class="text-gray-500 hover:text-emerald-600 add-note btn-transition" data-id="${art.id}" aria-label="Añadir nota"><i class="fas fa-sticky-note ${note ? 'text-amber-500' : ''}"></i></button><button class="text-gray-500 hover:text-emerald-600 export-article btn-transition" data-id="${art.id}" aria-label="Exportar artículo"><i class="fas fa-download"></i></button></div></div>${art.nombre ? `<h3 class="text-lg font-semibold mb-2">${art.nombre}</h3>` : ""}<div class="flex flex-wrap gap-1 mb-3">${cats}</div><div class="article-content leading-relaxed text-gray-700 dark:text-gray-300">${processedText}</div>`;
        articlesContainer.appendChild(articleEl);
      });
      
      // NUEVO: Actualizar indicador de filtros activos
      updateActiveFiltersIndicator();
    }

    // =================================================================
    // 5. NUEVO: Función alternativa para formatear listas
    // =================================================================
    function formatListsAlternative(text) {
      // Dividir el texto en líneas
      const lines = text.split('\n');
      let result = [];
      let currentList = [];
      let inList = false;
      let listType = null;
      
      // Patrones para detectar listas
      const orderedPattern = /^\s*\d+\.\s/;
      const unorderedPattern = /^\s*[a-z]\.\s|^\s*[\-\•]\s/;
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        
        if (orderedPattern.test(line)) {
          if (!inList || listType !== 'ol') {
            if (currentList.length > 0) {
              result.push(`<ul>${currentList.join('')}</ul>`);
              currentList = [];
            }
            inList = true;
            listType = 'ol';
          }
          const itemText = line.replace(orderedPattern, '');
          currentList.push(`<li>${itemText}</li>`);
        } else if (unorderedPattern.test(line)) {
          if (!inList || listType !== 'ul') {
            if (currentList.length > 0) {
              result.push(`<ol>${currentList.join('')}</ol>`);
              currentList = [];
            }
            inList = true;
            listType = 'ul';
          }
          const itemText = line.replace(unorderedPattern, '');
          currentList.push(`<li>${itemText}</li>`);
        } else {
          if (inList) {
            result.push(`<${listType}>${currentList.join('')}</${listType}>`);
            currentList = [];
            inList = false;
            listType = null;
          }
          result.push(`<p>${line}</p>`);
        }
      }
      
      // Procesar lo que quede
      if (currentList.length > 0) {
        result.push(`<${listType}>${currentList.join('')}</${listType}>`);
      }
      
      return result.join('');
    }

    // =================================================================
    // 6. MANEJO DE EVENTOS Y LÓGICA DE FILTRADO
    // =================================================================
    function setupEvents() {
      const searchInput = document.getElementById("search-input"); const themeBtn = document.getElementById("theme-toggle"); const exportBtn = document.getElementById("export-pdf"); const articlesContainer = document.getElementById("articles-container");
      const graphViewBtn = document.getElementById("graph-view-btn");
      
      // NUEVO: Eventos para pestañas del sidebar
      document.getElementById('content-tab').addEventListener('click', () => switchTab('content'));
      document.getElementById('filters-tab').addEventListener('click', () => switchTab('filters'));
      
      // NUEVO: Eventos para sidebar móvil
      document.getElementById('sidebar-toggle').addEventListener('click', openSidebar);
      document.getElementById('sidebar-close').addEventListener('click', closeSidebar);
      document.getElementById('sidebar-overlay').addEventListener('click', closeSidebar);
      
      // NUEVO: Evento para limpiar filtros
      document.getElementById('clear-filters').addEventListener('click', clearAllFilters);
      
      // NUEVO: Evento para volver arriba
      document.getElementById('back-to-top').addEventListener('click', scrollToTop);
      
      searchInput.addEventListener("input", debounce(handleSearch, 300)); 
      themeBtn.addEventListener("click", toggleTheme); 
      exportBtn.addEventListener("click", exportCurrentToPDF);
      graphViewBtn.addEventListener("click", openGraphView);

      articlesContainer.addEventListener("click", (e) => {
        const target = e.target.closest('button'); if (!target) return; const artId = target.dataset.id; const article = data.articulos.find(a => a.id == artId);
        if (target.classList.contains('export-article')) { exportArticleToPDF(article, document.getElementById(`articulo-${artId}`)); }
        else if (target.classList.contains('focus-mode')) { openFocusMode(article); }
        else if (target.classList.contains('add-note')) { openNoteMode(article); }
        // Listener para clics en etiquetas
        else if (target.classList.contains('filter-by-tag')) {
          const categoryId = target.dataset.categoryId;
          applySingleFilter(categoryId);
          // NUEVO: Cambiar a la pestaña de filtros para mostrar los resultados
          switchTab('filters');
        }
      });
      const modalOverlay = document.getElementById('modal-overlay'); modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeModal(); });
      const graphModalOverlay = document.getElementById('graph-modal-overlay');
      document.getElementById('close-graph-btn').addEventListener('click', closeGraphView);
      graphModalOverlay.addEventListener('click', (e) => { if (e.target === graphModalOverlay) closeGraphView(); });
      
      // NUEVO: Evento para scroll para mostrar/ocultar botón volver arriba
      window.addEventListener('scroll', handleScroll);
    }
    function handleSearch() { currentSearch = searchInput.value.toLowerCase(); filterArticles(); }
    function filterArticles() {
      let results = data.articulos;
      if (selectedCategories.size > 0) { results = results.filter(art => data.articulos_categorias.some(ac => ac.articulo_id === art.id && selectedCategories.has(ac.categoria_id))); }
      if (currentSearch) { results = results.filter(art => art.texto_completo.toLowerCase().includes(currentSearch) || art.numero.toLowerCase().includes(currentSearch) || (art.nombre && art.nombre.toLowerCase().includes(currentSearch))); }
      filteredArticles = results; renderArticles();
    }

    // =================================================================
    // 7. NUEVO: Lógica para aplicar un filtro único desde una etiqueta
    // =================================================================
    function applySingleFilter(categoryId) {
      // Limpiar otros filtros y búsqueda
      selectedCategories.clear();
      currentSearch = "";
      searchInput.value = "";

      // Aplicar el nuevo filtro
      selectedCategories.add(parseInt(categoryId, 10));

      // Sincronizar UI y filtrar
      updateFilterCheckboxes();
      filterArticles();

      // Scroll hacia arriba para ver los resultados
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function updateFilterCheckboxes() {
      const checkboxes = document.querySelectorAll('#filters input[type="checkbox"]');
      checkboxes.forEach(cb => {
        cb.checked = selectedCategories.has(parseInt(cb.value, 10));
      });
    }

    // =================================================================
    // 8. NUEVO: Funciones para pestañas del sidebar
    // =================================================================
    function switchTab(tabName) {
      // Actualizar pestañas activas
      document.querySelectorAll('.sidebar-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
      
      // Mostrar/ocultar paneles
      document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.add('hidden');
      });
      document.getElementById(`${tabName}-panel`).classList.remove('hidden');
    }

    // =================================================================
    // 9. NUEVO: Funciones para sidebar móvil
    // =================================================================
    function openSidebar() {
      document.getElementById('sidebar').classList.add('open');
      document.getElementById('sidebar-overlay').classList.add('show');
    }

    function closeSidebar() {
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('sidebar-overlay').classList.remove('show');
    }

    // =================================================================
    // 10. NUEVO: Funciones para filtros
    // =================================================================
    function clearAllFilters() {
      selectedCategories.clear();
      currentSearch = "";
      searchInput.value = "";
      updateFilterCheckboxes();
      filterArticles();
    }

    function updateActiveFiltersIndicator() {
      const container = document.getElementById('active-filters-container');
      container.innerHTML = '';
      
      // Añadir filtros de categorías activas
      selectedCategories.forEach(catId => {
        const category = data.categorias.find(c => c.id === catId);
        if (category) {
          const filterEl = document.createElement('div');
          filterEl.className = 'active-filter';
          filterEl.innerHTML = `${category.nombre} <button data-category-id="${catId}"><i class="fas fa-times"></i></button>`;
          filterEl.querySelector('button').addEventListener('click', () => {
            selectedCategories.delete(catId);
            updateFilterCheckboxes();
            filterArticles();
          });
          container.appendChild(filterEl);
        }
      });
      
      // Añadir búsqueda activa
      if (currentSearch) {
        const filterEl = document.createElement('div');
        filterEl.className = 'active-filter';
        filterEl.innerHTML = `Búsqueda: "${currentSearch}" <button data-search="true"><i class="fas fa-times"></i></button>`;
        filterEl.querySelector('button').addEventListener('click', () => {
          currentSearch = "";
          searchInput.value = "";
          filterArticles();
        });
        container.appendChild(filterEl);
      }
    }

    // =================================================================
    // 11. NUEVO: Funciones para botón volver arriba
    // =================================================================
    function handleScroll() {
      const backToTopBtn = document.getElementById('back-to-top');
      if (window.scrollY > 300) {
        backToTopBtn.classList.add('show');
      } else {
        backToTopBtn.classList.remove('show');
      }
    }

    function scrollToTop() {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    }

    // =================================================================
    // 12. NUEVO: Funciones para breadcrumbs
    // =================================================================
    function updateBreadcrumbs(items) {
      const breadcrumbsContainer = document.getElementById('breadcrumbs');
      breadcrumbsContainer.innerHTML = '';
      
      // Siempre añadir el elemento raíz
      const rootItem = document.createElement('span');
      rootItem.className = 'breadcrumb-item';
      rootItem.innerHTML = '<a href="#" class="hover:text-emerald-500">Ley 21.600</a>';
      rootItem.querySelector('a').addEventListener('click', (e) => {
        e.preventDefault();
        updateBreadcrumbs([{ name: 'Ley 21.600', active: true }]);
      });
      breadcrumbsContainer.appendChild(rootItem);
      
      // Añadir elementos adicionales
      items.forEach((item, index) => {
        const breadcrumbItem = document.createElement('span');
        breadcrumbItem.className = `breadcrumb-item ${item.active ? 'active' : ''}`;
        
        if (item.active) {
          breadcrumbItem.textContent = item.name;
        } else {
          breadcrumbItem.innerHTML = `<a href="#" class="hover:text-emerald-500">${item.name}</a>`;
          breadcrumbItem.querySelector('a').addEventListener('click', (e) => {
            e.preventDefault();
            // Navegar al elemento anterior
            const prevItems = items.slice(0, index + 1);
            prevItems[prevItems.length - 1].active = true;
            updateBreadcrumbs(prevItems);
          });
        }
        
        breadcrumbsContainer.appendChild(breadcrumbItem);
      });
    }

    // =================================================================
    // 13. FUNCIONALIDADES EXISTENTES (Modo Focus, Anotaciones, Permalinks)
    // =================================================================
    function openFocusMode(article) {
      // NUEVO: Aplicar formato de listas también en el modal
      let processedText = linkifyCrossReferences(article.texto_completo);
      processedText = formatListsInText(processedText);
      
      // NUEVO: Si no se detectaron listas, intentar con otro método
      if (!processedText.includes('<ol>') && !processedText.includes('<ul>')) {
        processedText = formatListsAlternative(processedText);
      }
      
      const modalContent = document.getElementById('modal-content'); 
      modalContent.innerHTML = `<div class="p-6"><div class="flex justify-between items-center mb-4"><h1 class="text-3xl font-bold">Artículo ${article.numero}</h1><button onclick="closeModal()" class="text-gray-500 hover:text-black dark:hover:text-white text-2xl" aria-label="Cerrar modal">&times;</button></div>${article.nombre ? `<h2 class="text-xl font-semibold mb-4">${article.nombre}</h2>` : ""}<div class="article-content leading-relaxed text-gray-700 dark:text-gray-300">${processedText}</div></div>`; 
      document.getElementById('modal-overlay').classList.remove('hidden');
    }
    function openNoteMode(article) {
      const modalContent = document.getElementById('modal-content'); const currentNote = getNote(article.id); modalContent.innerHTML = `<div class="p-6"><div class="flex justify-between items-center mb-4"><h1 class="text-2xl font-bold">Anotación: Artículo ${article.numero}</h1><button onclick="closeModal()" class="text-gray-500 hover:text-black dark:hover:text-white text-2xl" aria-label="Cerrar modal">&times;</button></div><textarea id="note-textarea" class="w-full h-64 p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600" placeholder="Escribe tu nota aquí...">${currentNote}</textarea><div class="flex justify-end gap-2 mt-4"><button onclick="closeModal()" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded-lg">Cancelar</button><button onclick="saveNoteFromModal(${article.id})" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">Guardar Nota</button></div></div>`; document.getElementById('modal-overlay').classList.remove('hidden');
    }
    function saveNoteFromModal(articleId) { const noteText = document.getElementById('note-textarea').value; saveNote(articleId, noteText); closeModal(); renderArticles(); }
    function saveNote(articleId, noteText) { const notes = JSON.parse(localStorage.getItem('ley21600-notas') || '{}'); if (noteText.trim()) { notes[articleId] = noteText; } else { delete notes[articleId]; } localStorage.setItem('ley21600-notas', JSON.stringify(notes)); }
    function getNote(articleId) { const notes = JSON.parse(localStorage.getItem('ley21600-notas') || '{}'); return notes[articleId] || ''; }
    function closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); document.getElementById('modal-content').innerHTML = ''; }
    function handleHashNavigation() {
      const articleId = window.location.hash.substring(1); if (articleId.startsWith('articulo-')) { const targetElement = document.getElementById(articleId); if (targetElement) { setTimeout(() => { targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); targetElement.classList.add('ring-2', 'ring-emerald-500'); setTimeout(() => targetElement.classList.remove('ring-2', 'ring-emerald-500'), 2000); }, 100); } }
    }
    window.addEventListener('hashchange', handleHashNavigation);

    // =================================================================
    // 14. LÓGICA DE LA VISTA DE RED (Mejorada)
    // =================================================================
    function openGraphView() {
      document.getElementById('graph-modal-overlay').classList.remove('hidden');
      // NUEVO: Mostrar indicador de carga
      document.getElementById('graph-loading').classList.remove('hidden');
      
      // NUEVO: Retrasar la carga para mostrar el indicador
      setTimeout(() => {
        const container = document.getElementById('graph-container');
        const { nodes, edges } = processGraphData();
        const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
        
        const options = {
          nodes: { shape: 'dot', size: 15, font: { size: 14, color: '#333' }, borderWidth: 2, shadow: true },
          edges: { width: 2, color: { inherit: 'from' }, smooth: { type: 'continuous' }, arrows: { to: { enabled: true, scaleFactor: 0.5 } } },
          physics: { forceAtlas2Based: { gravitationalConstant: -26, centralGravity: 0.005, springLength: 230, springConstant: 0.18 }, maxVelocity: 146, solver: 'forceAtlas2Based', timestep: 0.35, stabilization: { iterations: 150 } },
          interaction: { hover: true, tooltipDelay: 200 }
        };

        network = new vis.Network(container, data, options);
        network.on("click", function (params) { if (params.nodes.length > 0) { const nodeId = params.nodes[0]; const nodeData = nodes.find(n => n.id === nodeId); showNodeInfo(nodeData); } });
        
        // NUEVO: Ocultar indicador de carga cuando la red está lista
        network.once("stabilizationIterationsDone", function() {
          document.getElementById('graph-loading').classList.add('hidden');
        });
      }, 100);
    }
    function closeGraphView() {
      document.getElementById('graph-modal-overlay').classList.add('hidden');
      document.getElementById('graph-info-panel').classList.add('hidden');
      if (network) { network.destroy(); network = null; }
    }
    function showNodeInfo(nodeData) {
      const panel = document.getElementById('graph-info-panel'); const titleEl = document.getElementById('graph-info-title'); const contentEl = document.getElementById('graph-info-content');
      titleEl.textContent = nodeData.label;
      if (nodeData.group === 'article') { const article = data.articulos.find(a => a.id === nodeData.articleId); contentEl.innerHTML = `<strong>Artículo ${article.numero}</strong><p class="mt-2">${article.nombre || ''}</p><p class="mt-2 text-xs">${article.texto_completo.substring(0, 200)}...</p>`; }
      else { contentEl.textContent = nodeData.description || 'Entidad mencionada en la ley.'; }
      panel.classList.remove('hidden');
    }

    
    function processGraphData() {
      const nodes = []; const edges = []; const nodeMap = new Map();
      const institutionKeywords = [
            "UNESCO",
            "Servicio de Biodiversidad", 
            "SBAP", 
            "Ministerio del Medio Ambiente", 
            "SAG", 
            "Sernapesca", 
            "CONAF",
            "Ministerio de Agricultura",
            "Ministerio de Economía",
            "Ministerio de Hacienda",
            "Ministerio de Bienes Nacionales",
            "Ministerio de Defensa Nacional",
            "Subsecretaría de Pesca",
            "Subsecretaría de Turismo",
            "Subsecretaría para las Fuerzas Armadas",
            "Servicio Nacional de Pesca y Acuicultura",
            "Corporación Nacional Forestal",
            "Superintendencia del Medio Ambiente",
            "Tribunal Ambiental",
            "Corte Suprema",
            "Corte de Apelaciones",
            "Contraloría General de la República",
            "Consejo de Ministros para la Sustentabilidad",
            "Comité Científico Asesor",
            "Comité Técnico",
            "Dirección Regional",
            "Director Nacional",
            "Director Regional",
            "Guardaparques",
            "Fondo Nacional de la Biodiversidad",
            "Oficina de Autorizaciones Sectoriales",
            "Servicio Agrícola y Ganadero",
            "Subsecretaría de Pesca y Acuicultura",
            "Ministerio de las Culturas, las Artes y el Patrimonio",
            "Ministerio de Desarrollo Social y Familia",
            "Ministerio de Ciencia, Tecnología, Conocimiento e Innovación",
            "Ministerio de Educación",
            "Tesorería General de la República",
            "Conservador de Bienes Raíces",
            "Corporación Nacional de Desarrollo Indígena",
            "Comisión de Desarrollo de Isla de Pascua",
            "Organización Internacional del Trabajo",
            "Unión Internacional para la Conservación de la Naturaleza",
            "UICN",
            "Convenio sobre la Diversidad Biológica",
            "Programa del Hombre y la Biósfera",
            "Red Mundial de Reservas de la Biósfera",
            "Convenio sobre la Conservación de Especies Migratorias",
            "Armada de Chile",
            "Carabineros de Chile",
            "Policía de Investigaciones",
            "Asociación de Guías y Scouts de Chile",
            "Comunidades indígenas",
            "Pueblo Rapa Nui",
            "Organizaciones Representativas de Pueblos Indígenas"
            ];
      const lawKeywords = [
            "ley N° 19.300", 
            "Ley General de Pesca", 
            "Ley sobre Caza", 
            "Ley de Bosque Nativo",
            "Código del Trabajo",
            "ley N° 18.575",
            "ley N° 20.880",
            "ley N° 19.882",
            "ley N° 18.892",
            "ley N° 20.256",
            "ley N° 4.601",
            "ley N° 20.283",
            "ley N° 17.288",
            "ley N° 20.417",
            "ley N° 20.600",
            "ley N° 19.253",
            "ley N° 18.834",
            "decreto ley N° 249",
            "decreto ley N° 1.939",
            "decreto ley N° 1.263",
            "Código de Minería",
            "Ley Marco de Autorizaciones Sectoriales",
            "Ley sobre Pesca Recreativa",
            "Ley sobre Recuperación del Bosque Nativo",
            "Convenio N° 169",
            "Sistema de Alta Dirección Pública",
            "Estatuto Administrativo",
            "Ley de Presupuestos",
            "Tribunales Ambientales",
            "Superintendencia del Medio Ambiente",
            "Consejo de Ministros para la Sustentabilidad"
            ];
      data.articulos.forEach(article => { const nodeId = `art-${article.id}`; nodeMap.set(nodeId, { id: nodeId, label: `Art. ${article.numero}`, group: 'article', articleId: article.id }); });
      data.articulos.forEach(article => {
        const fromNodeId = `art-${article.id}`; const text = article.texto_completo.toLowerCase();
        const articleMentionRegex = /artículo\s+(\d+[°º]?)/gi; let match;
        while ((match = articleMentionRegex.exec(article.texto_completo)) !== null) {
          const mentionedArtNum = match[1].replace('°', '').replace('º', ''); const mentionedArticle = data.articulos.find(a => a.numero === mentionedArtNum);
          if (mentionedArticle) { const toNodeId = `art-${mentionedArticle.id}`; edges.push({ from: fromNodeId, to: toNodeId, label: 'menciona' }); }
        }
        institutionKeywords.forEach(inst => { if (text.includes(inst.toLowerCase())) { const instNodeId = `inst-${inst.replace(/\s+/g, '-')}`; if (!nodeMap.has(instNodeId)) { nodeMap.set(instNodeId, { id: instNodeId, label: inst, group: 'institution', description: `Institución mencionada en la ley.` }); } edges.push({ from: fromNodeId, to: instNodeId, label: 'menciona' }); } });
        lawKeywords.forEach(law => { if (text.includes(law.toLowerCase())) { const lawNodeId = `law-${law.replace(/\s+/g, '-')}`; if (!nodeMap.has(lawNodeId)) { nodeMap.set(lawNodeId, { id: lawNodeId, label: law, group: 'law', description: `Otra norma legal mencionada.` }); } edges.push({ from: fromNodeId, to: lawNodeId, label: 'se relaciona' }); } });
      });
      nodes.push(...Array.from(nodeMap.values())); return { nodes, edges };
    }

    // =================================================================
    // 15. EXPORTACIÓN Y UTILIDADES
    // =================================================================
    function exportCurrentToPDF() { const element = document.querySelector("main"); html2pdf().set({ margin: 1, filename: 'Ley_21600_Resultados.pdf', html2canvas: { scale: 2 } }).from(element).save(); }
    function exportArticleToPDF(art, el) { 
      // NUEVO: Aplicar formato de listas también en la exportación
      const clone = el.cloneNode(true); 
      clone.querySelector(".export-article")?.remove(); 
      clone.querySelector(".focus-mode")?.remove(); 
      clone.querySelector(".add-note")?.remove(); 
      html2pdf().set({ margin: 1, filename: `Articulo_${art.numero.replace(/[^\w]/g, '')}.pdf` }).from(clone).save(); 
    }
    function toggleTheme() { const isDark = document.documentElement.classList.toggle("dark"); localStorage.setItem("dark", isDark); const themeBtn = document.getElementById("theme-toggle"); themeBtn.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>'; }
    function setupTheme() { const isDark = localStorage.getItem("dark") === "true"; document.documentElement.classList.toggle("dark", isDark); const themeBtn = document.getElementById("theme-toggle"); themeBtn.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>'; }
    function debounce(func, wait) { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; }

    // =================================================================
    // 16. INICIALIZACIÓN DE LA APLICACIÓN
    // =================================================================
    async function initializeApp() {
      setupTheme(); const dataLoaded = await loadData(); if (!dataLoaded) { document.getElementById('articles-container').innerHTML = `<p class="text-red-500 text-center">No se pudo cargar el contenido de la ley.</p>`; return; }
      renderFilters(); renderQuickDefinitions(); renderTableOfContents(); renderArticles(); setupEvents(); handleHashNavigation();
    }

    document.addEventListener("DOMContentLoaded", initializeApp);

  </script>
</body>
</html>