<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ley 21.600 - Biodiversidad y Áreas Protegidas</title>
  
  <!-- External Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://unpkg.com/vis-network@latest/styles/dist/vis-network.min.css" rel="stylesheet" type="text/css" />
  <script src="https://unpkg.com/vis-network@latest/standalone/umd/vis-network.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <style>
    /* Base Styles */
    :root {
      --emerald: #10b981;
      --emerald-dark: #059669;
      --gray-800: #1f2937;
      --gray-700: #374151;
      --gray-600: #4b5563;
      --gray-500: #6b7280;
      --gray-400: #9ca3af;
      --gray-300: #d1d5db;
      --amber: #f59e0b;
      --amber-light: #fbbf24;
    }
    
    *:focus { outline: 2px solid var(--emerald); outline-offset: 2px; }
    button:focus, a:focus { outline-offset: 1px; }
    
    body { background-color: #111827; color: #f3f4f6; }
    
    /* Components */
    .highlight { background-color: #451a03; padding: 0.1rem 0.2rem; border-radius: 0.25rem; }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    .has-note { border-left: 4px solid var(--amber); }
    .filter-by-tag { cursor: pointer; transition: all 0.2s ease-in-out; border: 1px solid transparent; }
    .filter-by-tag:hover { transform: scale(1.05); opacity: 0.8; }
    
    .btn-transition { transition: all 0.3s ease; }
    .card-hover { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .card-hover:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    
    /* Sidebar */
    .sidebar-tab { padding: 0.75rem 1rem; border-bottom: 2px solid transparent; font-weight: 500; cursor: pointer; transition: all 0.2s ease; }
    .sidebar-tab.active { border-bottom-color: var(--emerald); color: var(--emerald); }
    .sidebar-tab:hover { background-color: rgba(16, 185, 129, 0.1); }
    
    /* Back to Top Button */
    #back-to-top { position: fixed; bottom: 20px; right: 20px; z-index: 40; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
    #back-to-top.show { opacity: 1; visibility: visible; }
    
    /* Breadcrumbs */
    .breadcrumb-item { display: inline-flex; align-items: center; color: var(--gray-400); }
    .breadcrumb-item:not(:last-child)::after { content: '/'; margin: 0 0.5rem; color: var(--gray-500); }
    .breadcrumb-item.active { color: var(--emerald); font-weight: 500; }
    
    /* Active Filters */
    .active-filters { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; }
    .active-filter { display: inline-flex; align-items: center; padding: 0.25rem 0.5rem; background-color: var(--emerald); color: white; border-radius: 9999px; font-size: 0.75rem; }
    .active-filter button { margin-left: 0.25rem; background: none; border: none; color: white; cursor: pointer; }
    
    /* Mobile Sidebar */
    @media (max-width: 1024px) {
      .sidebar-mobile { position: fixed; top: 0; left: 0; z-index: 50; height: 100vh; width: 80%; max-width: 320px; transform: translateX(-100%); transition: transform 0.3s ease; }
      .sidebar-mobile.open { transform: translateX(0); }
      .sidebar-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 40; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
      .sidebar-overlay.show { opacity: 1; visibility: visible; }
    }
    
    /* Article Content */
    .article-content { line-height: 1.7; }
    .article-content p { margin-bottom: 1rem; }
    .article-content p:last-child { margin-bottom: 0; }
    .article-content ol, .article-content ul { margin: 1rem 0; padding-left: 1.5rem; }
    .article-content ol li, .article-content ul li { margin-bottom: 0.5rem; position: relative; }
    .article-content ol li:last-child, .article-content ul li:last-child { margin-bottom: 0; }
    .article-content ol { list-style-type: decimal; }
    .article-content ul { list-style-type: lower-alpha; }
    
    /* Term Definitions */
    .term-def, .term-def-alt {
      position: relative; cursor: help; text-decoration: underline dotted; 
      text-underline-offset: 2px; font-weight: 500;
    }
    .term-def { text-decoration-color: var(--emerald); }
    .term-def-alt { text-decoration-color: var(--amber); }
    
    .definition-tooltip {
      position: absolute; background-color: rgba(31, 41, 55, 0.95); backdrop-filter: blur(10px);
      border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 0.5rem; padding: 1rem;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.2);
      z-index: 50; max-width: 320px; opacity: 0; visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s, transform 0.2s; transform: translateY(5px);
    }
    .definition-tooltip.alt {
      background-color: rgba(180, 83, 9, 0.95); border: 1px solid rgba(245, 158, 11, 0.5);
    }
    .definition-tooltip.show { opacity: 1; visibility: visible; transform: translateY(0); }
    .definition-tooltip h4 { font-weight: 600; margin-bottom: 0.5rem; color: var(--emerald); font-size: 1rem; }
    .definition-tooltip.alt h4 { color: var(--amber-light); }
    .definition-tooltip p { font-size: 0.875rem; line-height: 1.5; color: #f3f4f6; margin: 0; }
    .definition-tooltip::before {
      content: ''; position: absolute; top: -8px; left: 20px; width: 0; height: 0;
      border-left: 8px solid transparent; border-right: 8px solid transparent;
      border-bottom: 8px solid rgba(31, 41, 55, 0.95);
    }
    .definition-tooltip.alt::before { border-bottom-color: rgba(180, 83, 9, 0.95); }
    
    /* Chatbot */
    #chatbot-toggle {
      position: fixed; bottom: 2rem; right: 2rem; z-index: 45;
      background-color: var(--emerald); color: white; border-radius: 50%;
      width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer; transition: all 0.3s ease;
    }
    #chatbot-toggle:hover { transform: scale(1.1); background-color: var(--emerald-dark); }
    
    #chatbot-modal {
      position: fixed; bottom: 6rem; right: 2rem; width: 90%; max-width: 400px; height: 500px;
      background-color: white; border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      display: none; flex-direction: column; z-index: 50;
    }
    #chatbot-header {
      padding: 1rem; background-color: var(--emerald); color: white;
      border-top-left-radius: 0.75rem; border-top-right-radius: 0.75rem;
      font-weight: bold; display: flex; justify-content: space-between; align-items: center;
    }
    #chat-history {
      flex-grow: 1; padding: 1rem; overflow-y: auto; display: flex;
      flex-direction: column; gap: 0.75rem; background-color: #f9fafb; color: var(--gray-800);
    }
    .chat-message {
      max-width: 80%; padding: 0.75rem 1rem; border-radius: 1.25rem;
      line-height: 1.5; word-wrap: break-word; color: var(--gray-800);
    }
    .chat-message.user {
      background-color: #e5e7eb; align-self: flex-end; border-bottom-right-radius: 0.25rem;
    }
    .chat-message.bot {
      background-color: #f3f4f6; align-self: flex-start; border-bottom-left-radius: 0.25rem;
    }
    .chat-citation-link {
      color: #047857; font-weight: 600; text-decoration: underline;
      transition: color 0.2s ease-in-out;
    }
    .chat-citation-link:hover { color: #065f46; }
    
    #chat-input-area {
      display: flex; padding: 1rem; border-top: 1px solid #e5e7eb;
      background-color: white; color: var(--gray-800);
    }
    #chat-input {
      flex-grow: 1; border: 1px solid #d1d5db; border-radius: 9999px;
      padding: 0.5rem 1rem; margin-right: 0.5rem; color: var(--gray-800);
      background-color: white;
    }
    #chat-input::placeholder { color: var(--gray-500); }
    
    #typing-indicator {
      display: none; align-self: flex-start; padding: 0.75rem 1rem; color: var(--gray-600);
    }
    .typing-indicator-dot {
      display: inline-block; width: 8px; height: 8px; border-radius: 50%;
      background-color: var(--gray-400); animation: typing 1.4s infinite;
    }
    .typing-indicator-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }
    
    /* Explainer Button */
    #explainer-button {
      position: absolute; z-index: 50; background-color: var(--amber-light);
      color: #78350f; border: none; border-radius: 50%;
      width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
      cursor: pointer; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s, background-color 0.2s;
    }
    #explainer-button:hover { transform: scale(1.1); background-color: var(--amber); }
    
    /* Tool Cards */
    .tool-card {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 0.75rem;
      padding: 1.25rem; margin-top: 1.5rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1); transition: transform 0.3s ease, box-shadow 0.3s ease;
      color: white;
    }
    .tool-card:hover {
      transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    }
    .tool-card h3 {
      font-size: 1.1rem; font-weight: 600; margin-bottom: 0.75rem;
      display: flex; align-items: center; color: white;
    }
    .tool-card p {
      font-size: 0.9rem; margin-bottom: 1rem; opacity: 0.9; color: white;
    }
    .tool-card select, .tool-card textarea {
      width: 100%; padding: 0.6rem; border-radius: 0.5rem;
      border: 1px solid rgba(255, 255, 255, 0.2); margin-bottom: 1rem;
      background-color: rgba(255, 255, 255, 0.1); color: white;
      transition: all 0.2s ease;
    }
    .tool-card select::placeholder, .tool-card textarea::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }
    .tool-card select:focus, .tool-card textarea:focus {
      outline: none; border-color: var(--emerald); background-color: rgba(255, 255, 255, 0.15);
    }
    .tool-card button {
      width: 100%; padding: 0.7rem; background: linear-gradient(135deg, var(--emerald) 0%, var(--emerald-dark) 100%);
      color: white; border-radius: 0.5rem; font-weight: 600; border: none;
      cursor: pointer; transition: all 0.2s ease; display: flex;
      align-items: center; justify-content: center; gap: 0.5rem;
    }
    .tool-card button:hover {
      background: linear-gradient(135deg, var(--emerald-dark) 0%, #047857 100%); transform: translateY(-2px);
    }
    .tool-card button:disabled {
      background: linear-gradient(135deg, var(--gray-600) 0%, var(--gray-700) 100%);
      cursor: not-allowed; transform: none;
    }
    .tool-card.scenario-generator {
      background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
    }
    .tool-card.scenario-generator button {
      background: linear-gradient(135deg, #818cf8 0%, #6366f1 100%);
    }
    .tool-card.scenario-generator button:hover {
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
    }
    .tool-card.proactive-detection {
      background: linear-gradient(135deg, #7e22ce 0%, #a855f7 100%);
    }
    .tool-card.proactive-detection button {
      background: linear-gradient(135deg, #c084fc 0%, #a855f7 100%);
    }
    .tool-card.proactive-detection button:hover {
      background: linear-gradient(135deg, #a855f7 0%, #7e22ce 100%);
    }
    
    /* Article Summary */
    .article-summary {
      background-color: #f0f9ff; border-left: 4px solid #0ea5e9;
      padding: 1rem; border-radius: 0.375rem; margin-top: 1rem; color: #0c4a6e;
    }
    .article-summary h3 {
      font-size: 1.125rem; font-weight: 600; color: #0369a1; margin-bottom: 0.5rem;
    }
    .article-summary ul {
      list-style-type: disc; padding-left: 1.5rem; margin: 0; color: #0c4a6e;
    }
    .article-summary li {
      margin-bottom: 0.5rem; color: #0c4a6e;
    }
    
    /* Sidebar Components */
    .filter-group { margin-bottom: 1rem; }
    .filter-group-title {
      font-weight: 600; margin-bottom: 0.5rem; color: var(--gray-300);
      font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em;
    }
    
    .search-container { position: relative; margin-bottom: 1.5rem; }
    .search-container input {
      width: 100%; padding: 0.75rem 1rem 0.75rem 2.75rem; border-radius: 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.2); background-color: rgba(255, 255, 255, 0.1);
      color: white; transition: all 0.3s ease;
    }
    .search-container input::placeholder { color: rgba(255, 255, 255, 0.6); }
    .search-container input:focus {
      outline: none; border-color: var(--emerald); background-color: rgba(255, 255, 255, 0.15);
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
    }
    .search-container i {
      position: absolute; left: 1rem; top: 50%; transform: translateY(-50%);
      color: var(--gray-400);
    }
    
    .sidebar-section { margin-bottom: 1.5rem; }
    .sidebar-section-title {
      font-weight: 600; margin-bottom: 0.75rem; color: var(--gray-300);
      font-size: 1rem; display: flex; align-items: center; justify-content: space-between;
    }
    .clear-filters-btn {
      font-size: 0.75rem; color: var(--emerald); cursor: pointer;
      transition: color 0.2s ease;
    }
    .clear-filters-btn:hover { color: #34d399; }
    
    .tools-section { margin-top: 2rem; }
    .tools-title {
      font-weight: 600; margin-bottom: 1rem; color: var(--gray-300);
      font-size: 1rem; text-align: center; position: relative;
    }
    .tools-title::after {
      content: ''; position: absolute; bottom: -0.5rem; left: 50%;
      transform: translateX(-50%); width: 50px; height: 2px; background-color: var(--emerald);
    }
    
    #filters-panel {
      max-height: calc(100vh - 200px); overflow-y: auto; padding-right: 0.5rem;
    }
    #filters-panel::-webkit-scrollbar { width: 6px; }
    #filters-panel::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1); border-radius: 3px;
    }
    #filters-panel::-webkit-scrollbar-thumb {
      background: rgba(16, 185, 129, 0.5); border-radius: 3px;
    }
    #filters-panel::-webkit-scrollbar-thumb:hover {
      background: rgba(16, 185, 129, 0.7);
    }
    
    /* Semantic Search */
    .semantic-examples {
      display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem;
    }
    .semantic-example {
      background-color: rgba(99, 102, 241, 0.2); color: #a5b4fc;
      border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 9999px;
      padding: 0.25rem 0.75rem; font-size: 0.75rem; cursor: pointer;
      transition: all 0.2s ease;
    }
    .semantic-example:hover {
      background-color: rgba(99, 102, 241, 0.3); transform: translateY(-1px);
    }
    
    /* API Response Modal */
    .api-response-container {
      max-height: 60vh;
      overflow-y: auto;
      padding: 1rem;
      background-color: #f9fafb;
      border-radius: 0.5rem;
      border: 1px solid #e5e7eb;
    }
    
    .api-response-container h1, .api-response-container h2, .api-response-container h3 {
      color: #4f46e5;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
    }
    
    .api-response-container ul {
      list-style-type: disc;
      padding-left: 1.5rem;
      margin-bottom: 1rem;
    }
    
    .api-response-container li {
      margin-bottom: 0.5rem;
    }
    
    .api-response-container strong {
      color: #4f46e5;
    }
    
    .api-response-container p {
      margin-bottom: 1rem;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100">
  <!-- Header -->
  <header class="bg-emerald-800 text-white shadow-lg sticky top-0 z-40">
    <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
      <div class="flex items-center w-full sm:w-auto">
        <button id="sidebar-toggle" class="mr-3 p-2 rounded-lg hover:bg-emerald-700 transition lg:hidden" aria-label="Abrir menú">
          <i class="fas fa-bars"></i>
        </button>
        <h1 class="text-xl sm:text-2xl font-bold flex items-center gap-2">
          <i class="fas fa-leaf"></i> Ley 21.600
        </h1>
      </div>
      <div class="flex items-center gap-4 mt-2 sm:mt-0">
        <a href="graph27.html" class="p-2 rounded-lg hover:bg-emerald-700 transition btn-transition" aria-label="Vista de Red" title="Mapa conceptual relacional">
          <i class="fas fa-sitemap"></i>
        </a>
        <button id="export-pdf" class="px-4 py-2 bg-white text-emerald-700 rounded-lg font-medium hover:bg-gray-100 transition btn-transition hidden">
          <i class="fas fa-file-pdf"></i> PDF
        </button>
      </div>
    </div>
    <div class="bg-emerald-700 px-4 py-2 text-sm">
      <div class="container mx-auto">
        <nav id="breadcrumbs" aria-label="Navegación">
          <span class="breadcrumb-item active">Ley 21.600</span>
        </nav>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div id="sidebar-overlay" class="sidebar-overlay lg:hidden"></div>
  <div class="container mx-auto px-4 py-6 flex flex-col lg:flex-row gap-6">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar-mobile lg:static lg:w-80 bg-gray-800 rounded-xl shadow-md p-5 space-y-6 h-fit lg:sticky lg:top-24 z-50">
      <div class="flex justify-between items-center lg:hidden mb-4">
        <h2 class="text-lg font-semibold">Navegación</h2>
        <button id="sidebar-close" class="p-2 rounded-lg hover:bg-gray-700 transition" aria-label="Cerrar menú">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <!-- Sidebar Tabs -->
      <div class="flex border-b border-gray-700 mb-4">
        <button id="content-tab" class="sidebar-tab active flex-1 text-center" data-tab="content">
          <i class="fas fa-list mr-2"></i> Contenido
        </button>
        <button id="filters-tab" class="sidebar-tab flex-1 text-center" data-tab="filters">
          <i class="fas fa-filter mr-2"></i> Filtros
        </button>
        <button id="semantic-tab" class="sidebar-tab flex-1 text-center" data-tab="semantic">
          <i class="fas fa-brain mr-2"></i> Semántica
        </button>
      </div>
      
      <!-- Content Panel -->
      <div id="content-panel" class="tab-panel">
        <h3 class="font-semibold mb-3">Tabla de Contenidos</h3>
        <nav id="table-of-contents" class="space-y-1 text-sm max-h-96 overflow-y-auto pr-2"></nav>
      </div>
      
      <!-- Filters Panel -->
      <div id="filters-panel" class="tab-panel hidden">
        <div class="sidebar-section">
          <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" id="search-input" placeholder="Buscar en la ley..." />
          </div>
        </div>
        
        <div class="sidebar-section">
          <div class="sidebar-section-title">
            <span>Filtrar por categoría</span>
            <span id="clear-filters" class="clear-filters-btn">Limpiar</span>
          </div>
          <div id="filters" class="space-y-3 pr-2"></div>
          <div id="active-filters-container" class="active-filters"></div>
        </div>
        
        <div class="tools-section">
          <h3 class="tools-title">Herramientas Inteligentes</h3>
          
          <!-- Scenario Generator -->
          <div class="tool-card scenario-generator">
            <h3><i class="fas fa-magic mr-2"></i>Generador de Casos Prácticos</h3>
            <p>Explora cómo la ley se aplica en situaciones reales.</p>
            <select id="scenario-topic" class="w-full p-2 border rounded-lg dark:bg-gray-700 mb-2 text-white bg-gray-800 border-gray-600">
              <option value="">Selecciona un tema...</option>
              <option value="turismo">Turismo en un Sitio Prioritario</option>
              <option value="investigacion">Investigación Científica</option>
              <option value="proyecto-inmobiliario">Proyecto Inmobiliario</option>
            </select>
            <button id="generate-scenario-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition font-medium disabled:bg-gray-400" disabled>
              <i class="fas fa-magic mr-2"></i>Generar Escenario
            </button>
          </div>
          
          <!-- Proactive Detection -->
          <div class="tool-card proactive-detection">
            <h3><i class="fas fa-search mr-2"></i>Detección Proactiva de Obligaciones</h3>
            <p>Describe tu proyecto y descubre tus obligaciones y derechos.</p>
            <textarea id="proactive-input" rows="3" class="w-full p-2 border rounded-lg dark:bg-gray-700 mb-2 text-white bg-gray-800 border-gray-600" placeholder="Ej: Soy un científico que quiere monitorear una especie de anfibio en un humedal."></textarea>
            <button id="analyze-proactive-btn" class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition font-medium">
              <i class="fas fa-search mr-2"></i>Analizar
            </button>
          </div>
        </div>
      </div>
      
      <!-- Semantic Panel -->
      <div id="semantic-panel" class="tab-panel hidden">
        <div class="sidebar-section">
          <div class="search-container">
            <i class="fas fa-brain"></i>
            <input type="text" id="semantic-search-input" placeholder="Buscar por conceptos relacionados..." />
          </div>
          <div class="semantic-examples">
            <span class="semantic-example" data-term="salmon">Salmón</span>
            <span class="semantic-example" data-term="dañado">Áreas dañadas</span>
            <span class="semantic-example" data-term="especie invasora">Especies invasoras</span>
            <span class="semantic-example" data-term="humedal">Humedales</span>
            <span class="semantic-example" data-term="parque nacional">Parques nacionales</span>
          </div>
          <div id="semantic-results-info" class="mt-3 text-sm text-gray-400"></div>
        </div>
      </div>
    </aside>
    
    <!-- Main Content Area -->
    <main class="flex-1 space-y-6">
      <div id="results-count" class="text-sm text-gray-400" aria-live="polite"></div>
      <div id="articles-container" class="space-y-6"></div>
      <div id="no-results" class="hidden text-center py-12 text-gray-500">
        <i class="fas fa-search text-4xl mb-4"></i>
        <p>No se encontraron resultados.</p>
      </div>
    </main>
  </div>

  <!-- Back to Top Button -->
  <button id="back-to-top" class="bg-emerald-600 text-white p-3 rounded-full shadow-lg btn-transition" aria-label="Volver arriba">
    <i class="fas fa-arrow-up"></i>
  </button>

  <!-- Modal Overlay -->
  <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div id="modal-content" class="bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto"></div>
  </div>

  <!-- Definition Tooltip -->
  <div id="definition-tooltip" class="definition-tooltip">
    <h4 id="tooltip-term"></h4>
    <p id="tooltip-definition"></p>
  </div>

  <!-- Explainer Button -->
  <button id="explainer-button" class="hidden" aria-label="Explicar en lenguaje sencillo">
    <i class="fas fa-lightbulb"></i>
  </button>

  <!-- Chatbot -->
  <button id="chatbot-toggle" aria-label="Abrir Asistente Legal IA">
    <i class="fas fa-comments text-2xl"></i>
  </button>
  
  <div id="chatbot-modal">
    <div id="chatbot-header">
      <span><i class="fas fa-robot mr-2"></i>Asistente Legal IA</span>
      <button id="close-chatbot" aria-label="Cerrar chat"><i class="fas fa-times"></i></button>
    </div>
    <div id="chat-history">
      <div class="chat-message bot">
        ¡Hola! Soy tu asistente para la Ley 21.600. Pregúntame lo que necesites en lenguaje sencillo. Ej: "¿Qué pasa si introduzco una especie invasora?"
      </div>
      <div id="typing-indicator">
        <span class="typing-indicator-dot"></span>
        <span class="typing-indicator-dot"></span>
        <span class="typing-indicator-dot"></span>
      </div>
    </div>
    <div id="chat-input-area">
      <input type="text" id="chat-input" placeholder="Escribe tu pregunta aquí..." autocomplete="off">
      <button id="send-message" class="bg-emerald-600 text-white px-4 py-2 rounded-full hover:bg-emerald-700 transition">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>

  <!-- External Scripts -->
  <script src="base.js"></script>
  <script src="pass.js"></script>
  
  <script>
    // Global Variables
    let data;
    let filteredArticles = [];
    let selectedCategories = new Set();
    let currentSearch = "";
    let glossaryData = {};
    let glossaryAltData = {};
    let plainLanguageExplanations = {};
    let articleSummaries = {};
    let lastSemanticSearch = "";
    
    // Initialize App
    async function initializeApp() {
      const dataLoaded = await loadData();
      if (!dataLoaded) {
        document.getElementById('articles-container').innerHTML = `<p class="text-red-500 text-center">No se pudo cargar el contenido de la ley.</p>`;
        return;
      }
      
      renderFilters();
      renderTableOfContents();
      renderArticles();
      setupEvents();
      handleHashNavigation();
      setupChatbot();
      setupScenarioGenerator();
      setupProactiveDetection();
      
      // Setup search inputs
      const searchInput = document.getElementById("search-input");
      searchInput.addEventListener("input", debounce(handleSearch, 300));
      
      const semanticSearchInput = document.getElementById("semantic-search-input");
      semanticSearchInput.addEventListener("input", debounce(handleSemanticSearch, 300));
    }
    
    // Load Data
    async function loadData() {
      try { 
        data = mockDataResponse; 
        filteredArticles = [...data.articulos];
        
        // Load definitions
        data.definiciones.forEach(def => {
          glossaryData[def.termino.toLowerCase()] = { definition: def.definicion, contextualLinks: [] };
        });
        
        if (glossaryData['restauración']) {
          glossaryData['restauración'].contextualLinks.push({ text: 'Ver Planes de restauración ecológica (Art. 33)', articleId: 33 });
        }
        
        if (glossaryData['uso sustentable']) {
          glossaryData['uso sustentable'].contextualLinks.push({ text: 'Ver Objeto de la ley (Art. 1)', articleId: 1 });
        }
        
        // Load alternative definitions
        if (data.definicionesAlt) {
          data.definicionesAlt.forEach(def => {
            glossaryAltData[def.termino.toLowerCase()] = { definition: def.definicion, contextualLinks: [] };
          });
        }
        
        // Load plain language explanations
        plainLanguageExplanations = {
          "no se incluyen dentro del objeto la sanidad vegetal y animal ni la prevención y combate de incendios forestales, materias que se rigen por las respectivas normas legales.": "En pocas palabras, esta ley se enfoca en proteger la naturaleza en su conjunto (biodiversidad y patrimonio natural), pero temas muy específicos como las enfermedades de las plantas o los incendios forestales tienen sus propias reglas en otras leyes. Aunque, claro, cualquier acción sobre esos temas debe siempre considerar y proteger la biodiversidad.",
          "el servicio será funcionalmente descentralizado": "Esto significa que el Servicio no tomará todas las decisiones desde un único lugar central (como Santiago). En cambio, tendrá oficinas y equipos en diferentes regiones del país, con autonomía para adaptar las acciones a las realidades locales de cada zona. Es como tener varias 'sedes' inteligentes en todo el territorio.",
          "principio de jerarquía: los impactos significativos sobre la biodiversidad deberán ser evitados, mitigados, reparados y, en último término, compensados.": "Imagina una escalera de acciones. La mejor opción, en la cima, es **evitar** el daño por completo. Si no se puede evitar, el siguiente paso es **mitigarlo**, es decir, reducir su gravedad. Si el daño ya ocurrió, hay que **repararlo** (restaurar el área). Y como último recurso, si nada de lo anterior es posible, se debe **compensar**, es decir, crear un beneficio ambiental en otro lugar para equilibrar el daño causado."
        };
        
        // Load article summaries
        articleSummaries = data.articleSummaries;
        
        return true; 
      }
      catch (error) { 
        console.error("Error al cargar los datos:", error); 
        return false; 
      }
    }
    
    // Render Functions
    function renderFilters() {
      const filtersContainer = document.getElementById("filters");
      filtersContainer.innerHTML = '';
      
      const groupedCategories = data.categorias.reduce((acc, cat) => {
        if (!acc[cat.grupo]) {
          acc[cat.grupo] = [];
        }
        acc[cat.grupo].push(cat);
        return acc;
      }, {});
      
      for (const groupName in groupedCategories) {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'filter-group';
        
        const titleDiv = document.createElement('div');
        titleDiv.className = 'filter-group-title';
        titleDiv.textContent = groupName;
        groupDiv.appendChild(titleDiv);
        
        groupedCategories[groupName].forEach(cat => {
          const label = document.createElement("label");
          label.className = "flex items-center gap-2 cursor-pointer text-sm ml-2";
          label.innerHTML = `
            <input type="checkbox" value="${cat.id}" class="rounded text-emerald-600 focus:ring-emerald-500">
            <span class="px-2 py-1 rounded-full text-xs font-medium" style="background-color: ${cat.color}20; color: ${cat.color}">${cat.nombre}</span>
          `;
          
          label.querySelector("input").addEventListener("change", (e) => {
            if (e.target.checked) {
              selectedCategories.add(cat.id);
            } else {
              selectedCategories.delete(cat.id);
            }
            filterArticles();
          });
          
          groupDiv.appendChild(label);
        });
        
        filtersContainer.appendChild(groupDiv);
      }
    }
    
    function renderTableOfContents() {
      const tocContainer = document.getElementById('table-of-contents');
      tocContainer.innerHTML = '';
      
      const titulosMap = new Map();
      data.titulos.forEach(t => {
        titulosMap.set(t.id, { ...t, parrafos: [] });
      });
      
      data.parrafos.forEach(p => {
        if (titulosMap.has(p.titulo_id)) {
          titulosMap.get(p.titulo_id).parrafos.push({
            ...p,
            articulos: data.articulos.filter(a => a.parrafo_id === p.id)
          });
        }
      });
      
      titulosMap.forEach(titulo => {
        const titleEl = document.createElement('div');
        titleEl.innerHTML = `
          <button class="w-full text-left font-semibold p-2 hover:bg-gray-700 rounded transition" data-target="titulo-${titulo.id}">
            <i class="fas fa-chevron-right mr-2 toc-icon text-xs"></i> Título ${titulo.numero}: ${titulo.nombre}
          </button>
          <div id="titulo-${titulo.id}" class="hidden pl-4 space-y-1">
            ${titulo.parrafos.map(parrafo => `
              <div>
                <button class="w-full text-left p-1 hover:bg-gray-700 rounded text-xs" data-target="parrafo-${parrafo.id}">
                  ${parrafo.numero} ${parrafo.nombre}
                </button>
                <div id="parrafo-${parrafo.id}" class="hidden pl-4 space-y-1">
                  ${parrafo.articulos.map(art => `
                    <a href="#articulo-${art.id}" class="block p-1 hover:bg-emerald-900 rounded text-xs text-gray-400">
                      Artículo ${art.numero}
                    </a>
                  `).join('')}
                </div>
              </div>
            `).join('')}
          </div>
        `;
        
        tocContainer.appendChild(titleEl);
      });
      
      tocContainer.addEventListener('click', (e) => {
        const button = e.target.closest('button[data-target]');
        if (button) {
          const targetId = button.dataset.target;
          const target = document.getElementById(targetId);
          const icon = button.querySelector('.toc-icon');
          
          target.classList.toggle('hidden');
          icon.classList.toggle('fa-chevron-right');
          icon.classList.toggle('fa-chevron-down');
          
          if (targetId.startsWith('titulo-')) {
            const tituloId = targetId.replace('titulo-', '');
            const titulo = data.titulos.find(t => t.id == tituloId);
            if (titulo) {
              updateBreadcrumbs([{ name: `Título ${titulo.numero}: ${titulo.nombre}`, active: true }]);
            }
          } else if (targetId.startsWith('parrafo-')) {
            const parrafoId = targetId.replace('parrafo-', '');
            const parrafo = data.parrafos.find(p => p.id == parrafoId);
            if (parrafo) {
              const titulo = data.titulos.find(t => t.id == parrafo.titulo_id);
              if (titulo) {
                updateBreadcrumbs([
                  { name: `Título ${titulo.numero}`, active: false },
                  { name: `${parrafo.numero} ${parrafo.nombre}`, active: true }
                ]);
              }
            }
          }
        }
      });
    }
    
    function renderArticles(explanation = "") {
      const articlesContainer = document.getElementById("articles-container");
      const resultsCount = document.getElementById("results-count");
      const noResults = document.getElementById("no-results");
      const exportBtn = document.getElementById("export-pdf");
      
      articlesContainer.innerHTML = "";
      
      // Show explanation if exists
      if (explanation) {
        resultsCount.innerHTML = `<div class="mb-3 p-3 bg-indigo-900/30 border-l-4 border-indigo-500 rounded-r text-sm">${explanation}</div>`;
      } else {
        resultsCount.innerHTML = `${filteredArticles.length} artículo${filteredArticles.length !== 1 ? 's' : ''} encontrado${filteredArticles.length !== 1 ? 's' : ''}`;
      }
      
      if (filteredArticles.length === 0) {
        noResults.classList.remove("hidden");
        exportBtn.classList.add("hidden");
        return;
      }
      
      noResults.classList.add("hidden");
      exportBtn.classList.remove("hidden");
      
      filteredArticles.forEach(art => {
        const articleEl = document.createElement("article");
        articleEl.className = "bg-gray-800 rounded-xl shadow-md p-6 fade-in relative card-hover";
        articleEl.id = `articulo-${art.id}`;
        
        const note = getNote(art.id);
        if (note) articleEl.classList.add('has-note');
        
        const cats = data.articulos_categorias
          .filter(ac => ac.articulo_id === art.id)
          .map(ac => data.categorias.find(c => c.id === ac.categoria_id))
          .map(c => `
            <button class="filter-by-tag inline-block px-2 py-1 text-xs rounded-full mr-2 mb-1 font-medium" 
                    data-category-id="${c.id}" 
                    style="background-color: ${c.color}20; color: ${c.color}" 
                    title="Filtrar por esta categoría">
              ${c.nombre}
            </button>
          `).join("");
        
        let processedText = linkifyCrossReferences(art.texto_completo);
        
        if (currentSearch) {
          const regex = new RegExp(`(${currentSearch})`, "gi");
          processedText = processedText.replace(regex, '<span class="highlight">$1</span>');
        }
        
        processedText = formatListsInText(processedText);
        if (!processedText.includes('<ol>') && !processedText.includes('<ul>')) {
          processedText = formatListsAlternative(processedText);
        }
        
        processedText = highlightDefinedTerms(processedText);
        
        articleEl.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <h2 class="text-xl font-bold text-emerald-400">Artículo ${art.numero}</h2>
            <div class="flex gap-2">
              <button class="text-gray-400 hover:text-emerald-300 focus-mode btn-transition" data-id="${art.id}" aria-label="Modo de lectura">
                <i class="fas fa-expand"></i>
              </button>
              <button class="text-gray-400 hover:text-emerald-300 add-note btn-transition" data-id="${art.id}" aria-label="Añadir nota">
                <i class="fas fa-sticky-note ${note ? 'text-amber-500' : ''}"></i>
              </button>
              <button class="text-gray-400 hover:text-emerald-300 summarize-article btn-transition" data-id="${art.id}" aria-label="Resumir artículo">
                <i class="fas fa-list-ul"></i>
              </button>
              <button class="text-gray-400 hover:text-emerald-300 export-article btn-transition" data-id="${art.id}" aria-label="Exportar artículo">
                <i class="fas fa-download"></i>
              </button>
            </div>
          </div>
          ${art.nombre ? `<h3 class="text-lg font-semibold mb-2">${art.nombre}</h3>` : ""}
          <div class="flex flex-wrap gap-1 mb-3">${cats}</div>
          <div class="article-content leading-relaxed text-gray-300">${processedText}</div>
        `;
        
        articlesContainer.appendChild(articleEl);
      });
      
      updateActiveFiltersIndicator();
      setupDefinitionTooltips();
    }
    
    // Text Processing Functions
    function linkifyCrossReferences(text) {
      const internalLinkRegex = /artículo\s+(\d+[°º]?)/gi;
      return text.replace(internalLinkRegex, (match, p1) => {
        const artNum = p1.replace('°', '').replace('º', '');
        const article = data.articulos.find(a => a.numero === artNum);
        if (article) {
          return `<a href="#articulo-${article.id}" class="text-emerald-400 hover:underline font-semibold">${match}</a>`;
        }
        return match;
      });
    }
    
    function formatListsInText(text) {
      if (text.includes("<ol>") || text.includes("<ul>") || text.includes("<li>")) {
        return text;
      }
      
      let formattedText = text;
      const orderedListPattern = /\b(\d+)\)\s+([^a-z]\w*[^:]*?:.*?)(?=\s+\d+\)|$)/g;
      const unorderedListPattern = /\b([a-z])\)\s+(.*?)(?=\s+[a-z]\)|$)/gi;
      
      const hasOrderedList = /\b\d+\)\s+/.test(formattedText);
      const hasUnorderedList = /\b[a-z]\)\s+/i.test(formattedText);
      
      if (hasOrderedList) {
        formattedText = formattedText.replace(orderedListPattern, (match, num, content) => {
          return `<li>${content.trim()}</li>`;
        });
        formattedText = `<ol>${formattedText}</ol>`;
      } else if (hasUnorderedList) {
        formattedText = formattedText.replace(unorderedListPattern, (match, letter, content) => {
          return `<li>${content.trim()}</li>`;
        });
        formattedText = `<ul>${formattedText}</ul>`;
      }
      
      return formattedText;
    }
    
    function formatListsAlternative(text) {
      const lines = text.split('\n');
      let result = [];
      let currentList = [];
      let inList = false;
      let listType = null;
      
      const orderedPattern = /^\s*\d+\.\s/;
      const unorderedPattern = /^\s*[a-z]\.\s|^\s*[\-\•]\s/;
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        
        if (orderedPattern.test(line)) {
          if (!inList || listType !== 'ol') {
            if (currentList.length > 0) {
              result.push(`<ul>${currentList.join('')}</ul>`);
              currentList = [];
            }
            inList = true;
            listType = 'ol';
          }
          const itemText = line.replace(orderedPattern, '');
          currentList.push(`<li>${itemText}</li>`);
        } else if (unorderedPattern.test(line)) {
          if (!inList || listType !== 'ul') {
            if (currentList.length > 0) {
              result.push(`<ol>${currentList.join('')}</ol>`);
              currentList = [];
            }
            inList = true;
            listType = 'ul';
          }
          const itemText = line.replace(unorderedPattern, '');
          currentList.push(`<li>${itemText}</li>`);
        } else {
          if (inList) {
            result.push(`<${listType}>${currentList.join('')}</${listType}>`);
            currentList = [];
            inList = false;
            listType = null;
          }
          result.push(`<p>${line}</p>`);
        }
      }
      
      if (currentList.length > 0) {
        result.push(`<${listType}>${currentList.join('')}</${listType}>`);
      }
      
      return result.join('');
    }
    
    function highlightDefinedTerms(text) {
      if (!data || !data.definiciones || data.definiciones.length === 0) {
        return text;
      }
      
      let processedText = text;
      
      // Process normal definitions
      const sortedDefs = [...data.definiciones].sort((a, b) => b.termino.length - a.termino.length);
      sortedDefs.forEach(def => {
        const escapedTerm = def.termino.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`\\b${escapedTerm}\\b`, 'gi');
        processedText = processedText.replace(regex, (match) => {
          return `<span class="term-def" data-term-id="${def.id}">${match}</span>`;
        });
      });
      
      // Process alternative definitions
      if (data.definicionesAlt && data.definicionesAlt.length > 0) {
        const sortedDefsAlt = [...data.definicionesAlt].sort((a, b) => b.termino.length - a.termino.length);
        sortedDefsAlt.forEach(def => {
          const escapedTerm = def.termino.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const regex = new RegExp(`\\b${escapedTerm}\\b`, 'gi');
          processedText = processedText.replace(regex, (match) => {
            return `<span class="term-def-alt" data-term-alt-id="${def.id}">${match}</span>`;
          });
        });
      }
      
      return processedText;
    }
    
    // Event Handlers
    function setupEvents() {
      const exportBtn = document.getElementById("export-pdf");
      const articlesContainer = document.getElementById("articles-container");
      
      // Tab switching
      document.getElementById('content-tab').addEventListener('click', () => switchTab('content'));
      document.getElementById('filters-tab').addEventListener('click', () => switchTab('filters'));
      document.getElementById('semantic-tab').addEventListener('click', () => switchTab('semantic'));
      
      // Sidebar controls
      document.getElementById('sidebar-toggle').addEventListener('click', openSidebar);
      document.getElementById('sidebar-close').addEventListener('click', closeSidebar);
      document.getElementById('sidebar-overlay').addEventListener('click', closeSidebar);
      
      // Filter controls
      document.getElementById('clear-filters').addEventListener('click', clearAllFilters);
      
      // Back to top
      document.getElementById('back-to-top').addEventListener('click', scrollToTop);
      
      // Export
      exportBtn.addEventListener("click", exportCurrentToPDF);
      
      // Article actions
      articlesContainer.addEventListener("click", (e) => {
        const target = e.target.closest('button');
        if (!target) return;
        
        const artId = target.dataset.id;
        const article = data.articulos.find(a => a.id == artId);
        
        if (target.classList.contains('export-article')) {
          exportArticleToPDF(article, document.getElementById(`articulo-${artId}`));
        } else if (target.classList.contains('focus-mode')) {
          openFocusMode(article);
        } else if (target.classList.contains('add-note')) {
          openNoteMode(article);
        } else if (target.classList.contains('summarize-article')) {
          showArticleSummary(artId);
        } else if (target.classList.contains('filter-by-tag')) {
          const categoryId = target.dataset.categoryId;
          applySingleFilter(categoryId);
          switchTab('filters');
        }
      });
      
      // Semantic examples
      document.querySelectorAll('.semantic-example').forEach(example => {
        example.addEventListener('click', () => {
          const term = example.dataset.term;
          document.getElementById('semantic-search-input').value = term;
          handleSemanticSearch();
        });
      });
      
      // Modal
      const modalOverlay = document.getElementById('modal-overlay');
      modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) closeModal();
      });
      
      // Scroll events
      window.addEventListener('scroll', handleScroll);
      
      // Text selection
      articlesContainer.addEventListener('mouseup', handleTextSelection);
      document.addEventListener('mouseup', hideExplainerButtonIfOutside);
      document.getElementById('explainer-button').addEventListener('click', handleExplainRequest);
    }
    
    // Search and Filter Functions
    function handleSearch() {
      const searchInput = document.getElementById("search-input");
      currentSearch = searchInput.value.toLowerCase().trim();
      
      let explanation = "";
      let semanticMatch = null;
      
      for (const query in semanticMap) {
        if (currentSearch.includes(query)) {
          semanticMatch = semanticMap[query];
          break;
        }
      }
      
      if (semanticMatch) {
        explanation = semanticMatch.explanation;
        if (semanticMatch.articleIds && semanticMatch.articleIds.length > 0) {
          filteredArticles = data.articulos.filter(art => semanticMatch.articleIds.includes(art.id));
        } else if (semanticMap.keywords && semanticMap.keywords.length > 0) {
          filteredArticles = data.articulos.filter(art => 
            semanticMap.keywords.some(kw => art.texto_completo.toLowerCase().includes(kw))
          );
        }
      } else {
        filterArticles();
      }
      
      renderArticles(explanation);
    }
    
    function filterArticles() {
      let results = data.articulos;
      
      // Filter by categories (if any selected) - using AND
      if (selectedCategories.size > 0) {
        results = results.filter(art => {
          const articleCategories = data.articulos_categorias
            .filter(ac => ac.articulo_id === art.id)
            .map(ac => ac.categoria_id);
          // Check that the article has ALL selected categories
          return Array.from(selectedCategories).every(catId => articleCategories.includes(catId));
        });
      }
      
      // Filter by search (if there's text)
      if (currentSearch) {
        results = results.filter(art => 
          art.texto_completo.toLowerCase().includes(currentSearch) || 
          art.numero.toLowerCase().includes(currentSearch) || 
          (art.nombre && art.nombre.toLowerCase().includes(currentSearch))
        );
      }
      
      filteredArticles = results;
      renderArticles();
    }
    
    function handleSemanticSearch() {
      const semanticInput = document.getElementById("semantic-search-input");
      const searchTerm = semanticInput.value.toLowerCase().trim();
      lastSemanticSearch = searchTerm;
      
      let explanation = "";
      let matchedConcept = null;
      
      // Search in semanticMap for the search term
      for (const concept in semanticMap) {
        if (searchTerm.includes(concept) || semanticMap[concept].keywords.some(kw => kw.includes(searchTerm))) {
          matchedConcept = semanticMap[concept];
          break;
        }
      }
      
      if (matchedConcept) {
        explanation = matchedConcept.explanation;
        // If the concept has articleIds, filter by those articles
        if (matchedConcept.articleIds && matchedConcept.articleIds.length > 0) {
          filteredArticles = data.articulos.filter(art => matchedConcept.articleIds.includes(art.id));
        } else if (matchedConcept.keywords && matchedConcept.keywords.length > 0) {
          // If not, search by keywords in article text
          filteredArticles = data.articulos.filter(art => 
            matchedConcept.keywords.some(kw => art.texto_completo.toLowerCase().includes(kw))
          );
        }
      } else {
        // If no specific concept is found, search by term in articles
        filteredArticles = data.articulos.filter(art => 
          art.texto_completo.toLowerCase().includes(searchTerm) || 
          art.numero.toLowerCase().includes(searchTerm) || 
          (art.nombre && art.nombre.toLowerCase().includes(searchTerm))
        );
        explanation = `No se encontró un concepto específico. Mostrando resultados para "${searchTerm}".`;
      }
      
      renderArticles(explanation);
    }
    
    function applySingleFilter(categoryId) {
      selectedCategories.clear();
      currentSearch = "";
      document.getElementById("search-input").value = "";
      selectedCategories.add(parseInt(categoryId, 10));
      updateFilterCheckboxes();
      filterArticles();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    function updateFilterCheckboxes() {
      const checkboxes = document.querySelectorAll('#filters input[type="checkbox"]');
      checkboxes.forEach(cb => {
        cb.checked = selectedCategories.has(parseInt(cb.value, 10));
      });
    }
    
    function switchTab(tabName) {
      document.querySelectorAll('.sidebar-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
      
      document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.add('hidden');
      });
      document.getElementById(`${tabName}-panel`).classList.remove('hidden');
      
      // Execute corresponding search based on tab
      if (tabName === 'content') {
        filteredArticles = [...data.articulos];
        renderArticles();
      } else if (tabName === 'filters') {
        filterArticles();
      } else if (tabName === 'semantic') {
        if (lastSemanticSearch) {
          handleSemanticSearch();
        } else {
          filteredArticles = [...data.articulos];
          renderArticles();
        }
      }
    }
    
    function openSidebar() {
      document.getElementById('sidebar').classList.add('open');
      document.getElementById('sidebar-overlay').classList.add('show');
    }
    
    function closeSidebar() {
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('sidebar-overlay').classList.remove('show');
    }
    
    function clearAllFilters() {
      selectedCategories.clear();
      currentSearch = "";
      document.getElementById("search-input").value = "";
      updateFilterCheckboxes();
      filterArticles();
    }
    
    function updateActiveFiltersIndicator() {
      const container = document.getElementById('active-filters-container');
      container.innerHTML = '';
      
      selectedCategories.forEach(catId => {
        const category = data.categorias.find(c => c.id === catId);
        if (category) {
          const filterEl = document.createElement('div');
          filterEl.className = 'active-filter';
          filterEl.innerHTML = `${category.nombre} <button data-category-id="${catId}"><i class="fas fa-times"></i></button>`;
          filterEl.querySelector('button').addEventListener('click', () => {
            selectedCategories.delete(catId);
            updateFilterCheckboxes();
            filterArticles();
          });
          container.appendChild(filterEl);
        }
      });
      
      if (currentSearch) {
        const filterEl = document.createElement('div');
        filterEl.className = 'active-filter';
        filterEl.innerHTML = `Búsqueda: "${currentSearch}" <button data-search="true"><i class="fas fa-times"></i></button>`;
        filterEl.querySelector('button').addEventListener('click', () => {
          currentSearch = "";
          document.getElementById("search-input").value = "";
          filterArticles();
        });
        container.appendChild(filterEl);
      }
    }
    
    // UI Helper Functions
    function handleScroll() {
      const backToTopBtn = document.getElementById('back-to-top');
      if (window.scrollY > 300) {
        backToTopBtn.classList.add('show');
      } else {
        backToTopBtn.classList.remove('show');
      }
    }
    
    function scrollToTop() {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    }
    
    function updateBreadcrumbs(items) {
      const breadcrumbsContainer = document.getElementById('breadcrumbs');
      breadcrumbsContainer.innerHTML = '';
      
      const rootItem = document.createElement('span');
      rootItem.className = 'breadcrumb-item';
      rootItem.innerHTML = '<a href="#" class="hover:text-emerald-300">Ley 21.600</a>';
      rootItem.querySelector('a').addEventListener('click', (e) => {
        e.preventDefault();
        updateBreadcrumbs([{ name: 'Ley 21.600', active: true }]);
      });
      breadcrumbsContainer.appendChild(rootItem);
      
      items.forEach((item, index) => {
        const breadcrumbItem = document.createElement('span');
        breadcrumbItem.className = `breadcrumb-item ${item.active ? 'active' : ''}`;
        
        if (item.active) {
          breadcrumbItem.textContent = item.name;
        } else {
          breadcrumbItem.innerHTML = `<a href="#" class="hover:text-emerald-300">${item.name}</a>`;
          breadcrumbItem.querySelector('a').addEventListener('click', (e) => {
            e.preventDefault();
            const prevItems = items.slice(0, index + 1);
            prevItems[prevItems.length - 1].active = true;
            updateBreadcrumbs(prevItems);
          });
        }
        
        breadcrumbsContainer.appendChild(breadcrumbItem);
      });
    }
    
    // Tooltip Functions
    function setupDefinitionTooltips() {
      const tooltip = document.getElementById('definition-tooltip');
      const articlesContainer = document.getElementById('articles-container');
      const termElements = articlesContainer.querySelectorAll('.term-def, .term-def-alt');
      
      termElements.forEach(term => {
        term.removeEventListener('mouseenter', showDefinitionTooltip);
        term.removeEventListener('mouseleave', hideDefinitionTooltip);
      });
      
      termElements.forEach(term => {
        term.addEventListener('mouseenter', showDefinitionTooltip);
        term.addEventListener('mouseleave', hideDefinitionTooltip);
      });
    }
    
    function showDefinitionTooltip(e) {
      const termElement = e.target;
      let definition, tooltipTitle;
      
      if (termElement.classList.contains('term-def')) {
        const termId = termElement.dataset.termId;
        definition = data.definiciones.find(d => d.id == termId);
        tooltipTitle = "Definición";
      } else if (termElement.classList.contains('term-def-alt')) {
        const termId = termElement.dataset.termAltId;
        definition = data.definicionesAlt.find(d => d.id == termId);
        tooltipTitle = "Definición Alternativa";
      }
      
      if (definition) {
        const tooltip = document.getElementById('definition-tooltip');
        const termElementTooltip = document.getElementById('tooltip-term');
        const definitionElement = document.getElementById('tooltip-definition');
        
        termElementTooltip.textContent = definition.termino;
        definitionElement.textContent = definition.definicion;
        
        // Change tooltip style based on type
        if (termElement.classList.contains('term-def-alt')) {
          tooltip.classList.add('alt');
        } else {
          tooltip.classList.remove('alt');
        }
        
        const rect = termElement.getBoundingClientRect();
        const tooltipWidth = 320;
        const tooltipHeight = tooltip.offsetHeight;
        
        let left = rect.left + window.scrollX;
        if (left + tooltipWidth > window.innerWidth) {
          left = window.innerWidth - tooltipWidth - 20;
        }
        
        let top = rect.bottom + window.scrollY + 10;
        if (top + tooltipHeight > window.innerHeight + window.scrollY) {
          top = rect.top + window.scrollY - tooltipHeight - 10;
        }
        
        tooltip.style.left = `${left}px`;
        tooltip.style.top = `${top}px`;
        tooltip.classList.add('show');
      }
    }
    
    function hideDefinitionTooltip() {
      const tooltip = document.getElementById('definition-tooltip');
      tooltip.classList.remove('show', 'alt');
    }
    
    // Article Functions
    function showArticleSummary(articleId) {
      const article = data.articulos.find(a => a.id == articleId);
      const summaryData = articleSummaries[articleId];
      const modalContent = document.getElementById('modal-content');
      
      let summaryHTML = '';
      if (summaryData) {
        summaryHTML = `
          <div class="p-6">
            <div class="flex justify-between items-center mb-4">
              <h1 class="text-2xl font-bold text-indigo-600"><i class="fas fa-list-ul mr-2"></i>Resumen del Artículo ${article.numero}</h1>
              <button onclick="closeModal()" class="text-gray-500 hover:text-black dark:hover:text-white text-2xl" aria-label="Cerrar modal">&times;</button>
            </div>
            <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">${summaryData.title}</h2>
            <div class="prose dark:prose-invert max-w-none">${summaryData.summary}</div>
          </div>
        `;
      } else {
        summaryHTML = `
          <div class="p-6">
            <div class="flex justify-between items-center mb-4">
              <h1 class="text-2xl font-bold text-gray-500"><i class="fas fa-list-ul mr-2"></i>Resumen no disponible</h1>
              <button onclick="closeModal()" class="text-gray-500 hover:text-black dark:hover:text-white text-2xl" aria-label="Cerrar modal">&times;</button>
            </div>
            <p class="text-gray-600 dark:text-gray-400">Lo siento, aún no tengo un resumen preparado para el Artículo ${article.numero}.</p>
          </div>
        `;
      }
      
      modalContent.innerHTML = summaryHTML;
      document.getElementById('modal-overlay').classList.remove('hidden');
    }
    
    // Text Selection Functions
    function handleTextSelection() {
      const selection = window.getSelection();
      const selectedText = selection.toString().trim();
      
      if (selectedText.length > 10) {
        const range = selection.getRangeAt(0);
        const rect = range.getBoundingClientRect();
        showExplainerButton(rect);
      } else {
        hideExplainerButton();
      }
    }
    
    function hideExplainerButtonIfOutside(e) {
      const articlesContainer = document.getElementById('articles-container');
      if (!articlesContainer.contains(e.target)) {
        hideExplainerButton();
      }
    }
    
    function showExplainerButton(rect) {
      const button = document.getElementById('explainer-button');
      button.style.left = `${rect.left + window.scrollX - 45}px`;
      button.style.top = `${rect.top + window.scrollY - 45}px`;
      button.classList.remove('hidden');
      button.dataset.selectedText = window.getSelection().toString().trim();
    }
    
    function hideExplainerButton() {
      document.getElementById('explainer-button').classList.add('hidden');
    }
    
    function handleExplainRequest() {
      const button = document.getElementById('explainer-button');
      const selectedText = button.dataset.selectedText;
      hideExplainerButton();
      window.getSelection().removeAllRanges();
      showPlainLanguageExplanation(selectedText);
    }
    
    function showPlainLanguageExplanation(originalText) {
      const modalContent = document.getElementById('modal-content');
      const explanation = plainLanguageExplanations[originalText.toLowerCase()];
      
      let explanationHTML = '';
      if (explanation) {
        explanationHTML = `
          <div class="p-6">
            <div class="flex justify-between items-center mb-4">
              <h1 class="text-2xl font-bold text-amber-600"><i class="fas fa-lightbulb mr-2"></i>Explicación en Lenguaje Sencillo</h1>
              <button onclick="closeModal()" class="text-gray-500 hover:text-black dark:hover:text-white text-2xl" aria-label="Cerrar modal">&times;</button>
            </div>
            <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg mb-4">
              <p class="text-sm font-semibold text-gray-600 dark:text-gray-300 mb-1">Texto original seleccionado:</p>
              <p class="italic">"${originalText}"</p>
            </div>
            <div class="prose dark:prose-invert max-w-none">
              <p>${explanation}</p>
            </div>
          </div>
        `;
      } else {
        explanationHTML = `
          <div class="p-6">
            <div class="flex justify-between items-center mb-4">
              <h1 class="text-2xl font-bold text-gray-500"><i class="fas fa-lightbulb mr-2"></i>Explicación no disponible</h1>
              <button onclick="closeModal()" class="text-gray-500 hover:text-black dark:hover:text-white text-2xl" aria-label="Cerrar modal">&times;</button>
            </div>
            <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg mb-4">
              <p class="text-sm font-semibold text-gray-600 dark:text-gray-300 mb-1">Texto original seleccionado:</p>
              <p class="italic">"${originalText}"</p>
            </div>
            <p class="text-gray-600 dark:text-gray-400">Lo siento, aún no tengo una explicación preparada para este fragmento específico.</p>
          </div>
        `;
      }
      
      modalContent.innerHTML = explanationHTML;
      document.getElementById('modal-overlay').classList.remove('hidden');
    }
    
    // Modal Functions
    function openFocusMode(article) {
      let processedText = linkifyCrossReferences(article.texto_completo);
      processedText = formatListsInText(processedText);
      if (!processedText.includes('<ol>') && !processedText.includes('<ul>')) {
        processedText = formatListsAlternative(processedText);
      }
      processedText = highlightDefinedTerms(processedText);
      
      const modalContent = document.getElementById('modal-content');
      modalContent.innerHTML = `
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h1 class="text-3xl font-bold">Artículo ${article.numero}</h1>
            <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl" aria-label="Cerrar modal">&times;</button>
          </div>
          ${article.nombre ? `<h2 class="text-xl font-semibold mb-4">${article.nombre}</h2>` : ""}
          <div class="article-content leading-relaxed text-gray-300">${processedText}</div>
        </div>
      `;
      
      document.getElementById('modal-overlay').classList.remove('hidden');
      
      setTimeout(() => {
        setupDefinitionTooltips();
      }, 100);
    }
    
    function openNoteMode(article) {
      const modalContent = document.getElementById('modal-content');
      const currentNote = getNote(article.id);
      
      modalContent.innerHTML = `
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold">Anotación: Artículo ${article.numero}</h1>
            <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl" aria-label="Cerrar modal">&times;</button>
          </div>
          <textarea id="note-textarea" class="w-full h-64 p-3 border rounded-lg bg-gray-700 border-gray-600 text-white" placeholder="Escribe tu nota aquí...">${currentNote}</textarea>
          <div class="flex justify-end gap-2 mt-4">
            <button onclick="closeModal()" class="px-4 py-2 bg-gray-600 rounded-lg">Cancelar</button>
            <button onclick="saveNoteFromModal(${article.id})" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">Guardar Nota</button>
          </div>
        </div>
      `;
      
      document.getElementById('modal-overlay').classList.remove('hidden');
    }
    
    function saveNoteFromModal(articleId) {
      const noteText = document.getElementById('note-textarea').value;
      saveNote(articleId, noteText);
      closeModal();
      renderArticles();
    }
    
    function saveNote(articleId, noteText) {
      const notes = JSON.parse(localStorage.getItem('ley21600-notas') || '{}');
      if (noteText.trim()) {
        notes[articleId] = noteText;
      } else {
        delete notes[articleId];
      }
      localStorage.setItem('ley21600-notas', JSON.stringify(notes));
    }
    
    function getNote(articleId) {
      const notes = JSON.parse(localStorage.getItem('ley21600-notas') || '{}');
      return notes[articleId] || '';
    }
    
    function closeModal() {
      document.getElementById('modal-overlay').classList.add('hidden');
      document.getElementById('modal-content').innerHTML = '';
    }
    
    // Hash Navigation
    function handleHashNavigation() {
      const articleId = window.location.hash.substring(1);
      if (articleId.startsWith('articulo-')) {
        const targetElement = document.getElementById(articleId);
        if (targetElement) {
          setTimeout(() => {
            targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            targetElement.classList.add('ring-2', 'ring-emerald-500');
            setTimeout(() => targetElement.classList.remove('ring-2', 'ring-emerald-500'), 2000);
          }, 100);
        }
      }
    }
    
    window.addEventListener('hashchange', handleHashNavigation);
    
    // Export Functions
    function exportCurrentToPDF() {
      const element = document.querySelector("main");
      html2pdf().set({
        margin: 1,
        filename: 'Ley_21600_Resultados.pdf',
        html2canvas: { scale: 2 }
      }).from(element).save();
    }
    
    function exportArticleToPDF(art, el) {
      const clone = el.cloneNode(true);
      clone.querySelector(".export-article")?.remove();
      clone.querySelector(".focus-mode")?.remove();
      clone.querySelector(".add-note")?.remove();
      
      html2pdf().set({
        margin: 1,
        filename: `Articulo_${art.numero.replace(/[^\w]/g, '')}.pdf`
      }).from(clone).save();
    }
    
    // Utility Functions
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // Chatbot Functions
    const knowledgeBase = [
      {
        keywords: ["área protegida privada", "requisitos", "declarar", "cómo"],
        answer: "Para declarar un área como protegida privada, primero debes entender que se trata de un predio de tu propiedad que el Estado reconoce por su valor en conservación de ecosistemas. La ley establece el marco, pero el proceso detallado se regula en el Título III sobre instrumentos de conservación. El Servicio de Biodiversidad (SBAP) es la entidad encargada de gestionar y reconocer estas áreas.",
        citations: [
          { text: "Artículo 3°, definición 4", articleId: 3 },
          { text: "Artículo 23° (Instrumentos)", articleId: 6 },
          { text: "Artículo 4° (Creación del SBAP)", articleId: 4 }
        ]
      },
      {
        keywords: ["especie invasora", "introduzco", "planta", "animal", "qué pasa"],
        answer: "Introducir una especie exótica invasora es un tema muy serio. Si una especie se considera 'invasora', significa que amenaza los ecosistemas, hábitats o especies nativas. El Servicio de Biodiversidad (SBAP) tiene la facultad de elaborar y ejecutar planes de prevención, control y erradicación. Además, el Principio de Responsabilidad establece que quien cause daño a la biodiversidad será responsable de ello.",
        citations: [
          { text: "Artículo 3°, definición 15", articleId: 3 },
          { text: "Artículo 5° (Funciones SBAP)", articleId: 5 },
          { text: "Artículo 2° (Principio de Responsabilidad)", articleId: 9 }
        ]
      },
      {
        keywords: ["caza", "permiso", "quién fiscaliza", "autorización"],
        answer: "La autorización para la caza es una de las atribuciones del Servicio de Biodiversidad (SBAP). Esto significa que ellos son quienes autorizan, regulan y fiscalizan la actividad cinegética en el país, siempre en línea con los objetivos de conservación de la ley.",
        citations: [
          { text: "Artículo 5°, letra ñ)", articleId: 5 }
        ]
      },
      {
        keywords: ["objeto de la ley", "para qué sirve", "de qué trata"],
        answer: "El objeto principal de la Ley 21.600 es conservar la biodiversidad y el patrimonio natural de Chile. Lo hace a través de tres grandes estrategias: la preservación (dejar los ecosistemas intactos), la restauración (recuperar áreas dañadas) y el uso sustentable (aprovechar los recursos naturales sin agotarlos). Es importante notar que temas específicos como sanidad vegetal o incendios forestales tienen sus propias leyes.",
        citations: [
          { text: "Artículo 1°", articleId: 1 }
        ]
      }
    ];
    
    let conversationHistory = [];
    
    function setupChatbot() {
      const chatbotToggle = document.getElementById('chatbot-toggle');
      const chatbotModal = document.getElementById('chatbot-modal');
      const closeChatbot = document.getElementById('close-chatbot');
      const chatInput = document.getElementById('chat-input');
      const sendButton = document.getElementById('send-message');
      
      chatbotToggle.addEventListener('click', () => {
        chatbotModal.style.display = 'flex';
        chatbotToggle.style.display = 'none';
        chatInput.focus();
      });
      
      closeChatbot.addEventListener('click', () => {
        chatbotModal.style.display = 'none';
        chatbotToggle.style.display = 'flex';
      });
      
      sendButton.addEventListener('click', sendMessage);
      chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }
    
    async function sendMessage() {
      const chatInput = document.getElementById('chat-input');
      const userMessage = chatInput.value.trim();
      
      if (!userMessage) return;
      
      renderMessage('user', userMessage);
      chatInput.value = '';
      
      showTypingIndicator();
      
      // Simulate typing time
      setTimeout(async () => {
        try {
          const botResponse = await obtenerRespuesta(userMessage);
          hideTypingIndicator();
          renderMessage('bot', botResponse, "");
        } catch (error) {
          hideTypingIndicator();
          console.error('Error al obtener respuesta:', error);
          renderMessage('bot', 'Ocurrió un error al obtener la respuesta.', "");
        }
      }, 1000 + Math.random() * 1000);
    }
    
    function generateBotResponse(query) {
      const lowerQuery = query.toLowerCase();
      
      for (const entry of knowledgeBase) {
        if (entry.keywords.some(keyword => lowerQuery.includes(keyword))) {
          return {
            text: entry.answer,
            citations: entry.citations
          };
        }
      }
      
      return {
        text: "Lo siento, no tengo información específica sobre esa consulta en mi base de datos. Puedes intentar usar la barra de búsqueda o los filtros para explorar la ley, o preguntarme de otra forma.",
        citations: []
      };
    }
    
    function renderMessage(sender, text, citations = []) {
      const chatHistory = document.getElementById('chat-history');
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${sender}`;
      
      let citationsHtml = '';
      if (citations.length > 0) {
        citationsHtml = `
          <div class="mt-3 pt-3 border-t border-gray-300">
            <p class="text-xs font-semibold text-gray-500 mb-2">
              <i class="fas fa-link mr-1"></i>Fuentes:
            </p>
            <ul class="list-disc list-inside space-y-1">
              ${citations.map(cit => 
                `<li><a href="#articulo-${cit.articleId}" onclick="closeChatbotAndNavigate(${cit.articleId})" class="chat-citation-link">${cit.text}</a></li>`
              ).join('')}
            </ul>
          </div>
        `;
      }
      
      messageDiv.innerHTML = text + citationsHtml;
      chatHistory.appendChild(messageDiv);
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }
    
    function showTypingIndicator() {
      document.getElementById('typing-indicator').style.display = 'block';
      const chatHistory = document.getElementById('chat-history');
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }
    
    function hideTypingIndicator() {
      document.getElementById('typing-indicator').style.display = 'none';
    }
    
    function closeChatbotAndNavigate(articleId) {
      document.getElementById('chatbot-modal').style.display = 'none';
      document.getElementById('chatbot-toggle').style.display = 'flex';
      window.location.hash = `articulo-${articleId}`;
    }
    
    // Scenario Generator Functions
    const scenariosData = {
      "turismo": {
        title: "Turismo en un Sitio Prioritario",
        actor: "Operador de turismo",
        scenario: "Imagina que eres un operador turístico que quiere ofrecer excursiones de observación de aves en un 'Sitio Prioritario' para la conservación, designado por el SBAP. Tu plan incluye llevar grupos de 10 personas dos veces por semana. Para operar legalmente bajo la Ley 21.600, debes considerar lo siguiente: Primero, necesitas evaluar si tu actividad se enmarca en el 'Uso Sustentable' y no causará un impacto significativo. Debes coordinarte con el SBAP para obtener los permisos correspondientes, ya que operas en un área sensible. Es fundamental aplicar el 'Principio de Precaución', asegurándote de no perturbar las especies nidificantes. Además, tu operación debe alinearse con la definición de 'Turismo ambientalmente responsable', promoviendo la conservación y educando a tus clientes. Si, a pesar de tus precauciones, se causa un daño, el 'Principio de Responsabilidad' te haría pasible de repararlo.",
        keyPrinciples: [
          { name: "Uso Sustentable", articleId: 3, definitionId: 32 },
          { name: "Principio de Precaución", articleId: 2 },
          { name: "Principio de Responsabilidad", articleId: 9 },
          { name: "Turismo ambientalmente responsable", articleId: 3, definitionId: 34 }
        ],
        citations: [
          { text: "Artículo 1° (Objeto de la ley)", articleId: 1 },
          { text: "Artículo 3°, Definiciones", articleId: 3 },
          { text: "Artículo 5° (Funciones del SBAP)", articleId: 5 }
        ]
      },
      "investigacion": {
        title: "Investigación Científica en un Área Protegida",
        actor: "Investigador",
        scenario: "Eres un biólogo que busca realizar un estudio sobre la diversidad de anfibios en un Parque Nacional. Para ello, necesitas instalar equipos de monitoreo y recolectar muestras de agua y suelo. Según la Ley 21.600, la investigación científica es una actividad fomentada, pero está regulada. Debes presentar tu proyecto al Servicio de Biodiversidad (SBAP) para su evaluación y aprobación, asegurando que tu metodología no comprometa la 'Preservación' del área. El SBAP, en su función de promover redes de monitoreo, podría apoyar tu iniciativa. Sin embargo, debes seguir estrictamente los principios de 'Uso Sustentable' y 'Precaución' para minimizar tu impacto. Cualquier descubrimiento relevante, especialmente sobre especies en peligro, debe ser comunicado para alimentar los 'Planes de Recuperación' que el SBAP elabora.",
        keyPrinciples: [
          { name: "Preservación", articleId: 3, definitionId: 26 },
          { name: "Uso Sustentable", articleId: 3, definitionId: 32 },
          { name: "Principio de Precaución", articleId: 2 }
        ],
        citations: [
          { text: "Artículo 5°, letra c) y d)", articleId: 5 },
          { text: "Artículo 5°, letra e)", articleId: 5 },
          { text: "Artículo 3°, Definiciones", articleId: 3 }
        ]
      },
      "proyecto-inmobiliario": {
        title: "Proyecto Inmobiliario cerca de un Humedal",
        actor: "Desarrollador inmobiliario",
        scenario: "Una empresa inmobiliaria planea construir un complejo de departamentos en un terreno que colinda con un 'Humedal' urbano, reconocido por su importancia ecológica. Antes de iniciar cualquier obra, la Ley 21.600 obliga al desarrollador a realizar una evaluación de impacto. Se debe aplicar rigurosamente el 'Principio de Jerarquía': primero, se deben <strong>evitar</strong> los impactos (ej. rediseñar el proyecto para aumentar la distancia de construcción). Si no es posible, se deben <strong>mitigar</strong> (ej. crear barreras acústicas y visuales). Si el impacto ocurre, se debe <strong>reparar</strong> (ej. restaurar una zona degradada del humedal). Y como último recurso, <strong>compensar</strong> (ej. financiar la protección de otro humedal en la región). El SBAP tiene la facultad de pronunciarse sobre los impactos y fiscalizar el cumplimiento de estas medidas.",
        keyPrinciples: [
          { name: "Principio de Jerarquía", articleId: 2 },
          { name: "Humedal", articleId: 3, definitionId: 18 },
          { name: "Principio de Responsabilidad", articleId: 9 }
        ],
        citations: [
          { text: "Artículo 2°, Principio de Jerarquía", articleId: 2 },
          { text: "Artículo 3°, definición 18", articleId: 3 },
          { text: "Artículo 5°, letra i)", articleId: 5 }
        ]
      }
    };
    
    function setupScenarioGenerator() {
      const topicSelect = document.getElementById('scenario-topic');
      const generateBtn = document.getElementById('generate-scenario-btn');
      
      Object.keys(scenariosData).forEach(key => {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = scenariosData[key].title;
        topicSelect.appendChild(option);
      });
      
      topicSelect.addEventListener('change', () => {
        generateBtn.disabled = !topicSelect.value;
      });
      
      generateBtn.addEventListener('click', generateScenario);
    }
    
    function generateScenario() {
      const topicSelect = document.getElementById('scenario-topic');
      const selectedTopic = topicSelect.value;
      
      if (!selectedTopic) return;
      
      const scenarioData = scenariosData[selectedTopic];
      const modalContent = document.getElementById('modal-content');
      
      modalContent.innerHTML = `
        <div class="p-6 flex items-center justify-center h-64">
          <div class="text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-indigo-600 mb-4"></i>
            <p class="text-lg">Generando escenario práctico...</p>
          </div>
        </div>
      `;
      
      document.getElementById('modal-overlay').classList.remove('hidden');
      
      setTimeout(() => {
        displayScenarioModal(scenarioData);
      }, 1500);
    }
    
    function displayScenarioModal(scenario) {
      const modalContent = document.getElementById('modal-content');
      
      const principlesHtml = scenario.keyPrinciples.map(p => {
        const article = data.articulos.find(a => a.id === p.articleId);
        const definition = data.definiciones.find(d => d.articulo_id === p.articleId && d.numero === p.definitionId);
        let linkText = `Artículo ${article.numero}`;
        if (definition) {
          linkText += `, ${definition.numero}`;
        }
        return `<li><strong>${p.name}:</strong> Ver <a href="#articulo-${p.articleId}" class="text-indigo-600 hover:underline font-semibold">${linkText}</a>.</li>`;
      }).join('');
      
      const citationsHtml = scenario.citations.map(cit => 
        `<li><a href="#articulo-${cit.articleId}" class="text-indigo-600 hover:underline font-semibold">${cit.text}</a></li>`
      ).join('');
      
      modalContent.innerHTML = `
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold text-indigo-600"><i class="fas fa-magic mr-2"></i>${scenario.title}</h1>
            <button onclick="closeModal()" class="text-gray-500 hover:text-black dark:hover:text-white text-2xl" aria-label="Cerrar modal">&times;</button>
          </div>
          <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg mb-4">
            <p class="text-sm font-semibold text-gray-600 dark:text-gray-300 mb-1">Actor involucrado:</p>
            <p class="text-lg font-medium">${scenario.actor}</p>
          </div>
          <div class="prose dark:prose-invert max-w-none">
            <p>${scenario.scenario}</p>
          </div>
          <div class="mt-6 p-4 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg">
            <h3 class="text-lg font-semibold text-indigo-800 dark:text-indigo-300 mb-3">
              <i class="fas fa-lightbulb mr-2"></i>Principios y Definiciones Clave de la Ley
            </h3>
            <ul class="list-disc list-inside space-y-2 text-gray-700 dark:text-gray-300">
              ${principlesHtml}
            </ul>
          </div>
          <div class="mt-4">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">
              <i class="fas fa-book mr-2"></i>Artículos Relevantes para Consultar
            </h3>
            <ul class="list-disc list-inside space-y-1">
              ${citationsHtml}
            </ul>
          </div>
        </div>
      `;
    }
    
    // Proactive Detection Functions
    const proactiveDetectionRules = [
      {
        keywords: ["científico", "investigador", "monitorear", "investigación", "estudio", "especie", "humedal", "parque"],
        title: "Análisis para Investigación Científica",
        checklist: [
          "Evalúa si tu actividad se enmarca en el <strong>Uso Sustentable</strong> (Art. 3°, def. 32).",
          "Considera la definición de <strong>Hábitat</strong> para tu estudio (Art. 3°, def. 17).",
          "El Servicio de Biodiversidad (SBAP) promueve programas de investigación y redes de monitoreo (Art. 5°, c, d).",
          "Si tu investigación es en un área protegida, podrías necesitar autorizaciones del SBAP (Título III).",
          "Aplica el <strong>Principio de Precaución</strong> para evitar impactos no deseados (Art. 2°)."
        ],
        relevantArticles: [
          { text: "Artículo 3°, Definiciones", articleId: 3 },
          { text: "Artículo 5°, Funciones del SBAP", articleId: 5 },
          { text: "Artículo 2°, Principios", articleId: 2 }
        ]
      },
      {
        keywords: ["turismo", "operador", "excursión", "guía", "área protegida", "parque", "sitio prioritario"],
        title: "Análisis para Proyecto de Turismo",
        checklist: [
          "Tu actividad debe alinearse con la definición de <strong>Turismo ambientalmente responsable</strong> (Art. 3°, def. 34).",
          "Gestionar el <strong>Sistema Nacional de Áreas Protegidas</strong> es una función del SBAP (Art. 5°, b).",
          "Debes aplicar el <strong>Principio de Precaución</strong> para minimizar impactos en la fauna y flora (Art. 2°).",
          "Asegúrate de que tu operación no vulnere el <strong>Uso Sustentable</strong> del área (Art. 3°, def. 32).",
          "Recuerda el <strong>Principio de Responsabilidad</strong>: cualquier daño causado debe ser reparado (Art. 2°, g)."
        ],
        relevantArticles: [
          { text: "Artículo 3°, Definiciones", articleId: 3 },
          { text: "Artículo 5°, Funciones del SBAP", articleId: 5 },
          { text: "Artículo 2°, Principios", articleId: 2 }
        ]
      },
      {
        keywords: ["construir", "inmobiliaria", "proyecto", "edificio", "urbanismo", "humedal", "río", "cerro"],
        title: "Análisis para Proyecto Inmobiliario o de Construcción",
        checklist: [
          "Debes aplicar rigurosamente el <strong>Principio de Jerarquía</strong> (Art. 2°, b): Evitar, Mitigar, Reparar, Compensar.",
          "El SBAP debe pronunciarse sobre los impactos de tu proyecto (Art. 5°, i).",
          "Si tu proyecto afecta un <strong>Hábitat</strong> o <strong>Humedal</strong>, las restricciones son mayores (Art. 3°, defs. 17, 18).",
          "El <strong>Principio de Responsabilidad</strong> te hace pasible de reparar cualquier daño (Art. 2°, g).",
          "Evalúa si tu proyecto podría requerir un <strong>Plan de Restauración</strong> como medida de compensación."
        ],
        relevantArticles: [
          { text: "Artículo 2°, Principio de Jerarquía", articleId: 2 },
          { text: "Artículo 5°, Funciones del SBAP", articleId: 5 },
          { text: "Artículo 3°, Definiciones", articleId: 3 }
        ]
      },
      {
        keywords: ["municipio", "municipalidad", "paisaje de conservación", "conservar", "área verde", "corredor biológico"],
        title: "Análisis para Iniciativa de Conservación Local",
        checklist: [
          "Considera crear un <strong>Área Silvestre Protegida Privada</strong> si tienes terrenos propios (Art. 3°, def. 4).",
          "El SBAP puede <strong>apoyar técnicamente</strong> tu iniciativa (Art. 5°, f).",
          "Explora los <strong>Instrumentos de Conservación</strong> del Título III de la ley (Art. 23°).",
          "Podrías postular al <strong>Fondo Nacional de la Biodiversidad</strong> para financiar tu proyecto (Art. 5°, j).",
          "Fomenta la <strong>participación ciudadana</strong> en tu iniciativa, como lo establece el Principio Participatorio (Art. 2°, d)."
        ],
        relevantArticles: [
          { text: "Artículo 3°, Definiciones", articleId: 3 },
          { text: "Artículo 5°, Funciones del SBAP", articleId: 5 },
          { text: "Artículo 23°, Instrumentos de Conservación", articleId: 6 },
          { text: "Artículo 2°, Principios", articleId: 2 }
        ]
      }
    ];
    
    function setupProactiveDetection() {
      const analyzeBtn = document.getElementById('analyze-proactive-btn');
      analyzeBtn.addEventListener('click', analyzeUserInput);
    }
    
    async function analyzeUserInput() {
      const input = document.getElementById('proactive-input').value.trim();
      
      if (!input) return;
      
      const modalContent = document.getElementById('modal-content');
      
      modalContent.innerHTML = `
        <div class="p-6 flex items-center justify-center h-64">
          <div class="text-center">
            <i class="fas fa-brain fa-pulse text-4xl text-purple-600 mb-4"></i>
            <p class="text-lg">Analizando tu situación...</p>
            <p class="text-sm text-gray-400 mt-2">Esto puede tardar unos momentos mientras consultamos la base de datos legal</p>
          </div>
        </div>
      `;
      
      document.getElementById('modal-overlay').classList.remove('hidden');
      
      try {
        // Try to get response from API
        const apiResponse = await obtenerRespuestaLey(input);
        displayApiAnalysisModal(apiResponse, input);
      } catch (error) {
        console.error('Error al obtener respuesta de la API:', error);
        // If API fails, use predefined rules
        const matchedRule = findMatchingRule(input);
        displayProactiveAnalysisModal({ rule: matchedRule });
      }
    }
    
    function findMatchingRule(userText) {
      const lowerText = userText.toLowerCase();
      
      for (const rule of proactiveDetectionRules) {
        if (rule.keywords.some(keyword => lowerText.includes(keyword))) {
          return rule;
        }
      }
      
      return null;
    }
    
    function displayApiAnalysisModal(apiResponse, userQuery) {
      const modalContent = document.getElementById('modal-content');
      
      // Convert markdown to HTML using marked.js
      const htmlContent = marked.parse(apiResponse);
      
      modalContent.innerHTML = `
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold text-purple-600"><i class="fas fa-clipboard-check mr-2"></i>Análisis Basado en la Ley</h1>
            <button onclick="closeModal()" class="text-gray-500 hover:text-black dark:hover:text-white text-2xl" aria-label="Cerrar modal">&times;</button>
          </div>
          <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg mb-4">
            <p class="text-sm font-semibold text-gray-600 dark:text-gray-300 mb-1">Tu consulta:</p>
            <p class="italic">"${userQuery}"</p>
          </div>
          <div class="api-response-container">
            ${htmlContent}
          </div>
          <div class="mt-4 text-center">
            <button onclick="closeModal()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
              Cerrar Análisis
            </button>
          </div>
        </div>
      `;
    }
    
    function displayProactiveAnalysisModal(data) {
      const modalContent = document.getElementById('modal-content');
      
      if (data.rule) {
        const rule = data.rule;
        const checklistHtml = rule.checklist.map(item => `<li class="mb-2">${item}</li>`).join('');
        const articlesHtml = rule.relevantArticles.map(cit => 
          `<li><a href="#articulo-${cit.articleId}" class="text-purple-600 hover:underline font-semibold">${cit.text}</a></li>`
        ).join('');
        
        modalContent.innerHTML = `
          <div class="p-6">
            <div class="flex justify-between items-center mb-4">
              <h1 class="text-2xl font-bold text-purple-600"><i class="fas fa-clipboard-check mr-2"></i>${rule.title}</h1>
              <button onclick="closeModal()" class="text-gray-500 hover:text-black dark:hover:text-white text-2xl" aria-label="Cerrar modal">&times;</button>
            </div>
            <div class="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg mb-4">
              <h3 class="text-lg font-semibold text-purple-800 dark:text-purple-300 mb-3">
                <i class="fas fa-list-check mr-2"></i>Lista de Verificación de Obligaciones y Derechos
              </h3>
              <ul class="list-disc list-inside space-y-2 text-gray-700 dark:text-gray-300">
                ${checklistHtml}
              </ul>
            </div>
            <div class="mt-4">
              <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">
                <i class="fas fa-book mr-2"></i>Artículos Relevantes para Consultar
              </h3>
              <ul class="list-disc list-inside space-y-1">
                ${articlesHtml}
              </ul>
            </div>
          </div>
        `;
      } else {
        modalContent.innerHTML = `
          <div class="p-6 text-center">
            <h1 class="text-2xl font-bold text-gray-500 mb-4"><i class="fas fa-exclamation-triangle mr-2"></i>No se encontró una coincidencia</h1>
            <p class="text-gray-600 dark:text-gray-400">No pude identificar una situación específica en tu descripción. Intenta usar palabras clave como 'investigación', 'turismo', 'construir' o 'municipio'.</p>
            <button onclick="closeModal()" class="mt-4 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">Cerrar</button>
          </div>
        `;
      }
    }
    
    // Initialize the app when DOM is loaded
    document.addEventListener("DOMContentLoaded", initializeApp);
  </script>
</body>
</html>